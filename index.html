<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام ارتقاء | Irteqaa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&family=Tajawal:wght@400;500;700;800&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { 
            --primary: #1e4078; 
            --primary-dark: #163260;
            --accent: #dcae1d;
            --text: #333; 
            --bg: #f4f7fa; 
            --danger: #da291c; 
            --success: #28a745; 
            --warning: #ffc107; 
            --disabled: #e9ecef; 
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* === Layout === */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; box-shadow: -2px 0 15px rgba(0,0,0,0.03); }
        
        /* === UPDATED LOGO STYLE (Professional & Minimal) === */
        .sidebar-header { 
            padding: 30px 20px; 
            border-bottom: 1px solid #f0f4f8; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            justify-content: center;
        }
        .logo-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            line-height: 1;
        }
        .logo-ar {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            font-family: 'Tajawal', sans-serif;
            letter-spacing: -0.5px;
        }
        .logo-en {
            font-size: 0.8rem;
            font-weight: 500;
            color: #888;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 2px;
            margin-top: 4px;
            text-transform: uppercase;
        }
        .sidebar-icon {
            font-size: 2.4rem;
            color: var(--primary);
        }

        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: block; } 
        #nav-system-admin { display: none; }
        
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #666; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f7ff; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 12px; width: 25px; text-align: center; font-size: 1.1rem; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* User Profile Header */
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: var(--shadow); border: 1px solid #eee; }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* === REDESIGNED LOGIN PAGE (Modern, Professional, Smooth) === */
        .login-wrapper { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; 
            background: linear-gradient(135deg, #1e4078 0%, #0d1b33 100%); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 9999; 
            background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .login-box { 
            background: rgba(255, 255, 255, 0.98); 
            padding: 50px 45px; 
            border-radius: 24px; 
            width: 440px; 
            text-align: center; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
            position: relative;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .login-logo-container { 
            margin-bottom: 35px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 10px;
        }
        .login-logo-icon { 
            font-size: 3.5rem; 
            color: var(--primary); 
            margin-bottom: 5px; 
        }
        .login-brand-group {
            line-height: 1;
        }
        .login-brand-ar { 
            font-size: 2.4rem; 
            font-weight: 800; 
            color: var(--primary); 
            font-family: 'Tajawal', sans-serif; 
        }
        .login-brand-en { 
            font-size: 1rem; 
            font-weight: 500; 
            color: #666; 
            font-family: 'Poppins', sans-serif; 
            letter-spacing: 3px; 
            margin-top: 5px; 
            text-transform: uppercase;
        }
        
        .login-divider {
            height: 4px;
            width: 50px;
            background: var(--accent);
            border-radius: 2px;
            margin: 0 auto 35px auto;
        }

        .input-group-modern { position: relative; margin-bottom: 25px; text-align: right; }
        .input-group-modern i { 
            position: absolute; 
            right: 18px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #b0b0b0; 
            transition: 0.3s; 
            z-index: 2; 
            font-size: 1.1rem;
        }
        .input-group-modern .form-control { 
            padding: 16px 50px 16px 15px; 
            border-radius: 12px; 
            border: 2px solid #eef2f7; 
            background: #f8fafc;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            color: #333;
            font-weight: 600;
        }
        .input-group-modern .form-control::placeholder { color: #aaa; font-weight: normal; }
        .input-group-modern .form-control:focus { 
            border-color: var(--primary); 
            background: #fff; 
            box-shadow: 0 4px 15px rgba(30, 64, 120, 0.08); 
            outline: none; 
        }
        .input-group-modern .form-control:focus + i { color: var(--primary); }
        
        .btn-login { 
            background: linear-gradient(135deg, var(--primary) 0%, #29539b 100%); 
            color: white; 
            width: 100%; 
            padding: 16px; 
            border-radius: 12px; 
            font-size: 1.15rem; 
            font-weight: 700;
            margin-top: 15px; 
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(30, 64, 120, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-login:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 15px 35px rgba(30, 64, 120, 0.35); 
            background: linear-gradient(135deg, #244c8a 0%, #1e4078 100%);
        }
        .login-error-msg {
            background-color: #fff2f2; 
            color: #d63031; 
            border: 1px solid #ffdede; 
            padding: 15px; 
            border-radius: 10px; 
            margin-top: 25px; 
            font-size: 0.9rem; 
            line-height: 1.6; 
            display: none; 
            text-align: center;
            font-weight: 600;
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        /* General Forms */
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        .form-control:disabled { background-color: var(--disabled); cursor: not-allowed; color: #666; }
        textarea.form-control { resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        
        /* Content Sections */
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: var(--shadow); }
        .section-card.active { display: block; }

        /* Dashboard Specific Styles */
        .dashboard-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.04); border: 1px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; overflow: hidden; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .stat-card.blue { border-bottom: 4px solid var(--primary); }
        .stat-card.green { border-bottom: 4px solid var(--success); }
        .stat-card.red { border-bottom: 4px solid var(--danger); }
        .stat-card.orange { border-bottom: 4px solid var(--warning); }
        .stat-card.purple { border-bottom: 4px solid #6f42c1; }
        
        .stat-info h3 { font-size: 2rem; margin: 10px 0 5px 0; font-weight: 700; color: #333; }
        .stat-info p { margin: 0; font-size: 0.9rem; color: #777; font-weight: 600; }
        .stat-icon-bg { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 10px; }
        .bg-light-blue { background: #eef4ff; color: var(--primary); }
        .bg-light-green { background: #e8f7ec; color: var(--success); }
        .bg-light-red { background: #fdeaea; color: var(--danger); }
        .bg-light-orange { background: #fff8e1; color: var(--warning); }
        .bg-light-purple { background: #f2e6ff; color: #6f42c1; }

        .dashboard-charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 992px) { .dashboard-charts-row { grid-template-columns: 1fr; } }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.04); overflow: hidden; }
        .chart-title { font-weight: bold; margin-bottom: 20px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; }

        /* General Tables & Tabs */
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab:hover { background-color: #f9f9f9; color: var(--primary); }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .custom-table td { padding: 8px; border-bottom: 1px solid #eee; background: white; text-align: center; vertical-align: middle; }
        
        .reason-cell { white-space: pre-wrap; text-align: right; line-height: 1.6; min-width: 250px; }
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; }

        /* Status Badge */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; min-width: 60px;}
        .status-active { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-inactive { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .role-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; background: #e2e3e5; color: #383d41; }
        .role-admin { background: #d1ecf1; color: #0c5460; }
        .role-super { background: #fff3cd; color: #856404; }

        /* Action Buttons */
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; margin: 2px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-perm { background: #343a40; }
        .btn-toggle { background: #28a745; }
        .btn-toggle.off { background: #6c757d; }
        .btn-move { background: #6c757d; padding: 6px 8px; } 
        .btn-reset { background: #fd7e14; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Filters */
        .filter-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .filter-label { font-weight: bold; color: #555; }
        .filter-select { padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; min-width: 150px; font-weight: bold; color: var(--primary); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Report Specific Styles */
        .report-preview-container {
            background: #525659;
            padding: 30px;
            overflow: auto;
            max-height: 800px;
            display: flex;
            justify-content: center;
        }
        .a4-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            position: relative;
            color: black;
            font-family: 'Cairo', sans-serif;
            page-break-after: always;
        }
        .a4-page:last-child { page-break-after: auto; }
        
        .report-table-custom { width:100%; border-collapse:collapse; margin-bottom:20px; font-size:14px; page-break-inside: avoid; }
        .report-table-custom th, .report-table-custom td { border:1px solid black; padding:8px; text-align:center; vertical-align:middle; }
        .report-table-custom th { background-color:#bfbfbf; font-weight:bold; }
        .align-right { text-align: right !important; }
        .bold-col { font-weight:bold; }
        .report-header-box { background-color: #000; color: #fff; padding: 10px; text-align: center; font-weight: bold; }
        .report-sub-header { background-color: #bfbfbf; padding: 8px; font-weight: bold; border: 1px solid #000; text-align: center; }
        .report-row-summary { background-color: #bfbfbf; font-weight: bold; }
        .report-row-total { background-color: #b4c6e7; font-weight: bold; }
        .report-list { text-align: right; padding-right: 20px; margin: 0; }
        .report-list li { margin-bottom: 5px; }

        .saved-report-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 8px; background: #fff; }
        .saved-report-info h4 { margin: 0 0 5px 0; color: var(--primary); }
        .saved-report-info small { color: #777; }

        @media print {
            body * { visibility: hidden; }
            .a4-page, .a4-page * { visibility: visible; }
            .a4-page { position: relative; left: 0; top: 0; margin: 0; padding: 0; width: 100%; box-shadow: none; height: auto; margin-bottom: 0; }
            .sidebar, .top-header, .filter-container, .btn, .custom-tabs, .report-preview-container { display: none !important; }
            .report-preview-container { display: block !important; background: white !important; padding: 0 !important; overflow: visible !important; max-height: none !important; }
            #a4-report-content { display: block !important; }
        }

        /* Settings Specific */
        .setting-content-pane { display: none; animation: fadeIn 0.3s; }
        .setting-content-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .upload-container { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #fcfcfc; margin-bottom: 20px; position: relative; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .upload-container:hover { border-color: var(--primary); background-color: #f0f4f8; }
        .upload-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; width: 100%; text-align: right; }
        .upload-btn-wrapper { margin-top: 10px; text-align: center; }
        .upload-btn-custom { background-color: #28a745; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; }
        .upload-hint { display: block; margin-top: 8px; font-size: 0.8rem; color: #888; font-weight: bold; }
        .image-preview-wrapper { margin-top: 15px; position: relative; display: inline-block; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .image-preview { max-width: 200px; max-height: 100px; display: block; cursor: pointer; }
        .remove-img-btn { position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .signature-grid { display: flex; flex-direction: column; gap: 20px; }
        .signature-card { border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #fcfcfc; text-align: center; width: 100%; }
        .signature-title { color: var(--primary); font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
        .visitor-section { margin-bottom: 30px; border: 1px solid #eee; padding: 20px; border-radius: 8px; background: white; }
        .visitor-section-title { font-weight: bold; margin-bottom: 15px; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .visitor-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .visitor-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 6px; background: #fff; transition: 0.2s; }
        .log-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .picker-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .picker-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .picker-item:hover { background-color: #f0f4f8; }
        .password-wrapper { position: relative; }
        .password-wrapper input { padding-left: 40px; }
        .password-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #777; }
        .perm-list { border: 1px solid #eee; border-radius: 6px; padding: 10px; max-height: 300px; overflow-y: auto; }
        .perm-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .perm-header { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }
        
        /* User View */
        .user-view-card { text-align: center; margin-bottom: 20px; }
        .user-view-avatar { width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px auto; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: right; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .info-item label { display: block; color: #777; font-size: 0.85rem; margin-bottom: 5px; }
        .info-item span { font-weight: bold; color: #333; }
        .view-footer-info { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.8rem; color: #777; display: flex; justify-content: space-between; background: #fafafa; padding: 10px; border-radius: 5px; }

        /* BRAND SWITCHER STYLES */
        .brand-switcher-container { margin-left: 15px; position: relative; }
        .brand-btn { background: #f0f4f8; color: var(--primary); border: 1px solid #ddd; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; min-width: 180px; justify-content: space-between; }
        .brand-btn:hover { background: #e2e6ea; }
        .brand-dropdown { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; min-width: 220px; z-index: 1000; display: none; margin-top: 5px; }
        .brand-dropdown.show { display: block; animation: fadeIn 0.2s; }
        .brand-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .brand-item:last-child { border-bottom: none; }
        .brand-item:hover { background: #f8f9fa; color: var(--primary); }
        .brand-item.active { background: #eef4ff; color: var(--primary); font-weight: bold; border-right: 3px solid var(--primary); }
        .brand-icon { width: 24px; height: 24px; background: #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #555; }
        .brand-label { font-size: 0.9rem; }

    </style>
</head>
<body>

    <canvas id="tempChartCanvas" width="600" height="300" style="display:none;"></canvas>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <div class="login-logo-container">
                <i class="fas fa-graduation-cap login-logo-icon"></i>
                <div class="login-brand-group">
                    <div class="login-brand-ar">ارتقاء</div>
                    <div class="login-brand-en">Irteqaa</div>
                </div>
            </div>
            
            <div class="login-divider"></div>

            <form id="loginForm" onsubmit="login(event)">
                <div class="input-group-modern">
                    <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                    <i class="fas fa-user"></i>
                </div>
                
                <div class="input-group-modern">
                    <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required>
                    <i class="fas fa-eye password-icon" style="cursor: pointer;" onclick="togglePass('loginPass', this)"></i>
                </div>

                <button type="submit" class="btn btn-login">تسجيل الدخول</button>
                <div id="loginError" class="login-error-msg"></div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap sidebar-icon"></i>
                <div class="logo-group">
                    <span class="logo-ar">ارتقاء</span>
                    <span class="logo-en">Irteqaa</span>
                </div>
            </div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-distinguished"><a onclick="navigate('distinguished')" data-page="distinguished"><i class="fas fa-star"></i> المعلمين المتميزين</a></li>
                <li id="nav-qualitative"><a onclick="navigate('qualitative')" data-page="qualitative"><i class="fas fa-file-alt"></i> التقرير النوعي</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير جودة التعليم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-system-admin"><a onclick="navigate('system-admin')" data-page="system-admin"><i class="fas fa-shield-alt"></i> إعدادات مدير النظام</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div style="display:flex; align-items:center;">
                    <h2 id="pageTitle" style="margin-left:20px;">...</h2>
                    <div class="brand-switcher-container">
                        <button class="brand-btn" onclick="toggleBrandDropdown()">
                            <span id="currentBrandLabel">الجهة الافتراضية</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="brandDropdown" class="brand-dropdown">
                            </div>
                    </div>
                </div>
                <div class="user-profile">
                    <div class="user-info-text">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserJob" class="user-job">الوظيفة</span>
                    </div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active">
                <div class="filter-container" style="justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label class="filter-label"><i class="fas fa-calendar-alt"></i> تصفية البيانات حسب الشهر:</label>
                        <select id="dashMonthFilter" class="filter-select" onchange="renderDashboard()">
                            <option value="all">كل الأشهر</option>
                            <option value="01">يناير</option>
                            <option value="02">فبراير</option>
                            <option value="03">مارس</option>
                            <option value="04">أبريل</option>
                            <option value="05">مايو</option>
                            <option value="06">يونيو</option>
                            <option value="07">يوليو</option>
                            <option value="08">أغسطس</option>
                            <option value="09">سبتمبر</option>
                            <option value="10">أكتوبر</option>
                            <option value="11">نوفمبر</option>
                            <option value="12">ديسمبر</option>
                        </select>
                    </div>
                </div>

                <div class="dashboard-stats-grid">
                     <div class="stat-card blue">
                        <div class="stat-info">
                            <h3 id="stat_total">0</h3>
                            <p>إجمالي الزيارات الصفية</p>
                        </div>
                         <div class="stat-icon-bg bg-light-blue"><i class="fas fa-clipboard-check"></i></div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-info">
                            <h3 id="stat_exceeds_lot">0</h3>
                            <p>يتجاوز التوقعات بكثير</p>
                        </div>
                         <div class="stat-icon-bg bg-light-purple"><i class="fas fa-star"></i></div>
                    </div>
                     <div class="stat-card green">
                        <div class="stat-info">
                            <h3 id="stat_exceeds">0</h3>
                            <p>يتجاوز التوقعات</p>
                        </div>
                         <div class="stat-icon-bg bg-light-green"><i class="fas fa-check-double"></i></div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-info">
                            <h3 id="stat_meets">0</h3>
                            <p>يفي بالتوقعات</p>
                        </div>
                         <div class="stat-icon-bg bg-light-orange"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-info">
                            <h3 id="stat_partially">0</h3>
                            <p>يفي بالتوقعات جزئيا</p>
                        </div>
                         <div class="stat-icon-bg bg-light-red"><i class="fas fa-exclamation"></i></div>
                    </div>
                </div>

                <div class="dashboard-charts-row">
                    <div class="chart-box">
                        <div class="chart-title">
                            <span>توزيع الزيارات حسب الأقسام</span>
                            <i class="fas fa-chart-bar" style="color:#aaa;"></i>
                        </div>
                        <div style="position: relative; height: 250px; width: 100%;">
                            <canvas id="dashBarChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title">
                            <span>نسب التقييم</span>
                            <i class="fas fa-chart-pie" style="color:#aaa;"></i>
                        </div>
                        <div style="position: relative; height: 250px; width: 100%;">
                            <canvas id="dashPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">سجل الزيارات الصفية</h3>
                    <div style="display:flex; gap:10px;">
                        <button id="btnAddVisit" class="btn btn-primary btn-restricted" style="width:auto;" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة جديدة</button>
                        <button class="btn admin-only-btn" style="background:#17a2b8; color:white; display:none;" onclick="exportSpecificExcel('visits')"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
                        <button class="btn admin-only-btn" style="background:#28a745; color:white; display:none;" onclick="triggerImportExcelGeneric('visits')"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
                    </div>
                </div>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="visitMonthFilter" class="filter-select" onchange="renderVisitsTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">زيارات القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">زيارات القيادة الوسطى</div>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="15%">التاريخ</th>
                            <th width="15%">القسم</th>
                            <th width="20%">اسم المعلمة</th>
                            <th width="15%">التقييم</th>
                            <th width="15%">الزائر</th>
                            <th width="10%">الوظيفة</th>
                            <th width="10%">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTableBody"></tbody>
                </table>
            </div>

            <div id="performance" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">تقييم الأداء الصفي</h3>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> اختر الشهر:</label>
                    <select id="perfMonthFilter" class="filter-select" onchange="renderPerformanceChart()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <div style="padding:20px; background:#fff; border:1px solid #eee; border-radius:8px;">
                    <canvas id="perfChart" width="400" height="150"></canvas>
                </div>
            </div>

            <div id="distinguished" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">المعلمين المتميزين والأولى بالرعاية</h3>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="distMonthFilter" class="filter-select" onchange="renderDistinguishedTables()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <div class="admin-only-btn" style="display:none; margin-bottom:20px;">
                    <button class="btn" style="background:#2c5aa0; color:white; width:auto;" onclick="openDistinguishedModal('distinguished')"><i class="fas fa-plus-circle"></i> إضافة معلم متميز</button>
                    <button class="btn" style="background:#da291c; color:white; width:auto;" onclick="openDistinguishedModal('care')"><i class="fas fa-plus-circle"></i> إضافة معلم يحتاج رعاية</button>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="table-section-title">المعلمين المتميزين</div>
                    <div class="admin-only-btn" style="display:none;">
                         <button class="btn btn-sm" style="background:#17a2b8; color:white; width:auto; padding:5px 10px;" onclick="exportSpecificExcel('distinguished')"><i class="fas fa-file-excel"></i> تصدير</button>
                         <button class="btn btn-sm" style="background:#28a745; color:white; width:auto; padding:5px 10px;" onclick="triggerImportExcelGeneric('distinguished')"><i class="fas fa-file-excel"></i> استيراد</button>
                    </div>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr id="distHeadRow">
                            <th width="5%">#</th>
                            <th width="15%">التاريخ</th>
                            <th width="20%">اسم المعلم/ة</th>
                            <th width="15%">القسم</th>
                            <th width="10%">التقدير</th>
                            <th width="25%">المبررات</th>
                            <th width="10%">المصدر</th>
                        </tr>
                    </thead>
                    <tbody id="distinguishedTableBody"></tbody>
                </table>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:40px;">
                    <div class="table-section-title">المعلمين الأولى بالرعاية</div>
                    <div class="admin-only-btn" style="display:none;">
                         <button class="btn btn-sm" style="background:#17a2b8; color:white; width:auto; padding:5px 10px;" onclick="exportSpecificExcel('care')"><i class="fas fa-file-excel"></i> تصدير</button>
                         <button class="btn btn-sm" style="background:#28a745; color:white; width:auto; padding:5px 10px;" onclick="triggerImportExcelGeneric('care')"><i class="fas fa-file-excel"></i> استيراد</button>
                    </div>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr id="careHeadRow">
                            <th width="5%">#</th>
                            <th width="15%">التاريخ</th>
                            <th width="20%">اسم المعلم/ة</th>
                            <th width="15%">القسم</th>
                            <th width="10%">التقدير</th>
                            <th width="25%">المبررات</th>
                            <th width="10%">المصدر</th>
                        </tr>
                    </thead>
                    <tbody id="careTableBody"></tbody>
                </table>
            </div>

            <div id="qualitative" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">التقرير النوعي</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary btn-restricted" style="width:auto;" onclick="openQualitativeModal()"><i class="fas fa-plus"></i> إضافة تقرير</button>
                        <button class="btn admin-only-btn" style="background:#17a2b8; color:white; display:none;" onclick="exportSpecificExcel('qualitative')"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
                        <button class="btn admin-only-btn" style="background:#28a745; color:white; display:none;" onclick="triggerImportExcelGeneric('qualitative')"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
                    </div>
                </div>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-filter"></i> تصفية حسب الشهر:</label>
                    <select id="qualMonthFilter" class="filter-select" onchange="renderQualitativeTable()">
                        <option value="all">كل الأشهر</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="15%">التاريخ</th>
                            <th width="15%">الأقسام الأكاديمية</th>
                            <th width="25%">جوانب القوة</th>
                            <th width="25%">جوانب بحاجة إلى تطوير</th>
                            <th width="15%" class="col-actions">الإجراء</th>
                        </tr>
                    </thead>
                    <tbody id="qualitativeTableBody"></tbody>
                </table>
            </div>

            <div id="quality-report" class="section-card">
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setReportTab('create', this)">إنشاء تقرير</div>
                    <div class="custom-tab" onclick="setReportTab('saved', this)">سجل التقارير المحفوظة</div>
                </div>

                <div id="report-create-pane">
                    <div class="filter-container" style="justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label class="filter-label">شهر التقرير:</label>
                            <select id="reportMonthSelect" class="filter-select">
                                <option value="01">يناير</option>
                                <option value="02">فبراير</option>
                                <option value="03">مارس</option>
                                <option value="04">أبريل</option>
                                <option value="05">مايو</option>
                                <option value="06">يونيو</option>
                                <option value="07">يوليو</option>
                                <option value="08">أغسطس</option>
                                <option value="09">سبتمبر</option>
                                <option value="10">أكتوبر</option>
                                <option value="11">نوفمبر</option>
                                <option value="12">ديسمبر</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateQualityReport()"> إصدار التقرير</button>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-view" onclick="printReport()"><i class="fas fa-print"></i> طباعة</button>
                            <button class="btn btn-edit" onclick="exportToWord()"><i class="fas fa-file-word"></i> تصدير Word</button>
                            <button class="btn btn-toggle" onclick="saveReport()"><i class="fas fa-save"></i> حفظ</button>
                        </div>
                    </div>

                    <div class="report-preview-container">
                        <div id="a4-report-content">
                            <div class="a4-page">
                                <div style="text-align:center; padding:50px; color:#888;">
                                    <i class="fas fa-file-alt" style="font-size:3rem; margin-bottom:15px; display:block;"></i>
                                    يرجى اختيار الشهر والضغط على "إصدار التقرير"
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="report-saved-pane" style="display:none;">
                    <div id="savedReportsList"></div>
                </div>
            </div>

            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    <div id="userActionButtons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="addBtnMain" class="btn" style="background:#2c5aa0; color:white;" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportExcel()"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
                        <button class="btn" style="background:#28a745; color:white;" onclick="triggerImportExcel()"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="toggleStatusSelected()"><i class="fas fa-toggle-on"></i> تفعيل/إلغاء المحدد</button>
                        <button id="bulkPermBtn" class="btn" style="background:#343a40; color:white;" onclick="openBulkPerms()"><i class="fas fa-key"></i> صلاحيات المحدد</button>
                        <input type="file" id="importExcelInput" hidden accept=".xlsx, .xls, .csv" onchange="handleExcelImport(this)">
                         <input type="file" id="importExcelGenericInput" hidden accept=".xlsx, .xls, .csv" onchange="handleExcelImportGeneric(this)">
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط)</div>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr id="tableHeadRow"></tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
            
            <div id="system-admin" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">إعدادات مدير النظام (إدارة البراندات)</h3>
                    <button class="btn btn-primary" style="width:auto;" onclick="openBrandModal()"><i class="fas fa-plus"></i> إضافة براند جديد</button>
                </div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="30%">اسم البراند (الجهة)</th>
                            <th width="20%">البريد الإلكتروني</th>
                            <th width="15%">مدة الصلاحية</th>
                            <th width="10%">الحالة</th>
                            <th width="20%">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="brandsTableBody">
                        </tbody>
                </table>
            </div>

            <div id="settings" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">الإعدادات</h3>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setSettingTab('gen', this)">الإعدادات العامة</div>
                    <div class="custom-tab" onclick="setSettingTab('sig', this)">إعدادات التوقيعات</div>
                    <div class="custom-tab" onclick="setSettingTab('fot', this)">إعدادات التذييل</div>
                    <div class="custom-tab" onclick="setSettingTab('eval', this)">إعدادات التقييم</div>
                    <div class="custom-tab" onclick="setSettingTab('vis', this)">ترتيب الزوار</div>
                    <div class="custom-tab" onclick="setSettingTab('log', this)">سجل النظام</div>
                </div>

                <div id="gen" class="setting-content-pane active">
                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">اسم المدرسة</label>
                        <input type="text" id="confSchool" class="form-control" placeholder="أدخل اسم المدرسة">
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label class="upload-label">العام الدراسي</label>
                        <input type="text" id="confYear" class="form-control" placeholder="مثال: 2025 / 2026م">
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">شعار الوزارة</label>
                        <input type="file" id="file_ministry" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_ministry', 'ministryLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_ministry">
                            <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_ministry')"><i class="fas fa-upload"></i> تحميل شعار الوزارة</button>
                             <span class="upload-hint">الحجم المقترح: 200x80 بكسل</span>
                        </div>
                        <div id="preview_wrap_ministry" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_ministry" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_ministry', 'ministryLogo', 'file_ministry')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">شعار المدرسة</label>
                        <input type="file" id="file_school" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_school', 'schoolLogo')">
                        <div class="upload-btn-wrapper" id="btn_wrap_school">
                            <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_school')"><i class="fas fa-upload"></i> تحميل شعار المدرسة</button>
                             <span class="upload-hint">الحجم المقترح: 200x80 بكسل</span>
                        </div>
                        <div id="preview_wrap_school" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_school" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_school', 'schoolLogo', 'file_school')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="upload-container">
                        <label class="upload-label">ختم المدرسة</label>
                        <input type="file" id="file_stamp" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_stamp', 'schoolStamp')">
                        <div class="upload-btn-wrapper" id="btn_wrap_stamp">
                            <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_stamp')"><i class="fas fa-upload"></i> تحميل ختم المدرسة</button>
                             <span class="upload-hint">يستخدم في التقارير الرسمية</span>
                        </div>
                        <div id="preview_wrap_stamp" style="display:none;" class="image-preview-wrapper">
                            <img id="preview_stamp" class="image-preview" onclick="openImageModal(this.src)">
                            <button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_stamp', 'schoolStamp', 'file_stamp')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div style="text-align: left; border-top: 1px solid #eee; padding-top: 20px;">
                        <button class="btn btn-primary setting-edit-btn" style="width: 200px;" onclick="saveGeneralSettings()">حفظ الإعدادات</button>
                    </div>
                </div>

                <div id="sig" class="setting-content-pane">
                    <div class="signature-grid">
                        <div class="signature-card">
                            <div class="signature-title">مدير/ة المدرسة</div>
                            <div class="form-group">
                                <select id="sig_director" class="form-control" onchange="onSigChange()"><option value="">اختر مدير المدرسة</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary setting-edit-btn" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="clearSignature('sig_director')">إزالة</button>
                            </div>
                        </div>
                        <div class="signature-card">
                            <div class="signature-title">المدير/ة المساعد/ة</div>
                            <div class="form-group">
                                <select id="sig_assistant" class="form-control" onchange="onSigChange()"><option value="">اختر المدير المساعد</option></select>
                            </div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                                <button class="btn btn-primary setting-edit-btn" onclick="saveSignatureSettings()">حفظ</button>
                                <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="clearSignature('sig_assistant')">إزالة</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fot" class="setting-content-pane">
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">النص الذي سيظهر في تذييل كل صفحة</label>
                        <textarea id="footer_text" class="form-control" rows="5"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">محاذاة التذييل</label>
                        <select id="footer_align" class="form-control">
                            <option value="center">وسط</option>
                            <option value="right">يمين</option>
                            <option value="left">يسار</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px;">حجم الخط</label>
                        <select id="footer_fontsize" class="form-control">
                            <option value="10">10 نقطة</option>
                            <option value="12">12 نقطة</option>
                            <option value="14">14 نقطة</option>
                            <option value="16">16 نقطة</option>
                        </select>
                    </div>
                    <div style="text-align:left; margin-top:20px;">
                        <button class="btn setting-edit-btn" style="background:#28a745; color:white; font-weight:bold;" onclick="saveFooterSettings()">حفظ إعدادات التذييل</button>
                    </div>
                </div>

                <div id="eval" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3>معايير الزيارة الصفية</h3>
                        <div>
                             <button class="btn setting-edit-btn" style="background:#dc3545; color:white; font-size:0.8rem;" onclick="deleteSelectedSettings('criteria')">حذف المحدد</button>
                             <button class="btn setting-edit-btn" style="background:#2c5aa0; color:white;" onclick="openAddEvalModal()"><i class="fas fa-plus"></i> إضافة معيار</button>
                        </div>
                    </div>
                    <table class="custom-table">
                        <thead><tr><th width="5%"><input type="checkbox" id="selectAllCriteria" class="custom-checkbox" onchange="toggleSelectAllSettings('criteria', this)"></th><th width="10%">#</th><th width="45%">اسم المعيار</th><th width="15%">الحالة</th><th width="25%">الإجراءات</th></tr></thead>
                        <tbody id="evalTableBody"></tbody>
                    </table>

                    <hr style="margin: 40px 0; border-top: 1px solid #ddd;">

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3>قائمة التقديرات</h3>
                        <div>
                             <button class="btn setting-edit-btn" style="background:#dc3545; color:white; font-size:0.8rem;" onclick="deleteSelectedSettings('grades')">حذف المحدد</button>
                             <button class="btn setting-edit-btn" style="background:#2c5aa0; color:white;" onclick="openAddGradeModal()"><i class="fas fa-plus"></i> إضافة تقدير</button>
                        </div>
                    </div>
                    <table class="custom-table">
                        <thead><tr><th width="5%"><input type="checkbox" id="selectAllGrades" class="custom-checkbox" onchange="toggleSelectAllSettings('grades', this)"></th><th width="10%">#</th><th width="45%">اسم التقدير</th><th width="15%">الحالة</th><th width="25%">الإجراءات</th></tr></thead>
                        <tbody id="gradeTableBody"></tbody>
                    </table>
                </div>

                <div id="vis" class="setting-content-pane">
                    <div class="visitor-section">
                        <div class="visitor-section-title">القيادة العليا</div>
                        <ul id="list_visitor_senior" class="visitor-list"></ul>
                        <button class="btn-add-visitor setting-edit-btn" onclick="openVisitorPicker('senior')">+ إضافة زائر</button>
                    </div>
                    <div class="visitor-section">
                        <div class="visitor-section-title">القيادة الوسطى</div>
                        <ul id="list_visitor_middle" class="visitor-list"></ul>
                        <button class="btn-add-visitor setting-edit-btn" onclick="openVisitorPicker('middle')">+ إضافة زائر</button>
                    </div>
                    <div style="text-align: left; margin-top: 20px;">
                        <button class="btn btn-toggle setting-edit-btn" onclick="saveVisitorOrder()">حفظ الترتيب</button>
                    </div>
                </div>

                <div id="log" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="color:var(--primary); margin:0;">سجل العمليات (Audit Log)</h4>
                        <div>
                            <button class="btn" style="background:#17a2b8; color:white; font-size:0.8rem;" onclick="loadSystemLogs()"><i class="fas fa-sync"></i> تحديث</button>
                            <button class="btn setting-edit-btn" style="background:#dc3545; color:white; font-size:0.8rem;" onclick="clearSystemLogs()"><i class="fas fa-trash"></i> مسح السجل</button>
                        </div>
                    </div>
                    <div class="log-table-wrapper">
                        <table class="custom-table" style="font-size:0.9rem;">
                            <thead><tr><th width="20%">التاريخ والوقت</th><th width="20%">المستخدم</th><th width="20%">الحدث</th><th width="40%">التفاصيل</th></tr></thead>
                            <tbody id="logTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="brandModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="brandModalTitle">إضافة براند</span> <span onclick="closeModal('brandModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="brandForm">
                    <input type="hidden" id="editBrandId">
                    <label>اسم البراند</label>
                    <input type="text" id="brandName" class="form-control" required placeholder="مثال: فرع المحرق">
                    <label>البريد الإلكتروني للبراند</label>
                    <input type="email" id="brandEmail" class="form-control" placeholder="example@school.bh">
                    
                    <label style="color:var(--primary); font-weight:bold; margin-top:15px; display:block;">مدة صلاحية البراند</label>
                    <div style="display: flex; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee;">
                        <div style="flex:1;">
                            <label style="font-size:0.8rem; color:#777;">تاريخ البدء</label>
                            <input type="date" id="brandStartDate" class="form-control" style="margin-bottom:0;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.8rem; color:#777;">تاريخ الانتهاء</label>
                            <input type="date" id="brandEndDate" class="form-control" style="margin-bottom:0;">
                        </div>
                    </div>
                    <small style="color:#777; font-size:0.8rem; display:block; margin-top:5px;">* اترك التواريخ فارغة لصلاحية دائمة.</small>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveBrand()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('brandModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="addUserModalTitle">إضافة اسم جديد</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" id="editUserId">
                    <label>الاسم الكامل / اسم القسم</label><input type="text" id="addName" class="form-control" required>
                    <div id="deptWrapper" class="form-group" style="display:none;">
                        <label>القسم</label><select id="addDept" class="form-control"></select>
                    </div>
                    <div id="userFields">
                        <label>الوظيفة</label><input type="text" id="addJob" class="form-control">
                        <label>رقم الهاتف</label><input type="text" id="addPhone" class="form-control">
                        <label>اسم الدخول</label><input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label><input type="password" id="addPass" class="form-control">
                        
                        <div id="roleWrapper" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <label style="color:var(--primary); font-weight:bold; margin-bottom:5px;">صلاحية إضافية (اختياري)</label>
                            <select id="addRole" class="form-control" style="margin-bottom:15px;">
                                <option value="">مستخدم عادي</option>
                                <option value="supervisor">مشرف للنظام</option>
                                <option value="admin_support">إداري للنظام</option>
                            </select>
                            
                            <label style="color:var(--primary); font-weight:bold; margin-bottom:5px; margin-top:15px; display:block;">مدة صلاحية الحساب</label>
                            <div style="display: flex; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee;">
                                <div style="flex:1;">
                                    <label style="font-size:0.8rem; color:#777;">تاريخ البدء</label>
                                    <input type="date" id="addStartDate" class="form-control" style="margin-bottom:0;">
                                </div>
                                <div style="flex:1;">
                                    <label style="font-size:0.8rem; color:#777;">تاريخ الانتهاء</label>
                                    <input type="date" id="addEndDate" class="form-control" style="margin-bottom:0;">
                                </div>
                            </div>
                            <small style="color:#777; font-size:0.8rem; display:block; margin-top:5px;">* اترك التواريخ فارغة لصلاحية دائمة.</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveUserForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addUserModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="distinguishedModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="distinguishedModalTitle">إضافة</span> <span onclick="closeModal('distinguishedModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="distinguishedForm">
                    <input type="hidden" id="distType">
                    <input type="hidden" id="distEditId">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التاريخ</label>
                        <input type="date" class="form-control" id="distDate">
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="distDept" class="form-control" onchange="onDistinguishedDeptChange()"><option value="">اختر القسم...</option></select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">اسم المعلم/ة</label>
                        <select id="distTeacher" class="form-control"><option value="">اختر المعلم/ة...</option></select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التقدير</label>
                        <select id="distEval" class="form-control"><option value="">اختر التقدير...</option></select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">المبررات / ملاحظات</label>
                        <textarea id="distReason" class="form-control" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveDistinguishedEntry()">حفظ البيانات</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('distinguishedModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addQualitativeModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة تقرير نوعي</span> <span onclick="closeModal('addQualitativeModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="qualitativeForm">
                    <input type="hidden" id="qualEditId">
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التاريخ</label>
                        <input type="date" class="form-control" id="qualDate">
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="qualDept" class="form-control"><option value="">اختر القسم...</option></select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب القوة</label>
                        <textarea id="qualStrength" class="form-control" rows="4" placeholder="سجل جوانب القوة هنا..."></textarea>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب بحاجة إلى تطوير</label>
                        <textarea id="qualImprove" class="form-control" rows="4" placeholder="سجل جوانب التطوير هنا..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveQualitative()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addQualitativeModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addVisitModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة زيارة صفية</span> <span onclick="closeModal('addVisitModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addVisitForm">
                    <input type="hidden" id="visitEditId"> <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">القسم</label>
                        <select id="visitDept" class="form-control" onchange="onVisitDeptChange()"><option value="">اختر القسم...</option></select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">المعلم/ة</label>
                        <select id="visitTeacher" class="form-control"><option value="">اختر المعلم/ة...</option></select>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">تاريخ الزيارة</label>
                        <input type="date" id="visitDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">التقييم</label>
                        <select id="visitEval" class="form-control"><option value="">اختر التقييم...</option></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveVisit()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addVisitModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="viewVisitModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">تفاصيل الزيارة <span onclick="closeModal('viewVisitModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body" id="viewVisitContent">
                </div>
            <div class="modal-footer">
                <button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewVisitModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="addEvalModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة/تعديل معيار تقييم</span> <span onclick="closeModal('addEvalModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addEvalForm">
                    <input type="hidden" id="editEvalId">
                    <label>اسم المعيار</label>
                    <input type="text" id="evalName" class="form-control" required placeholder="مثال: التخطيط الفعال">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveEvalForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addEvalModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addGradeModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>إضافة/تعديل تقدير</span> <span onclick="closeModal('addGradeModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <form id="addGradeForm">
                    <input type="hidden" id="editGradeId">
                    <label>اسم التقدير</label>
                    <input type="text" id="gradeName" class="form-control" required placeholder="مثال: ممتاز">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveGradeForm()">حفظ</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('addGradeModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="viewUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">معاينة <span onclick="closeModal('viewUserModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body" id="viewUserContent"></div>
            <div class="modal-footer"><button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewUserModal')">إغلاق</button></div>
        </div>
    </div>

    <div id="permModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">إدارة الصلاحيات <span onclick="closeModal('permModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <h4 id="permTargetName" style="margin-top:0; color:var(--primary); margin-bottom:15px;"></h4>
                <div class="perm-header">
                    <span>تحديد الكل</span>
                    <div style="display:flex; gap:15px;">
                        <label><input type="checkbox" onchange="toggleAllPerms('view', this)"> الكل معاينة</label>
                        <label><input type="checkbox" onchange="toggleAllPerms('edit', this)"> الكل تعديل</label>
                    </div>
                </div>
                <div class="perm-list" id="permList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitPermissions()">حفظ الصلاحيات</button>
                <button class="btn" style="background:#ddd;" onclick="closeModal('permModal')">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="imageViewModal" class="modal-overlay" onclick="closeModal('imageViewModal')">
        <div style="position:relative; max-width:90%; max-height:90%;">
            <span onclick="closeModal('imageViewModal')" style="position:absolute; top:-40px; right:0; color:white; font-size:30px; cursor:pointer;">&times;</span>
            <img id="fullImage" src="" style="max-width:100%; max-height:80vh; border-radius:5px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
        </div>
    </div>

    <div id="visitorPickerModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">اختر اسماً للإضافة <span onclick="closeModal('visitorPickerModal')" style="cursor:pointer;">&times;</span></div>
            <div class="modal-body">
                <input type="text" id="visitorSearch" class="form-control" placeholder="بحث عن اسم..." onkeyup="filterPickerList()">
                <div id="pickerList" class="picker-list"></div>
            </div>
            <div class="modal-footer"><button class="btn" style="background:#ddd;" onclick="closeModal('visitorPickerModal')">إغلاق</button></div>
        </div>
    </div>

    <script>
        // === System Configuration ===
        const SECTIONS = [
            {id: 'dashboard', name: 'لوحة التحكم'},
            {id: 'visits', name: 'الزيارات الصفية'},
            {id: 'performance', name: 'تقييم الأداء'},
            {id: 'distinguished', name: 'المعلمين المتميزين'},
            {id: 'qualitative', name: 'التقرير النوعي'},
            {id: 'quality-report', name: 'تقرير جودة التعليم'},
            {id: 'user-management', name: 'إدارة المستخدمين'},
            {id: 'system-admin', name: 'إعدادات مدير النظام'},
            {id: 'settings', name: 'الإعدادات'}
        ];

        const DEFAULT_PERMS = {};
        SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});

        // Use a new key to ensure clean data start for the user
        const DB_KEY = 'Irteqaa_System_DB_Final_V10';

        const INITIAL_DB = {
            admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}],
            senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01', brandId: 1, allowedBrands: [1]}],
            middle: [], teachers: [], departments: [],
            visits_senior: [], visits_middle: [],
            distinguished: [], care_needed: [], qualitative_reports: [], saved_reports: [],
            settings: { 
                schoolName: 'مدرسة مدينة حمد الابتدائية للبنات', 
                schoolYear: '2025 / 2026م', 
                evaluation_criteria: [], 
                evaluation_grades: [
                    {name:'ممتاز', status:'active'},
                    {name:'جيد جداً', status:'active'},
                    {name:'جيد', status:'active'},
                    {name:'مقبول', status:'active'},
                    {name:'ضعيف', status:'active'},
                    {name:'يتجاوز التوقعات كثيراً', status:'active'},
                    {name:'يتجاوز التوقعات', status:'active'},
                    {name:'يفي بالتوقعات', status:'active'},
                    {name:'يفي بالتوقعات جزئيا', status:'active'}
                ],
                visitor_order_senior: [], 
                visitor_order_middle: [] 
            },
            brands: [
                {id: 1, name: 'الفرع الرئيسي', email: 'main@school.bh', status: 'active'}
            ],
            logs: [] 
        };

        // Fix Admin Perms in Initial
        SECTIONS.forEach(sec => { INITIAL_DB.admins[0].permissions[sec.id] = {view: true, edit: true}; });

        let DB = {}; 
        let CURRENT_USER = null;
        let CURRENT_BRAND = null;
        let CURRENT_TAB = 'senior';
        let CURRENT_VISIT_TAB = 'senior'; 
        let EDITING_PERM_ID = null;
        let IS_BULK_PERM_MODE = false;
        let CURRENT_PICKER_TYPE = null;
        let performanceChartInstance = null; 
        let dashBarChartInst = null;
        let dashPieChartInst = null;
        let CURRENT_IMPORT_TARGET = null;

        function canEdit(pageId) {
            if(!CURRENT_USER) return false;
            const p = CURRENT_USER.permissions || DEFAULT_PERMS;
            return (p[pageId] && p[pageId].edit === true);
        }

        function isAdminUser() {
            return CURRENT_USER && CURRENT_USER.id === 999;
        }

        function initSystem() {
            const storedDB = localStorage.getItem(DB_KEY);
            if (storedDB) {
                try {
                    DB = JSON.parse(storedDB);
                    if(!DB.brands) DB.brands = JSON.parse(JSON.stringify(INITIAL_DB.brands));
                    if(!DB.admins) DB.admins = JSON.parse(JSON.stringify(INITIAL_DB.admins));
                    if(!DB.senior) DB.senior = [];
                    if(!DB.middle) DB.middle = [];
                    if(!DB.teachers) DB.teachers = [];
                    if(!DB.departments) DB.departments = [];
                    if(!DB.visits_senior) DB.visits_senior = [];
                    if(!DB.visits_middle) DB.visits_middle = [];
                    if(!DB.distinguished) DB.distinguished = [];
                    if(!DB.care_needed) DB.care_needed = [];
                    if(!DB.qualitative_reports) DB.qualitative_reports = [];
                    if(!DB.saved_reports) DB.saved_reports = [];
                    if(!DB.logs) DB.logs = [];
                    if(!DB.settings) DB.settings = {};
                    
                    DB.settings = {...INITIAL_DB.settings, ...DB.settings};
                    if(!DB.settings.evaluation_grades) DB.settings.evaluation_grades = JSON.parse(JSON.stringify(INITIAL_DB.settings.evaluation_grades));

                    saveDB(); 
                } catch (e) {
                    console.error("Error loading DB, resetting:", e);
                    DB = JSON.parse(JSON.stringify(INITIAL_DB));
                    saveDB();
                }
            } else {
                DB = JSON.parse(JSON.stringify(INITIAL_DB));
                saveDB();
            }

            const sessionID = localStorage.getItem('Irteqaa_Session');
            if (sessionID) {
                let found = null;
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                    if(DB[grp]) { const u = DB[grp].find(x => x.id == sessionID); if(u) found = u; }
                });
                if (found && found.status === 'active') { 
                    
                    // CHECK USER EXPIRY
                    const today = new Date().toISOString().split('T')[0];
                    if (found.accessStartDate && found.accessStartDate > today) {
                        alert("عذراً، لم يبدأ تاريخ تفعيل حسابك بعد.");
                        localStorage.removeItem('Irteqaa_Session');
                        document.getElementById('loginPage').style.display = 'flex';
                        return;
                    }
                    if (found.accessEndDate && found.accessEndDate < today) {
                        alert("عذراً، انتهت صلاحية حسابك. يرجى التواصل مع المشرف لاستعادة الصلاحية.");
                        localStorage.removeItem('Irteqaa_Session');
                        document.getElementById('loginPage').style.display = 'flex';
                        return;
                    }

                    CURRENT_USER = found; 
                    
                    // -- Permission & Brand Context Logic --
                    const lastBrandId = localStorage.getItem('Irteqaa_CurrentBrand');
                    let targetBrand = null;

                    // 1. Is Admin? Access all.
                    if (isAdminUser()) {
                        targetBrand = DB.brands.find(b => b.id == lastBrandId && b.status === 'active') || DB.brands[0];
                    } else {
                        const allowedIds = found.allowedBrands || (found.brandId ? [found.brandId] : []);
                        if (lastBrandId && allowedIds.includes(parseInt(lastBrandId))) {
                            targetBrand = DB.brands.find(b => b.id == lastBrandId && b.status === 'active');
                        }
                        if (!targetBrand && allowedIds.length > 0) {
                            targetBrand = DB.brands.find(b => b.id === allowedIds[0] && b.status === 'active');
                        }
                    }

                    if (targetBrand) {
                        // === CHECK BRAND VALIDITY HERE ===
                        const today = new Date().toISOString().split('T')[0];
                        if (targetBrand.startDate && targetBrand.startDate > today) {
                            alert("عذراً، لم يبدأ تاريخ تفعيل اشتراك الجهة (البراند) بعد.");
                            logout();
                            return;
                        }
                        if (targetBrand.endDate && targetBrand.endDate < today) {
                            alert("عذراً، انتهت مدة صلاحية اشتراك الجهة (البراند). يرجى التواصل مع المشرف.");
                            logout();
                            return;
                        }

                        CURRENT_BRAND = targetBrand;
                        showApp();
                    } else {
                        alert("لا توجد جهة (براند) مصرح لك بالدخول إليها.");
                        localStorage.removeItem('Irteqaa_Session');
                        document.getElementById('loginPage').style.display = 'flex';
                    }

                } else { 
                    localStorage.removeItem('Irteqaa_Session');
                    document.getElementById('loginPage').style.display = 'flex'; 
                }
            } else { document.getElementById('loginPage').style.display = 'flex'; }
        }

        function saveDB() { 
            if(DB && DB.admins) {
                localStorage.setItem(DB_KEY, JSON.stringify(DB)); 
            }
        }
        
        function addSystemLog(action, details) {
            const logEntry = { id: Date.now(), date: new Date().toLocaleString('en-GB'), user: CURRENT_USER ? CURRENT_USER.name : 'النظام/زائر', action: action, details: details, brand: CURRENT_BRAND ? CURRENT_BRAND.name : 'N/A' };
            if(!DB.logs) DB.logs = []; DB.logs.unshift(logEntry); if(DB.logs.length > 500) DB.logs = DB.logs.slice(0, 500); saveDB();
        }

        function login(e) {
            e.preventDefault();
            const errBox = document.getElementById('loginError'); errBox.style.display = 'none'; errBox.innerText = '';
            const uInput = document.getElementById('loginUser').value.trim(); 
            const pInput = document.getElementById('loginPass').value.trim();
            
            let userFound = null;
            ['admins', 'senior', 'middle', 'teachers'].forEach(grp => {
                if(DB[grp]) { 
                    const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput); 
                    if(match) userFound = match; 
                }
            });
            
            if (userFound) {
                if (userFound.status !== 'active') { 
                    errBox.innerText = "نعتذر منك، هذا الحساب غير نشط حالياً."; errBox.style.display = 'block'; 
                    return; 
                }

                // === USER DATE CHECK ===
                const today = new Date().toISOString().split('T')[0];
                if (userFound.accessStartDate && userFound.accessStartDate > today) {
                    errBox.innerText = "عذراً، لم يبدأ تاريخ تفعيل حسابك بعد. يرجى التواصل مع المشرف."; 
                    errBox.style.display = 'block'; 
                    return;
                }
                if (userFound.accessEndDate && userFound.accessEndDate < today) {
                    errBox.innerText = "عذراً، انتهت مدة صلاحية حسابك. يرجى التواصل مع المشرف لاستعادة الصلاحية."; 
                    errBox.style.display = 'block'; 
                    return;
                }

                CURRENT_USER = userFound; 
                localStorage.setItem('Irteqaa_Session', userFound.id); 
                
                // Determine Brand on Login
                let targetBrandId = null;
                if(userFound.id === 999) {
                    targetBrandId = DB.brands[0].id;
                } else {
                    const allowedIds = userFound.allowedBrands || (userFound.brandId ? [userFound.brandId] : []);
                    if(allowedIds.length > 0) targetBrandId = allowedIds[0];
                }

                if(targetBrandId) {
                    // === BRAND DATE CHECK ===
                    const brand = DB.brands.find(b => b.id === targetBrandId);
                    if (brand) {
                        if (brand.startDate && brand.startDate > today) {
                            errBox.innerText = "عذراً، لم يبدأ تاريخ تفعيل اشتراك الجهة (البراند) بعد."; 
                            errBox.style.display = 'block'; 
                            return;
                        }
                        if (brand.endDate && brand.endDate < today) {
                            errBox.innerText = "عذراً، انتهت مدة صلاحية اشتراك الجهة (البراند). يرجى التواصل مع المشرف."; 
                            errBox.style.display = 'block'; 
                            return;
                        }
                    }

                    localStorage.setItem('Irteqaa_CurrentBrand', targetBrandId);
                    addSystemLog('تسجيل دخول', `المستخدم: ${userFound.name}`); 
                    location.reload(); 
                } else {
                    errBox.innerText = "لا يوجد براند مخصص لهذا المستخدم."; errBox.style.display = 'block';
                }

            } else { errBox.innerText = "بيانات الدخول غير صحيحة."; errBox.style.display = 'block'; }
        }
        
        function togglePass(fieldId, icon) {
            const input = document.getElementById(fieldId);
            if (input.type === "password") {
                input.type = "text"; icon.classList.remove("fa-eye"); icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password"; icon.classList.remove("fa-eye-slash"); icon.classList.add("fa-eye");
            }
        }

        function logout() { 
            if(CURRENT_USER) addSystemLog('تسجيل خروج', `المستخدم: ${CURRENT_USER.name}`); 
            localStorage.removeItem('Irteqaa_Session'); 
            saveDB(); 
            location.reload(); 
        }
        
        function navigate(pageId) {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            if (perms[pageId] && perms[pageId].view === false) { alert("عذراً، ليس لديك صلاحية للوصول إلى هذه الصفحة."); return; }
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById(pageId);
            const link = document.querySelector(`a[data-page="${pageId}"]`);
            if (target) target.classList.add('active');
            if (link) link.classList.add('active');
            
            const activeSection = SECTIONS.find(s => s.id === pageId);
            if(activeSection) document.getElementById('pageTitle').innerText = activeSection.name;

            if(pageId === 'dashboard') renderDashboard();
            if(pageId === 'settings') loadSettings();
            if(pageId === 'visits') renderVisitsTable(); 
            if(pageId === 'performance') renderPerformanceChart();
            if(pageId === 'distinguished') renderDistinguishedTables(); 
            if(pageId === 'qualitative') renderQualitativeTable();
            if(pageId === 'quality-report') { 
                const d = new Date();
                document.getElementById('reportMonthSelect').value = String(d.getMonth()+1).padStart(2,'0');
            }
            if(pageId === 'system-admin') renderBrandsTable();
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none'; document.getElementById('app').style.display = 'flex';
            document.getElementById('headerUserName').innerText = CURRENT_USER.name;
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || 'مستخدم';
            
            // Brand Setup
            updateBrandUI();

            // Toggle Admin Buttons visibility
            const adminBtns = document.querySelectorAll('.admin-only-btn');
            adminBtns.forEach(btn => {
                btn.style.display = isAdminUser() ? 'inline-block' : 'none';
            });

            applySidebarPermissions(); renderTable();
            const now = new Date();
            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
            if(document.getElementById('dashMonthFilter')) document.getElementById('dashMonthFilter').value = currentMonth;
            
            if(document.getElementById('qualMonthFilter')) document.getElementById('qualMonthFilter').value = currentMonth;

            navigate('dashboard');
        }

        function applySidebarPermissions() {
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS;
            SECTIONS.forEach(sec => {
                const el = document.getElementById('nav-' + sec.id);
                if(el) {
                    if (sec.id === 'system-admin') {
                        el.style.display = isAdminUser() ? 'block' : 'none';
                    } else {
                        // FIX: Ensure display is set based on permission, but don't hide system-admin logic again here
                        el.style.display = (perms[sec.id] && perms[sec.id].view === false) ? 'none' : 'block';
                    }
                }
            });
        }

        // === BRAND SWITCHER LOGIC ===
        function toggleBrandDropdown() {
            document.getElementById('brandDropdown').classList.toggle('show');
        }

        // Close dropdown if clicked outside
        window.onclick = function(event) {
            if (!event.target.matches('.brand-btn') && !event.target.closest('.brand-btn')) {
                var dropdowns = document.getElementsByClassName("brand-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function updateBrandUI() {
            if(!CURRENT_BRAND) return;
            document.getElementById('currentBrandLabel').innerText = CURRENT_BRAND.name;
            const dropdown = document.getElementById('brandDropdown');
            dropdown.innerHTML = '';
            
            DB.brands.forEach(b => {
                let hasAccess = false;
                if (isAdminUser()) {
                    hasAccess = true;
                } else {
                    const allowedIds = CURRENT_USER.allowedBrands || (CURRENT_USER.brandId ? [CURRENT_USER.brandId] : []);
                    if (allowedIds.includes(b.id)) hasAccess = true;
                }

                if (hasAccess && b.status === 'active') {
                    const activeClass = (b.id === CURRENT_BRAND.id) ? 'active' : '';
                    dropdown.innerHTML += `
                    <div class="brand-item ${activeClass}" onclick="switchBrand(${b.id})">
                        <div class="brand-icon">${b.name.charAt(0)}</div>
                        <div class="brand-label">${b.name}</div>
                    </div>`;
                }
            });
        }

        function switchBrand(id) {
            const newBrand = DB.brands.find(b => b.id === id);
            if(newBrand) {
                // Check Brand Expiry before switching
                const today = new Date().toISOString().split('T')[0];
                if (newBrand.endDate && newBrand.endDate < today && !isAdminUser()) {
                    alert("عذراً، انتهت مدة صلاحية اشتراك هذه الجهة.");
                    return;
                }

                CURRENT_BRAND = newBrand;
                localStorage.setItem('Irteqaa_CurrentBrand', id);
                // 3. Auto Refresh (The core requirement)
                location.reload();
            }
        }

        // Helper to filter data by Brand context
        // Existing data (no brandId) is treated as Default Brand (ID 1)
        function filterByContext(list) {
            if(!list) return [];
            return list.filter(item => {
                const itemBrandId = item.brandId || 1; // Default to ID 1 if undefined
                // If it's a global admin (id 999), they are visible in all contexts? 
                // Or filtered out? Usually filtered out of regular lists to avoid clutter.
                if(item.id === 999) return false; 
                return itemBrandId === CURRENT_BRAND.id;
            });
        }

        // === Dashboard Logic ===
        function renderDashboard() {
            const filter = document.getElementById('dashMonthFilter').value;
            // Context Filter applied here
            let seniorVisits = filterByContext(DB.visits_senior || []);
            let middleVisits = filterByContext(DB.visits_middle || []);
            let allVisits = [...seniorVisits, ...middleVisits];
            
            // If user is not Admin/Senior, filter by Dept (Teacher view)
            const isRestricted = !isAdminUser() && !DB.senior.some(u => u.id === CURRENT_USER.id);
            if (isRestricted) {
                const userDept = CURRENT_USER.dept; 
                if(userDept) {
                      allVisits = allVisits.filter(x => x.dept === userDept);
                }
            }

            if (filter !== 'all') {
                allVisits = allVisits.filter(x => x.date.split('-')[1] === filter);
            }

            // Stats Calculation
            const total = allVisits.length;
            let exceedsLot = 0, exceeds = 0, meets = 0, partially = 0;

            allVisits.forEach(v => {
                if(v.eval.includes('يتجاوز التوقعات بكثير') || v.eval.includes('ممتاز')) exceedsLot++;
                else if(v.eval.includes('يتجاوز التوقعات') || v.eval.includes('جيد جداً')) exceeds++;
                else if(v.eval.includes('يفي بالتوقعات') || v.eval.includes('جيد')) meets++;
                else partially++;
            });

            animateValue('stat_total', parseInt(document.getElementById('stat_total').innerText), total, 1000);
            animateValue('stat_exceeds_lot', parseInt(document.getElementById('stat_exceeds_lot').innerText), exceedsLot, 1000);
            animateValue('stat_exceeds', parseInt(document.getElementById('stat_exceeds').innerText), exceeds, 1000);
            animateValue('stat_meets', parseInt(document.getElementById('stat_meets').innerText), meets, 1000);
            animateValue('stat_partially', parseInt(document.getElementById('stat_partially').innerText), partially, 1000);

            const hasData = allVisits.length > 0;
            const deptCounts = {};
            allVisits.forEach(v => { deptCounts[v.dept] = (deptCounts[v.dept] || 0) + 1; });
            const deptLabels = Object.keys(deptCounts);
            const deptData = Object.values(deptCounts);

            if (dashBarChartInst) dashBarChartInst.destroy();
            dashBarChartInst = new Chart(document.getElementById('dashBarChart').getContext('2d'), {
                type: 'bar',
                data: { labels: hasData ? deptLabels : ['لا توجد زيارات'], datasets: [{ label: 'عدد الزيارات', data: hasData ? deptData : [0], backgroundColor: hasData ? '#1e4078' : '#e9ecef', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });

            const evalCounts = {};
            allVisits.forEach(v => { evalCounts[v.eval] = (evalCounts[v.eval] || 0) + 1; });
            const evalLabels = Object.keys(evalCounts);
            const evalData = Object.values(evalCounts);

            if (dashPieChartInst) dashPieChartInst.destroy();
            dashPieChartInst = new Chart(document.getElementById('dashPieChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: hasData ? evalLabels : ['لا توجد زيارات'], datasets: [{ data: hasData ? evalData : [1], backgroundColor: hasData ? ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6610f2'] : ['#e9ecef'], borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id); let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) { window.requestAnimationFrame(step); }
            }; window.requestAnimationFrame(step);
        }

        // === User Management ===
        function setTab(tab, el) {
            CURRENT_TAB = tab;
            document.querySelectorAll('#user-management .custom-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active'); if(document.getElementById('selectAll')) document.getElementById('selectAll').checked = false;
            renderTable();
        }
        function renderTable() {
            const headRow = document.getElementById('tableHeadRow'); const tbody = document.getElementById('usersTableBody');
            const addBtn = document.getElementById('addBtnMain'); const bulkPermBtn = document.getElementById('bulkPermBtn');
            tbody.innerHTML = '';
            const canEditUsers = canEdit('user-management');
            const actionButtons = document.getElementById('userActionButtons'); const noEditMsg = document.getElementById('noEditPermissionMsg');
            if(canEditUsers) { actionButtons.style.display = 'flex'; noEditMsg.style.display = 'none'; } else { actionButtons.style.display = 'none'; noEditMsg.style.display = 'block'; }
            
            // Header Logic
            let headerHTML = `<th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)" ${canEditUsers?'':'disabled'}></th>`;
            
            if (CURRENT_TAB === 'departments') {
                headerHTML += `<th width="10%">الترتيب</th><th width="40%">اسم القسم</th><th width="15%">الحالة</th><th width="30%">الإدارة</th>`;
                addBtn.innerText = "إضافة قسم جديد"; if(bulkPermBtn) bulkPermBtn.style.display = 'none'; 
            } else if (CURRENT_TAB === 'teachers') {
                headerHTML += `<th width="5%">#</th><th width="25%">الاسم</th><th width="15%">القسم</th><th width="15%">الحالة</th><th width="35%">الإجراءات</th>`;
                addBtn.innerText = "إضافة اسم جديد"; if(bulkPermBtn) bulkPermBtn.style.display = 'inline-flex';
            } else {
                headerHTML += `<th width="5%">#</th><th width="25%">الاسم</th><th width="15%">الوظيفة</th><th width="15%">صلاحية إضافية</th><th width="10%">الحالة</th><th width="25%">الإجراءات</th>`;
                addBtn.innerText = "إضافة اسم جديد"; if(bulkPermBtn) bulkPermBtn.style.display = 'inline-flex';
            }
            headRow.innerHTML = headerHTML;

            // Strict Filter for ALL User Types by Brand
            let list = filterByContext(DB[CURRENT_TAB] || []);

            list.forEach((u, idx) => {
                const isActive = u.status === 'active';
                const statusBadge = isActive ? `<span class="status-badge status-active">مفعل</span>` : `<span class="status-badge status-inactive">معطل</span>`;
                let row = `<td><input type="checkbox" class="custom-checkbox user-select-cb" value="${u.id}" ${canEditUsers ? '' : 'disabled'}></td><td>${idx+1}</td><td>${u.name}</td>`;
                if (CURRENT_TAB === 'departments') {
                     row += `<td>${statusBadge}</td><td><div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;">`;
                } else if (CURRENT_TAB === 'teachers') {
                     row += `<td>${u.dept || '-'}</td><td>${statusBadge}</td><td><div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;">`;
                } else {
                     let roleTxt = '-';
                     if(u.role === 'supervisor') roleTxt = '<span class="role-badge role-super">مشرف</span>';
                     if(u.role === 'admin_support') roleTxt = '<span class="role-badge role-admin">إداري</span>';
                     row += `<td>${u.job || '-'}</td><td>${roleTxt}</td><td>${statusBadge}</td><td><div style="display:flex; justify-content:center; gap:2px; flex-wrap:wrap;">`;
                }
                
                if(canEditUsers) { row += `<button class="action-btn btn-move" onclick="moveUser(${u.id}, 'up')" title="نقل لأعلى"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveUser(${u.id}, 'down')" title="نقل لأسفل"><i class="fas fa-arrow-down"></i></button>`; }
                
                if (CURRENT_TAB === 'departments') {
                    if(canEditUsers) { row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button><button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i> تعديل</button><button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> حذف</button>`; }
                } else {
                    row += `<button class="action-btn btn-view" onclick="viewUser(${u.id})"><i class="fas fa-eye"></i> معاينة</button>`;
                    if (canEditUsers) { row += `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button><button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i> تعديل</button><button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> حذف</button><button class="action-btn btn-perm" onclick="openPerms(${u.id})"><i class="fas fa-key"></i> صلاحيات</button>`; }
                }
                row += `</div></td>`;
                const tr = document.createElement('tr'); tr.innerHTML = row; tbody.appendChild(tr);
            });
        }
        function moveUser(id, d) { const l=DB[CURRENT_TAB]; const i=l.findIndex(u=>u.id===id); if(i===-1)return; if(d==='up'&&i>0)[l[i],l[i-1]]=[l[i-1],l[i]]; if(d==='down'&&i<l.length-1)[l[i],l[i+1]]=[l[i+1],l[i]]; saveDB(); renderTable(); }
        function toggleSelectAll(s) { document.querySelectorAll('.user-select-cb').forEach(c=>{if(!c.disabled)c.checked=s.checked}); }
        function deleteSelected() { const c=document.querySelectorAll('.user-select-cb:checked'); if(c.length===0)return alert('حدد عناصر'); if(confirm('حذف؟')){const ids=Array.from(c).map(x=>parseInt(x.value)); DB[CURRENT_TAB]=DB[CURRENT_TAB].filter(u=>!ids.includes(u.id)); addSystemLog('حذف جماعي', `حذف ${ids.length}`); saveDB(); renderTable(); document.getElementById('selectAll').checked=false;} }
        function toggleStatusSelected() { const c=document.querySelectorAll('.user-select-cb:checked'); if(c.length===0)return alert('حدد عناصر'); const ids=Array.from(c).map(x=>parseInt(x.value)); DB[CURRENT_TAB].forEach(u=>{if(ids.includes(u.id))u.status=u.status==='active'?'inactive':'active'}); addSystemLog('تغيير حالة جماعي', `تعديل ${ids.length}`); saveDB(); renderTable(); }
        function toggleStatus(id) { const u=DB[CURRENT_TAB].find(x=>x.id===id); if(u){u.status=u.status==='active'?'inactive':'active'; addSystemLog('تغيير حالة', u.name); saveDB(); renderTable();} }
        
        // Export Excel Function using SheetJS
        function exportExcel() {
            // STRICT FILTER FOR EXPORT
            let list = filterByContext(DB[CURRENT_TAB] || []);
            
            let isTemplate = false;
            if (list.length === 0) {
                alert('لا توجد بيانات مسجلة حالياً. سيتم تصدير قالب فارغ يمكنك تعبئته واستخدامه للاستيراد.');
                isTemplate = true;
            }

            let headers = [];
            let data = [];

            if (CURRENT_TAB === 'departments') {
                headers = ['الترتيب', 'اسم القسم'];
                list.forEach((row, index) => {
                    data.push({
                        'الترتيب': index + 1,
                        'اسم القسم': row.name
                    });
                });
            } else if (CURRENT_TAB === 'teachers') {
                headers = ['الترتيب', 'الاسم', 'القسم'];
                list.forEach((row, index) => {
                    data.push({
                        'الترتيب': index + 1,
                        'الاسم': row.name,
                        'القسم': row.dept || ''
                    });
                });
            } else {
                // Senior/Middle Leadership
                headers = ['الاسم', 'الوظيفة', 'رقم الهاتف', 'اسم المستخدم', 'كلمة المرور'];
                list.forEach(row => {
                    data.push({
                        'الاسم': row.name,
                        'الوظيفة': row.job || '',
                        'رقم الهاتف': row.phone || '',
                        'اسم المستخدم': row.login || '',
                        'كلمة المرور': row.pass || ''
                    });
                });
            }

            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${CURRENT_TAB}${isTemplate ? '_Template' : ''}.xlsx`);
        }

        function openAddUserModal() { 
            if(!canEdit('user-management')) return alert('ليس لديك صلاحية لإضافة مستخدمين');
            document.getElementById('editUserId').value=''; document.getElementById('addUserForm').reset(); document.getElementById('addUserModal').style.display='flex'; 
            const d=(CURRENT_TAB==='departments'), t=(CURRENT_TAB==='teachers'); 
            const roleWrapper = document.getElementById('roleWrapper');
            if(d){document.getElementById('addUserModalTitle').innerText='إضافة قسم'; document.getElementById('userFields').style.display='none'; document.getElementById('deptWrapper').style.display='none';} 
            else if(t){
                document.getElementById('addUserModalTitle').innerText='إضافة معلمة'; 
                document.getElementById('userFields').style.display='none'; 
                document.getElementById('deptWrapper').style.display='block'; 
                const s=document.getElementById('addDept'); 
                s.innerHTML='<option value="">اختر...</option>'; 
                // Populate depts from CURRENT BRAND only
                filterByContext(DB.departments||[]).forEach(x=>s.innerHTML+=`<option value="${x.name}">${x.name}</option>`);
            } 
            else {
                document.getElementById('addUserModalTitle').innerText='إضافة مستخدم'; 
                document.getElementById('userFields').style.display='block'; 
                document.getElementById('deptWrapper').style.display='none';
                roleWrapper.style.display = 'block'; // Show Role Select only for Leaders
            } 
        }
        function editUser(id) { 
            if(!canEdit('user-management')) return;
            const u=DB[CURRENT_TAB].find(x=>x.id===id); if(!u)return; document.getElementById('editUserId').value=u.id; document.getElementById('addName').value=u.name; openAddUserModal(); document.getElementById('addUserModalTitle').innerText='تعديل'; 
            if(CURRENT_TAB==='teachers'){
                // Refill dropdown for edit
                const s=document.getElementById('addDept'); 
                s.innerHTML='<option value="">اختر...</option>'; 
                filterByContext(DB.departments||[]).forEach(x=>s.innerHTML+=`<option value="${x.name}">${x.name}</option>`);
                document.getElementById('addDept').value=u.dept;
            } else if(CURRENT_TAB!=='departments'){
                document.getElementById('addJob').value=u.job||''; 
                document.getElementById('addPhone').value=u.phone||''; 
                document.getElementById('addLogin').value=u.login||''; 
                document.getElementById('addPass').value=u.pass||'';
                document.getElementById('addRole').value=u.role||'';
                document.getElementById('addStartDate').value=u.accessStartDate||'';
                document.getElementById('addEndDate').value=u.accessEndDate||'';
            } 
        }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        function saveUserForm() { 
            const n=document.getElementById('addName').value.trim(); 
            if(!n)return alert('الاسم مطلوب'); 
            const id=document.getElementById('editUserId').value; 
            const edit=id!==''; 
            let u; 
            
            if(edit){
                u=DB[CURRENT_TAB].find(x=>x.id==id); 
                u.name=n; 
                u.lastUpdated=new Date().toLocaleString('en-GB'); 
                u.lastUpdatedBy=CURRENT_USER.name;
            } else {
                u={
                    id:Date.now(), 
                    name:n, 
                    status:'active', 
                    lastUpdated:new Date().toLocaleString('en-GB'), 
                    lastUpdatedBy:CURRENT_USER.name,
                    brandId: CURRENT_BRAND.id, // ** CRITICAL: Bind to current Brand **
                    allowedBrands: [CURRENT_BRAND.id] // Auto-allow current brand
                }; 

                if(CURRENT_TAB!=='departments'){
                    u.dateAdded=new Date().toLocaleDateString('en-GB'); 
                    u.permissions=JSON.parse(JSON.stringify(DEFAULT_PERMS));
                }
            } 
            
            if(CURRENT_TAB==='teachers') u.dept=document.getElementById('addDept').value; 
            else if(CURRENT_TAB!=='departments'){
                u.job=document.getElementById('addJob').value; 
                u.phone=document.getElementById('addPhone').value; 
                u.login=document.getElementById('addLogin').value; 
                u.pass=document.getElementById('addPass').value; 
                u.role=document.getElementById('addRole').value;
                // === SAVE VALIDITY DATES ===
                u.accessStartDate = document.getElementById('addStartDate').value;
                u.accessEndDate = document.getElementById('addEndDate').value;
            } 
            
            if(!edit)DB[CURRENT_TAB].push(u); 
            saveDB(); renderTable(); closeModal('addUserModal'); 
        }
        
        function deleteUser(id) { if(!canEdit('user-management')) return; if(confirm('حذف؟')){DB[CURRENT_TAB]=DB[CURRENT_TAB].filter(u=>u.id!==id); saveDB(); renderTable();} }
        function viewUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id === id);
            let roleTxt = 'مستخدم عادي';
            if(u.role === 'supervisor') roleTxt = 'مشرف نظام';
            if(u.role === 'admin_support') roleTxt = 'إداري نظام';
            
            document.getElementById('viewUserContent').innerHTML = `
                <div class="user-view-card"><div class="user-view-avatar">${u.name.charAt(0)}</div><h3 style="color:var(--primary); margin:0;">${u.name}</h3></div>
                <div class="info-grid">
                    <div class="info-item"><label>الوظيفة</label><span>${u.job || u.dept || '-'}</span></div>
                    <div class="info-item"><label>رقم الهاتف</label><span>${u.phone || '-'}</span></div>
                    <div class="info-item"><label>الحالة</label><span style="color:${u.status==='active'?'green':'red'}">${u.status==='active'?'مفعل':'معطل'}</span></div>
                    <div class="info-item"><label>اسم الدخول</label><span style="background:#eee; padding:2px 5px; border-radius:4px;">${u.login || '-'}</span></div>
                    ${(CURRENT_TAB !== 'departments' && CURRENT_TAB !== 'teachers') ? `<div class="info-item"><label>الصلاحية الإضافية</label><span>${roleTxt}</span></div>` : ''}
                    <div class="info-item"><label>تاريخ البدء</label><span>${u.accessStartDate || 'غير محدد'}</span></div>
                    <div class="info-item"><label>تاريخ الانتهاء</label><span>${u.accessEndDate || 'غير محدد'}</span></div>
                </div>
                <div class="view-footer-info"><div>آخر تحديث بواسطة: <strong>${u.lastUpdatedBy || 'N/A'}</strong></div><div>${u.lastUpdated || '-'}</div></div>
            `;
            document.getElementById('viewUserModal').style.display = 'flex';
        }
        function openPerms(id) { EDITING_PERM_ID = id; IS_BULK_PERM_MODE = false; const u = DB[CURRENT_TAB].find(x => x.id === id); if(!u) return; document.getElementById('permTargetName').innerText = `صلاحيات: ${u.name}`; renderPermList(u.permissions); document.getElementById('permModal').style.display = 'flex'; }
        function openBulkPerms() { const c = document.querySelectorAll('.user-select-cb:checked'); if(c.length === 0) return alert('يرجى تحديد مستخدمين أولاً'); EDITING_PERM_ID = null; IS_BULK_PERM_MODE = true; document.getElementById('permTargetName').innerText = `تعديل صلاحيات لـ ${c.length} مستخدمين`; renderPermList(DEFAULT_PERMS); document.getElementById('permModal').style.display = 'flex'; }
        function renderPermList(perms) {
            const list = document.getElementById('permList'); list.innerHTML = '';
            SECTIONS.forEach(s => {
                if (s.id === 'system-admin') return; // HIDE SYSTEM ADMIN FROM PERMISSIONS UI
                const p = perms[s.id] || {view: false, edit: false};
                list.innerHTML += `<div class="perm-item"><span>${s.name}</span><div><label style="margin-left:15px;"><input type="checkbox" class="perm-check-view" data-sec="${s.id}" ${p.view?'checked':''}> معاينة</label><label><input type="checkbox" class="perm-check-edit" data-sec="${s.id}" ${p.edit?'checked':''}> تعديل</label></div></div>`;
            });
        }
        function toggleAllPerms(type, cb) { document.querySelectorAll(`.perm-check-${type}`).forEach(c => c.checked = cb.checked); }
        function submitPermissions() {
            const newPerms = {}; SECTIONS.forEach(s => { 
                if(s.id === 'system-admin') return;
                newPerms[s.id] = { view: document.querySelector(`.perm-check-view[data-sec="${s.id}"]`).checked, edit: document.querySelector(`.perm-check-edit[data-sec="${s.id}"]`).checked }; 
            });
            if (IS_BULK_PERM_MODE) {
                const checkboxes = document.querySelectorAll('.user-select-cb:checked'); const ids = Array.from(checkboxes).map(x => parseInt(x.value));
                DB[CURRENT_TAB].forEach(u => { if(ids.includes(u.id)) u.permissions = JSON.parse(JSON.stringify(newPerms)); }); addSystemLog('تعديل صلاحيات جماعي', `لـ ${ids.length} مستخدمين`);
            } else { const u = DB[CURRENT_TAB].find(x => x.id === EDITING_PERM_ID); if(u) { u.permissions = newPerms; addSystemLog('تعديل صلاحيات', u.name); } }
            saveDB(); closeModal('permModal');
        }

        // === Import Excel Functionality (User Management) ===
        function triggerImportExcel() { document.getElementById('importExcelInput').click(); }
        function handleExcelImport(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ""});
                    
                    if (jsonData.length === 0) return alert('الملف فارغ!');

                    let count = 0; let skipped = 0; const dateAdded = new Date().toLocaleDateString('en-GB');
                    jsonData.forEach((row, index) => {
                        let name = (CURRENT_TAB === 'departments') ? (row['اسم القسم'] || row['الاسم'] || row['Name'] || '') : (row['الاسم'] || row['Name'] || '');
                        if (name) {
                            const exists = DB[CURRENT_TAB].some(u => u.name === name && u.brandId === CURRENT_BRAND.id);
                            if (!exists) {
                                const newUser = {
                                    id: Date.now() + index, name: name, status: 'active',
                                    permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)),
                                    dateAdded: dateAdded, lastUpdated: new Date().toLocaleString('en-GB'), lastUpdatedBy: CURRENT_USER ? CURRENT_USER.name : 'Import',
                                    brandId: CURRENT_BRAND.id, // BIND TO BRAND
                                    allowedBrands: [CURRENT_BRAND.id]
                                };
                                
                                if (CURRENT_TAB === 'departments') { 
                                    DB[CURRENT_TAB].push(newUser); count++; 
                                }
                                else if (CURRENT_TAB === 'teachers') { 
                                    newUser.dept = row['القسم'] || row['Department'] || ''; 
                                    DB[CURRENT_TAB].push(newUser); count++; 
                                }
                                else { 
                                    newUser.job = row['الوظيفة'] || row['Job'] || ''; 
                                    newUser.phone = row['رقم الهاتف'] || row['Phone'] || ''; 
                                    newUser.login = row['اسم المستخدم'] || row['User'] || ''; 
                                    newUser.pass = row['كلمة المرور'] || row['Pass'] || ''; 
                                    DB[CURRENT_TAB].push(newUser); count++; 
                                }
                            } else { skipped++; }
                        }
                    });

                    if (count > 0) { saveDB(); renderTable(); alert(`تم استيراد ${count} سجل بنجاح.`); } else { alert('لم يتم استيراد أي سجل جديد.'); }
                    input.value = "";
                };
                reader.readAsArrayBuffer(input.files[0]);
            }
        }

        // === Generic Import/Export for Visits, Qualitative, Distinguished ===
        function exportSpecificExcel(type) {
            let data = [];
            let headers = [];
            let filename = type + '.xlsx';

            if (type === 'visits') {
                const list = (CURRENT_VISIT_TAB === 'senior') ? DB.visits_senior : DB.visits_middle;
                const filteredList = filterByContext(list);
                headers = ['التاريخ', 'القسم', 'المعلم', 'التقييم', 'الزائر'];
                filteredList.forEach(v => data.push({'التاريخ':v.date, 'القسم':v.dept, 'المعلم':v.teacher, 'التقييم':v.eval, 'الزائر':v.visitor}));
                filename = (CURRENT_VISIT_TAB === 'senior' ? 'Senior_Visits' : 'Middle_Visits') + '.xlsx';
            } else if (type === 'qualitative') {
                headers = ['التاريخ', 'القسم', 'جوانب القوة', 'جوانب التطوير'];
                filterByContext(DB.qualitative_reports).forEach(q => data.push({'التاريخ':q.date, 'القسم':q.dept, 'جوانب القوة':q.strength, 'جوانب التطوير':q.improve}));
            } else if (type === 'distinguished') {
                headers = ['التاريخ', 'القسم', 'المعلم', 'التقييم', 'المبررات'];
                filterByContext(DB.distinguished).forEach(d => data.push({'التاريخ':d.date, 'القسم':d.dept, 'المعلم':d.teacher, 'التقييم':d.eval, 'المبررات':d.reason}));
            } else if (type === 'care') {
                headers = ['التاريخ', 'القسم', 'المعلم', 'التقييم', 'المبررات'];
                filterByContext(DB.care_needed).forEach(d => data.push({'التاريخ':d.date, 'القسم':d.dept, 'المعلم':d.teacher, 'التقييم':d.eval, 'المبررات':d.reason}));
            }

            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, filename);
        }

        function triggerImportExcelGeneric(type) {
            CURRENT_IMPORT_TARGET = type;
            document.getElementById('importExcelGenericInput').click();
        }

        function handleExcelImportGeneric(input) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                if (jsonData.length === 0) return alert('الملف فارغ');
                
                let count = 0;
                const targetType = CURRENT_IMPORT_TARGET; 
                
                jsonData.forEach((row, idx) => {
                    const id = Date.now() + idx;
                    if (targetType === 'visits') {
                        const arr = (CURRENT_VISIT_TAB === 'senior') ? DB.visits_senior : DB.visits_middle;
                        arr.push({
                            id: id,
                            date: row['التاريخ'] || new Date().toISOString().slice(0,10),
                            dept: row['القسم'] || '',
                            teacher: row['المعلم'] || '',
                            eval: row['التقييم'] || '',
                            visitor: row['الزائر'] || CURRENT_USER.name,
                            visitorJob: 'مستورد',
                            brandId: CURRENT_BRAND.id
                        });
                        count++;
                    } else if (targetType === 'qualitative') {
                        DB.qualitative_reports.push({
                            id: id,
                            date: row['التاريخ'] || new Date().toISOString().slice(0,10),
                            dept: row['القسم'] || '',
                            strength: row['جوانب القوة'] || '',
                            improve: row['جوانب التطوير'] || '',
                            brandId: CURRENT_BRAND.id
                        });
                        count++;
                    } else if (targetType === 'distinguished') {
                         DB.distinguished.push({
                            id: id,
                            date: row['التاريخ'] || new Date().toISOString().slice(0,10),
                            dept: row['القسم'] || '',
                            teacher: row['المعلم'] || '',
                            eval: row['التقييم'] || '',
                            reason: row['المبررات'] || '',
                            brandId: CURRENT_BRAND.id
                        });
                        count++;
                    } else if (targetType === 'care') {
                         DB.care_needed.push({
                            id: id,
                            date: row['التاريخ'] || new Date().toISOString().slice(0,10),
                            dept: row['القسم'] || '',
                            teacher: row['المعلم'] || '',
                            eval: row['التقييم'] || '',
                            reason: row['المبررات'] || '',
                            brandId: CURRENT_BRAND.id
                        });
                        count++;
                    }
                });
                
                if (count > 0) {
                    saveDB();
                    alert(`تم استيراد ${count} سجل إلى ${CURRENT_BRAND.name}`);
                    if(targetType === 'visits') renderVisitsTable();
                    if(targetType === 'qualitative') renderQualitativeTable();
                    if(targetType === 'distinguished' || targetType === 'care') renderDistinguishedTables();
                }
                input.value = '';
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        // === System Admin Logic ===
        function renderBrandsTable() {
            if(!isAdminUser()) return;
            const tbody = document.getElementById('brandsTableBody');
            tbody.innerHTML = '';
            DB.brands.forEach((b, idx) => {
                const isActive = b.status === 'active';
                const statusBadge = isActive ? `<span class="status-badge status-active">نشط</span>` : `<span class="status-badge status-inactive">معطل</span>`;
                const isDefault = (b.id === 1);
                const deleteBtn = isDefault ? '' : `<button class="action-btn btn-delete" onclick="deleteBrand(${b.id})"><i class="fas fa-trash"></i></button>`;
                // ADD RESET BUTTON
                const resetBtn = `<button class="action-btn btn-reset" onclick="resetBrandData(${b.id})" title="إعادة تهيئة"><i class="fas fa-redo"></i> تهيئة</button>`;
                
                let validityStr = '-';
                if(b.startDate || b.endDate) {
                    const start = b.startDate || 'غير محدد';
                    const end = b.endDate || 'غير محدد';
                    validityStr = `<div style="font-size:0.8rem; line-height:1.2;">من: ${start}<br>إلى: ${end}</div>`;
                }

                tbody.innerHTML += `
                <tr>
                    <td>${idx+1}</td>
                    <td>${b.name}</td>
                    <td>${b.email || '-'}</td>
                    <td>${validityStr}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="display:flex; gap:2px; justify-content:center;">
                            <button class="action-btn btn-edit" onclick="editBrand(${b.id})"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleBrandStatus(${b.id})"><i class="fas fa-power-off"></i> ${isActive?'تعطيل':'تفعيل'}</button>
                            ${resetBtn}
                            ${deleteBtn}
                        </div>
                    </td>
                </tr>`;
            });
        }

        function openBrandModal() {
            document.getElementById('brandForm').reset();
            document.getElementById('editBrandId').value = '';
            document.getElementById('brandModalTitle').innerText = 'إضافة براند جديد';
            document.getElementById('brandModal').style.display = 'flex';
        }

        function editBrand(id) {
            const b = DB.brands.find(x => x.id === id);
            if(b) {
                document.getElementById('editBrandId').value = b.id;
                document.getElementById('brandName').value = b.name;
                document.getElementById('brandEmail').value = b.email;
                document.getElementById('brandStartDate').value = b.startDate || '';
                document.getElementById('brandEndDate').value = b.endDate || '';
                document.getElementById('brandModalTitle').innerText = 'تعديل البراند';
                document.getElementById('brandModal').style.display = 'flex';
            }
        }

        function saveBrand() {
            const id = document.getElementById('editBrandId').value;
            const name = document.getElementById('brandName').value;
            const email = document.getElementById('brandEmail').value;
            const startDate = document.getElementById('brandStartDate').value;
            const endDate = document.getElementById('brandEndDate').value;

            if(!name) return alert('اسم البراند مطلوب');

            if(id) {
                const b = DB.brands.find(x => x.id == id);
                if(b) { 
                    b.name = name; 
                    b.email = email; 
                    b.startDate = startDate;
                    b.endDate = endDate;
                    addSystemLog('تعديل براند', name); 
                }
            } else {
                // New Brand is clean by default because no data has this ID yet
                DB.brands.push({
                    id: Date.now(), 
                    name: name, 
                    email: email, 
                    status: 'active',
                    startDate: startDate,
                    endDate: endDate
                });
                addSystemLog('إضافة براند', name);
            }
            saveDB();
            renderBrandsTable();
            updateBrandUI();
            closeModal('brandModal');
        }

        function toggleBrandStatus(id) {
            const b = DB.brands.find(x => x.id === id);
            if(b) {
                b.status = (b.status === 'active' ? 'inactive' : 'active');
                saveDB();
                renderBrandsTable();
                updateBrandUI();
                // If deactivated current brand, switch to default
                if(b.status === 'inactive' && CURRENT_BRAND.id === id) switchBrand(1);
            }
        }

        function deleteBrand(id) {
            if(confirm('هل أنت متأكد من حذف هذا البراند؟ سيتم إخفاء جميع البيانات المرتبطة به.')) {
                DB.brands = DB.brands.filter(x => x.id !== id);
                // Optionally cleanup data associated with deleted brand
                resetBrandData(id, true); // true = silent cleanup
                saveDB();
                renderBrandsTable();
                updateBrandUI();
                if(CURRENT_BRAND.id === id) switchBrand(1);
            }
        }

        function resetBrandData(brandId, silent = false) {
            if(!silent && !confirm('تحذير: سيتم مسح جميع البيانات والمدخلات والمستخدمين والتقارير الخاصة بهذا البراند بشكل نهائي.\nهل أنت متأكد؟')) return;
            
            const arraysToClean = [
                'senior', 'middle', 'teachers', 'departments',
                'visits_senior', 'visits_middle',
                'distinguished', 'care_needed', 'qualitative_reports', 'saved_reports'
            ];

            arraysToClean.forEach(key => {
                if(DB[key]) {
                    // Keep only items that do NOT match the brand ID
                    // OR keep default admin/global items if any
                    DB[key] = DB[key].filter(item => {
                        // Global Admin (id 999) should theoretically be in 'admins' array, 
                        // but if they slipped into 'senior', protect them:
                        if(item.id === 999) return true; 
                        
                        const itemBrand = item.brandId || 1; // Default assumption for legacy data
                        return itemBrand !== brandId;
                    });
                }
            });

            saveDB();
            if(!silent) alert('تمت إعادة تهيئة بيانات البراند بنجاح.');
            // Refresh current view if we are inside that brand
            if(CURRENT_BRAND.id === brandId) location.reload();
        }

        window.onload = function() { initSystem(); };

    </script>
</body>
</html>
