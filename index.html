<style>
    /* أنماط خاصة بتقرير الجودة لتطابق الصور المرفقة */
    .report-cover-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 100%;
        min-height: 950px; /* لضمان توزيع العناصر على كامل صفحة A4 */
        text-align: center;
    }

    .report-header-logos {
        width: 100%;
        display: flex;
        justify-content: center;
        margin-bottom: 40px;
    }

    .report-cover-box {
        background-color: #f2f2f2;
        border-radius: 20px;
        padding: 40px 60px;
        width: 80%;
        text-align: center;
        margin: 50px auto;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .report-cover-title {
        font-size: 24px;
        font-weight: bold;
        color: #000;
        margin-bottom: 25px;
        font-family: 'Cairo', sans-serif;
    }

    .report-school-name {
        font-size: 20px;
        font-weight: bold;
        color: #2e5cb8; /* أزرق */
        margin-bottom: 20px;
        font-family: 'Cairo', sans-serif;
    }

    .report-month {
        font-size: 18px;
        font-weight: bold;
        color: #da291c; /* أحمر */
        margin-bottom: 10px;
        text-decoration: underline;
        font-family: 'Cairo', sans-serif;
    }

    .report-year {
        font-size: 18px;
        font-weight: bold;
        color: #000;
        font-family: 'Cairo', sans-serif;
    }

    .report-signatures-cover {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        padding: 0 50px;
        margin-top: auto;
        margin-bottom: 50px;
    }

    .sig-block {
        text-align: center;
        font-weight: bold;
        font-family: 'Cairo', sans-serif;
    }
    
    .sig-name {
        margin-top: 40px;
        font-weight: normal; 
        font-family: 'Arial', sans-serif; /* لتمييز الاسم */
    }

    /* تنسيقات الصفحة الثانية (الجدول) */
    .page-title-underline {
        font-weight: bold;
        text-decoration: underline;
        margin-bottom: 15px;
        font-size: 16px;
        text-align: right;
    }

    .quality-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        direction: rtl;
    }

    .quality-table th {
        background-color: #bfbfbf; /* رمادي غامق للهيدر */
        color: #000;
        font-weight: bold;
        padding: 10px;
        border: 1px solid #000; /* حدود سوداء */
        text-align: center;
        vertical-align: middle;
    }

    .quality-table td {
        padding: 8px;
        border: 1px solid #000; /* حدود سوداء */
        text-align: center;
        vertical-align: middle;
        font-weight: bold;
    }

    .note-section {
        text-align: right;
        font-weight: bold;
        margin: 20px 0 40px 0;
        font-size: 14px;
        line-height: 1.6;
    }

    .stats-section {
        text-align: right;
        margin-top: 30px;
        font-size: 16px;
        font-weight: bold;
    }

    .report-footer-fixed {
        position: fixed;
        bottom: 10px;
        width: 100%;
        text-align: center;
    }
</style>

<script>
    // استبدل الدالة القديمة بهذه الدالة المحدثة
    function generateQualityReport() {
        const month = document.getElementById('reportMonthSelect').value;
        const monthName = getMonthName(month);
        const schoolName = DB.settings.schoolName || 'اسم المدرسة غير محدد';
        const schoolYear = DB.settings.schoolYear || '...';
        const ministryLogo = DB.settings.ministryLogo || ''; // شعار الوزارة
        const schoolStamp = DB.settings.schoolStamp || '';   // الختم
        const footerText = DB.settings.footer_text || '';
        
        // جلب أسماء الموقعين من الإعدادات
        const directorName = DB.settings.sig_director || '..................';
        const assistantName = DB.settings.sig_assistant || '..................';

        // تصفية الزيارات حسب الشهر المختار
        let seniorVisits = (DB.visits_senior || []).filter(v => v.date.split('-')[1] === month);
        let middleVisits = (DB.visits_middle || []).filter(v => v.date.split('-')[1] === month);
        
        // جلب قائمة القيادة الوسطى لبناء الجدول
        const middleLeaders = DB.middle || [];

        // --- الصفحة الأولى (الغلاف) ---
        let html = `
        <div class="a4-page">
            <div class="report-cover-page">
                
                <div class="report-header-logos">
                   ${ministryLogo ? `<img src="${ministryLogo}" style="max-height: 120px;">` : '<h2 style="color:#1e4078">وزارة التربية والتعليم</h2>'}
                </div>

                <div class="report-cover-box">
                    <div class="report-cover-title">تقرير متابعة جودة التعليم والتعلم للقيادة العليا والوسطى</div>
                    <div class="report-school-name">ل${schoolName}</div>
                    <div class="report-month">شهر ${monthName}</div>
                    <div class="report-year">العام الدراسي ${schoolYear}</div>
                </div>

                <div class="report-signatures-cover">
                    <div class="sig-block">
                        <div style="margin-bottom: 60px;">
                            ${schoolStamp ? `<img src="${schoolStamp}" style="width: 130px; opacity: 0.9;">` : ''}
                        </div>
                        <div>يعتمد، مديرة المدرسة</div>
                        <div class="sig-name">${directorName}</div>
                    </div>

                    <div class="sig-block">
                        <div style="height: 60px;"></div> <div>إعداد المديرة المساعدة</div>
                        <div class="sig-name">${assistantName}</div>
                    </div>
                </div>

                ${footerText ? `<div style="width:100%; border-top:1px solid #ccc; padding-top:10px; font-size:${DB.settings.footer_fontsize || 10}pt; text-align:${DB.settings.footer_align || 'center'};">${footerText}</div>` : ''}
            </div>
        </div>
        `;

        // فاصل صفحات للطباعة
        html += `<div style="page-break-before: always;"></div>`;

        // --- الصفحة الثانية (البيانات) ---
        html += `
        <div class="a4-page">
            <div class="page-title-underline">أولاً: متابعة تسليم القيادة الوسطى (الزيارات/محاضر الاجتماعات /الخطة الأسبوعية) للمواد الدراسية الى المدير/ة المساعد/ة في المدرسة</div>

            <table class="quality-table">
                <thead>
                    <tr>
                        <th rowspan="2" width="20%" style="background-color:#bfbfbf;">القسم</th>
                        <th colspan="3" style="background-color:#bfbfbf;">متابعة القيادة العليا للقيادة الوسطى</th>
                        <th rowspan="2" width="20%" style="background-color:#bfbfbf;">أسباب عدم التسليم</th>
                    </tr>
                    <tr>
                        <th width="15%" style="background-color:#bfbfbf;">عدد استمارات الزيارات الصفية التي نُفذت من قبل المعلم الأول أو المنسق خلال الشهر</th>
                        <th width="20%" style="background-color:#bfbfbf;">يوجد محضر اجتماع المعلم الأول أو المنسق مع المعلمين</th>
                        <th width="20%" style="background-color:#bfbfbf;">توجد خطة أسبوعية للمعلم الأول أو المنسق</th>
                    </tr>
                </thead>
                <tbody>`;

        // توليد الصفوف بناءً على مستخدمي القيادة الوسطى
        if (middleLeaders.length > 0) {
            middleLeaders.forEach(leader => {
                // حساب عدد الزيارات لهذا القائد في الشهر المحدد
                // نفترض أن اسم الزائر هو اسم المستخدم في النظام
                const visitCount = middleVisits.filter(v => v.visitor === leader.name).length;
                
                // نفترض وجود الخطة والمحضر افتراضياً كما في الصورة (يوجد)
                // اسم القسم يظهر بناءً على الوظيفة (Job)
                const roleName = leader.job || leader.name;

                html += `
                    <tr>
                        <td style="font-weight:bold;">${roleName}</td>
                        <td>${visitCount}</td>
                        <td>يوجد</td>
                        <td>يوجد</td>
                        <td></td>
                    </tr>
                `;
            });
        } else {
            // صف فارغ في حال عدم وجود بيانات
            html += `<tr><td colspan="5">لا يوجد مستخدمين مسجلين في القيادة الوسطى</td></tr>`;
        }

        html += `
                </tbody>
            </table>

            <div class="note-section">
                ملاحظات عامة: يتم التنسيق مع القيادة الوسطى لتنفيذ الزيارات الصفية بحسب ما يتناسب مع ظروف الجداول والنصاب المسند لهم.
            </div>

            <div style="margin-top: 50px;">
                <div class="page-title-underline">ثانياً: عدد الزيارات التي نُفذت خلال شهر ${monthName} من قبل:</div>
                <div class="stats-section">
                    <div style="margin-bottom: 10px;">1- القيادة العليا = ${seniorVisits.length} زيارة</div>
                    <div>2- القيادة الوسطى = ${middleVisits.length} زيارة</div>
                </div>
            </div>

             <div style="position: absolute; bottom: 15mm; left: 15mm; right: 15mm;">
                ${footerText ? `<div style="width:100%; border-top:1px solid #ccc; padding-top:10px; font-size:${DB.settings.footer_fontsize || 10}pt; text-align:${DB.settings.footer_align || 'center'};">${footerText}</div>` : ''}
            </div>
        </div>
        `;

        document.getElementById('a4-report-content').innerHTML = html;
    }
</script>
