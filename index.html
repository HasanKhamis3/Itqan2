<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام ارتقاء | Irteqaa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&family=Tajawal:wght@400;500;700;800&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { 
            --primary: #2b579a; 
            --primary-dark: #1e4078;
            --accent: #dcae1d;
            --text: #333; 
            --bg: #f4f7fa; 
            --danger: #dc3545; 
            --success: #28a745; 
            --warning: #ffc107; 
            --info: #17a2b8;
            --disabled: #e9ecef; 
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        /* === Layout === */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; box-shadow: -2px 0 15px rgba(0,0,0,0.03); }
        
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 15px; align-items: center; justify-content: center; }
        .logo-group { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; line-height: 1; }
        .logo-ar { font-size: 2rem; font-weight: 800; color: var(--primary); font-family: 'Tajawal', sans-serif; letter-spacing: -0.5px; }
        .logo-en { font-size: 0.8rem; font-weight: 500; color: #888; font-family: 'Poppins', sans-serif; letter-spacing: 2px; margin-top: 4px; text-transform: uppercase; }
        .sidebar-icon { font-size: 2.4rem; color: var(--primary); }

        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: block; } 
        #nav-system-admin { display: none; }
        
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #666; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f7ff; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 12px; width: 25px; text-align: center; font-size: 1.1rem; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; overflow-x: hidden; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: var(--shadow); border: 1px solid #eee; }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        /* === LOGIN PAGE === */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #1e4078 0%, #0d1b33 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 30px 30px; }
        .login-box { background: rgba(255, 255, 255, 0.98); padding: 50px 45px; border-radius: 24px; width: 440px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .login-logo-container { margin-bottom: 35px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .login-logo-icon { font-size: 3.5rem; color: var(--primary); margin-bottom: 5px; }
        .login-brand-group { line-height: 1; }
        .login-brand-ar { font-size: 2.4rem; font-weight: 800; color: var(--primary); font-family: 'Tajawal', sans-serif; }
        .login-brand-en { font-size: 1rem; font-weight: 500; color: #666; font-family: 'Poppins', sans-serif; letter-spacing: 3px; margin-top: 5px; text-transform: uppercase; }
        .login-divider { height: 4px; width: 50px; background: var(--accent); border-radius: 2px; margin: 0 auto 35px auto; }
        .input-group-modern { position: relative; margin-bottom: 25px; text-align: right; }
        .input-group-modern i { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #b0b0b0; transition: 0.3s; z-index: 2; font-size: 1.1rem; }
        .input-group-modern .form-control { padding: 16px 50px 16px 15px; border-radius: 12px; border: 2px solid #eef2f7; background: #f8fafc; font-size: 1rem; transition: all 0.3s ease; width: 100%; color: #333; font-weight: 600; }
        .input-group-modern .form-control::placeholder { color: #aaa; font-weight: normal; }
        .input-group-modern .form-control:focus { border-color: var(--primary); background: #fff; box-shadow: 0 4px 15px rgba(30, 64, 120, 0.08); outline: none; }
        .input-group-modern .form-control:focus + i { color: var(--primary); }
        .btn-login { background: linear-gradient(135deg, var(--primary) 0%, #29539b 100%); color: white; width: 100%; padding: 16px; border-radius: 12px; font-size: 1.15rem; font-weight: 700; margin-top: 15px; border: none; cursor: pointer; box-shadow: 0 10px 25px rgba(30, 64, 120, 0.25); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-login:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(30, 64, 120, 0.35); background: linear-gradient(135deg, #244c8a 0%, #1e4078 100%); }
        .login-error-msg { background-color: #fff2f2; color: #d63031; border: 1px solid #ffdede; padding: 15px; border-radius: 10px; margin-top: 25px; font-size: 0.9rem; line-height: 1.6; display: none; text-align: center; font-weight: 600; animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        /* General Forms & Components */
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        .form-control:disabled { background-color: var(--disabled); cursor: not-allowed; color: #666; }
        textarea.form-control { resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; display: inline-flex; align-items: center; gap: 6px;}
        .btn-primary { background: var(--primary); color: white; }
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: var(--shadow); }
        .section-card.active { display: block; }

        /* Dashboard & Charts */
        .dashboard-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.04); border: 1px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; overflow: hidden; transition: transform 0.2s; }
        .stat-card.blue { border-bottom: 4px solid var(--primary); }
        .stat-info h3 { font-size: 2rem; margin: 10px 0 5px 0; font-weight: 700; color: #333; }
        .stat-icon-bg { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 10px; }
        .bg-light-blue { background: #eef4ff; color: var(--primary); }
        .dashboard-charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 992px) { .dashboard-charts-row { grid-template-columns: 1fr; } }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.04); overflow: hidden; }

        /* Tabs */
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* Tables */
        .table-responsive { width: 100%; overflow-x: auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #edf2f9; margin-bottom: 20px; }
        .custom-table { width: 100%; border-collapse: collapse; margin: 0; }
        .custom-table th { background: var(--primary); color: white; padding: 15px 12px; text-align: center; font-weight: 700; font-size: 0.95rem; border-left: 1px solid rgba(255,255,255,0.15); white-space: nowrap; }
        .custom-table th:last-child { border-left: none; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #edf2f9; border-left: 1px solid #edf2f9; background: white; text-align: center; vertical-align: middle; font-size: 0.9rem; color: #444; }
        .custom-table td:last-child { border-left: none; }
        .custom-table tbody tr:hover td { background-color: #f8fafc; }
        .custom-table tbody tr:last-child td { border-bottom: none; }
        
        /* Badges */
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-block; min-width: 60px; }
        .status-active { background-color: #d1f2e5; color: #0d6832; } 
        .status-inactive { background-color: #f8d7da; color: #721c24; }
        
        /* Action Buttons */
        .action-btn { padding: 6px 12px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.85rem; margin: 2px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; font-weight: 700; font-family: 'Cairo', sans-serif; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: var(--info); }
        .btn-edit:hover { background: #138496; }
        .btn-toggle { background: var(--success); }
        .btn-toggle:hover { background: #218838; }
        .btn-toggle.off { background: #6c757d; }
        .btn-reset { background: var(--warning); color:#333; }
        .btn-reset:hover { background: #e0a800; }
        .btn-delete { background: var(--danger); padding: 6px 10px; }
        .btn-delete:hover { background: #c82333; }
        .btn-perm { background: #343a40; }
        .btn-move { background: #6c757d; padding: 6px 8px; } 
        .action-btn:hover { transform: translateY(-1px); }

        /* Modals & Utils */
        .filter-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; flex-wrap: wrap; }
        .filter-label { font-weight: bold; color: #555; }
        .filter-select { padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; outline: none; min-width: 200px; font-weight: bold; color: var(--primary); }
        .custom-date-box { display: none; align-items: center; gap: 10px; background: #eef4ff; padding: 5px 10px; border-radius: 6px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* A4 Report Styling */
        .report-preview-container { background: #525659; padding: 30px; overflow: auto; max-height: 800px; display: flex; flex-direction: column; align-items: center; border-radius: 8px;}
        #a4-report-content { transition: transform 0.2s ease; transform-origin: top center; }
        .a4-page { background: white; width: 210mm; min-height: 297mm; padding: 15mm; padding-bottom: 35mm; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.5); margin-bottom: 20px; position: relative; color: black; font-family: 'Cairo', sans-serif; page-break-after: always; }
        .a4-page:last-child { page-break-after: auto; }
        .report-table-custom { width:100%; border-collapse:collapse; margin-bottom:20px; font-size:14px; page-break-inside: avoid; }
        .report-table-custom th, .report-table-custom td { border:1px solid black; padding:8px; text-align:center; vertical-align:middle; }
        .report-table-custom th { background-color:#bfbfbf; font-weight:bold; }
        .align-right { text-align: right !important; }
        .bold-col { font-weight:bold; }
        .report-header-box { background-color: #000; color: #fff; padding: 10px; text-align: center; font-weight: bold; }
        .report-sub-header { background-color: #bfbfbf; padding: 8px; font-weight: bold; border: 1px solid #000; text-align: center; }
        .report-row-summary { background-color: #bfbfbf; font-weight: bold; }
        .report-row-total { background-color: #b4c6e7; font-weight: bold; }
        .report-list { text-align: right; padding-right: 20px; margin: 0; }
        .report-list li { margin-bottom: 5px; }
        
        .saved-report-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; display: flex; gap: 20px; align-items: center; background: #fff; margin-bottom: 15px; transition: 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .saved-report-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); transform: translateY(-2px); border-color: var(--primary); }
        .saved-report-thumb { width: 60px; height: 80px; background: #eef4ff; border: 1px solid #d0dff2; display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--primary); border-radius: 4px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .saved-report-details { flex: 1; }
        .saved-report-actions { display: flex; gap: 8px; flex-wrap: wrap; }

        @media print {
            body, html { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background: white !important; }
            body * { visibility: hidden; }
            #a4-report-content, #a4-report-content * { visibility: visible; }
            #a4-report-content { position: absolute; left: 0; top: 0; width: 100%; transform: scale(1) !important; }
            @page { size: A4 portrait; margin: 5mm; }
            .a4-page { position: relative; left: 0; top: 0; margin: 0 auto; padding: 15mm !important; padding-bottom: 35mm !important; width: 210mm !important; min-height: 297mm !important; box-shadow: none !important; box-sizing: border-box !important; page-break-after: always; }
            .sidebar, .top-header, .filter-container, .btn, .custom-tabs { display: none !important; }
            .report-preview-container { background: white !important; padding: 0 !important; overflow: visible !important; max-height: none !important; border:none !important; display: block !important;}
        }

        /* Settings CSS Aesthetics Enhancements */
        .setting-content-pane { display: none; animation: fadeIn 0.3s; }
        .setting-content-pane.active { display: block; }
        .settings-card-wrapper { background: #fff; border: 1px solid #edf2f9; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .settings-card-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; border-bottom: 2px solid #f0f4f8; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .settings-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        .upload-container { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #fcfcfc; position: relative; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;}
        .upload-container:hover { border-color: var(--primary); background-color: #f0f4f8; }
        .upload-btn-custom { background-color: #28a745; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; margin-top: 10px;}
        .image-preview-wrapper { margin-top: 15px; position: relative; display: inline-block; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .image-preview { max-width: 200px; max-height: 100px; display: block; cursor: pointer; }
        
        .visitor-list { list-style: none; padding: 0; margin: 0; }
        .visitor-list-item { background: #f8fafc; border: 1px solid #eef2f7; border-radius: 8px; padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #444; transition: 0.2s; }
        .visitor-list-item:hover { transform: translateX(-5px); border-color: var(--primary); }
        .perf-chart-container { background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #edf2f9; margin-top: 20px; }

        .brand-switcher-container { margin-left: 15px; position: relative; }
        .brand-btn { background: #f0f4f8; color: var(--primary); border: 1px solid #ddd; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; min-width: 180px; justify-content: space-between; }
        .brand-dropdown { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; z-index: 1000; display: none; margin-top: 5px; }
        .brand-dropdown.show { display: block; animation: fadeIn 0.2s; }
        .brand-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .brand-item:hover { background: #f8f9fa; color: var(--primary); }
        .brand-item.active { background: #eef4ff; color: var(--primary); font-weight: bold; border-right: 3px solid var(--primary); }

    </style>
</head>
<body>

    <canvas id="tempChartCanvas" width="800" height="400" style="display:none;"></canvas>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <div class="login-logo-container">
                <i class="fas fa-graduation-cap login-logo-icon"></i>
                <div class="login-brand-group"><div class="login-brand-ar">ارتقاء</div><div class="login-brand-en">Irteqaa</div></div>
            </div>
            <div class="login-divider"></div>
            <form id="loginForm" onsubmit="login(event)">
                <div class="input-group-modern"><input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required><i class="fas fa-user"></i></div>
                <div class="input-group-modern"><input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required><i class="fas fa-eye password-icon" style="cursor: pointer;" onclick="togglePass('loginPass', this)"></i></div>
                <button type="submit" class="btn btn-login">تسجيل الدخول</button>
                <div id="loginError" class="login-error-msg"></div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header"><i class="fas fa-graduation-cap sidebar-icon"></i><div class="logo-group"><span class="logo-ar">ارتقاء</span><span class="logo-en">Irteqaa</span></div></div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-performance"><a onclick="navigate('performance')" data-page="performance"><i class="fas fa-chart-line"></i> تقييم الأداء</a></li>
                <li id="nav-distinguished"><a onclick="navigate('distinguished')" data-page="distinguished"><i class="fas fa-star"></i> المعلمين المتميزين</a></li>
                <li id="nav-qualitative"><a onclick="navigate('qualitative')" data-page="qualitative"><i class="fas fa-file-alt"></i> التقرير النوعي</a></li>
                <li id="nav-quality-report"><a onclick="navigate('quality-report')" data-page="quality-report"><i class="fas fa-file-word"></i> تقرير جودة التعليم</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-system-admin"><a onclick="navigate('system-admin')" data-page="system-admin"><i class="fas fa-shield-alt"></i> إعدادات مدير النظام</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div style="display:flex; align-items:center;">
                    <h2 id="pageTitle" style="margin-left:20px;">...</h2>
                    <div class="brand-switcher-container">
                        <button class="brand-btn" onclick="toggleBrandDropdown()"><span id="currentBrandLabel">الجهة الافتراضية</span><i class="fas fa-chevron-down"></i></button>
                        <div id="brandDropdown" class="brand-dropdown"></div>
                    </div>
                </div>
                <div class="user-profile">
                    <div class="user-info-text"><span id="headerUserName" class="user-name">المستخدم</span><span id="headerUserJob" class="user-job">الوظيفة</span></div>
                    <button class="btn" style="background:#eee; padding:8px 12px; border-radius:50%;" onclick="logout()" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active">
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> عرض البيانات حسب:</label>
                    <select id="dashMonthFilter" class="filter-select" onchange="handleDateFilterChange('dash', renderDashboard)"></select>
                    <div id="dash_CustomDateInputs" class="custom-date-box">
                        <span>من:</span><input type="date" id="dash_StartDate" class="form-control" style="width:140px; margin:0;">
                        <span>إلى:</span><input type="date" id="dash_EndDate" class="form-control" style="width:140px; margin:0;">
                        <button class="btn btn-primary" style="padding:5px 15px; width:auto;" onclick="renderDashboard()">بحث</button>
                    </div>
                </div>
                <div class="dashboard-stats-grid">
                     <div class="stat-card blue"><div class="stat-info"><h3 id="stat_total">0</h3><p>إجمالي الزيارات الصفية</p></div><div class="stat-icon-bg bg-light-blue"><i class="fas fa-clipboard-check"></i></div></div>
                    <div class="stat-card purple"><div class="stat-info"><h3 id="stat_exceeds_lot">0</h3><p>يتجاوز التوقعات بكثير</p></div><div class="stat-icon-bg bg-light-purple"><i class="fas fa-star"></i></div></div>
                     <div class="stat-card green"><div class="stat-info"><h3 id="stat_exceeds">0</h3><p>يتجاوز التوقعات</p></div><div class="stat-icon-bg bg-light-green"><i class="fas fa-check-double"></i></div></div>
                    <div class="stat-card orange"><div class="stat-info"><h3 id="stat_meets">0</h3><p>يفي بالتوقعات</p></div><div class="stat-icon-bg bg-light-orange"><i class="fas fa-check"></i></div></div>
                    <div class="stat-card red"><div class="stat-info"><h3 id="stat_partially">0</h3><p>يفي بالتوقعات جزئيا</p></div><div class="stat-icon-bg bg-light-red"><i class="fas fa-exclamation"></i></div></div>
                </div>
                <div class="dashboard-charts-row">
                    <div class="chart-box"><div class="chart-title"><span>توزيع الزيارات حسب الأقسام</span><i class="fas fa-chart-bar" style="color:#aaa;"></i></div><div style="position: relative; height: 250px; width: 100%;"><canvas id="dashBarChart"></canvas></div></div>
                    <div class="chart-box"><div class="chart-title"><span>نسب التقييم</span><i class="fas fa-chart-pie" style="color:#aaa;"></i></div><div style="position: relative; height: 250px; width: 100%;"><canvas id="dashPieChart"></canvas></div></div>
                </div>
            </div>
            
            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">سجل الزيارات الصفية</h3>
                    <div style="display:flex; gap:10px;">
                        <button id="btnAddVisit" class="btn btn-primary btn-restricted" style="width:auto;" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة جديدة</button>
                        <button class="btn admin-only-btn" style="background:#17a2b8; color:white; display:none;" onclick="exportSpecificExcel('visits')"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
                        <button class="btn admin-only-btn" style="background:#28a745; color:white; display:none;" onclick="triggerImportExcelGeneric('visits')"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
                    </div>
                </div>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> عرض البيانات حسب:</label>
                    <select id="visitMonthFilter" class="filter-select" onchange="handleDateFilterChange('visit', renderVisitsTable)"></select>
                    <div id="visit_CustomDateInputs" class="custom-date-box">
                        <span>من:</span><input type="date" id="visit_StartDate" class="form-control" style="width:140px; margin:0;">
                        <span>إلى:</span><input type="date" id="visit_EndDate" class="form-control" style="width:140px; margin:0;">
                        <button class="btn btn-primary" style="padding:5px 15px; width:auto;" onclick="renderVisitsTable()">بحث</button>
                    </div>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">زيارات القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">زيارات القيادة الوسطى</div>
                </div>
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead><tr><th width="12%">التاريخ</th><th width="12%">القسم</th><th width="18%">اسم المعلمة</th><th width="15%">التقييم</th><th width="15%">الزائر</th><th width="10%">الوظيفة</th><th width="18%">الإجراءات</th></tr></thead>
                        <tbody id="visitsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="performance" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">تقييم الأداء الصفي</h3>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> عرض البيانات حسب:</label>
                    <select id="perfMonthFilter" class="filter-select" onchange="handleDateFilterChange('perf', renderPerformanceChart)"></select>
                    <div id="perf_CustomDateInputs" class="custom-date-box">
                        <span>من:</span><input type="date" id="perf_StartDate" class="form-control" style="width:140px; margin:0;">
                        <span>إلى:</span><input type="date" id="perf_EndDate" class="form-control" style="width:140px; margin:0;">
                        <button class="btn btn-primary" style="padding:5px 15px; width:auto;" onclick="renderPerformanceChart()">بحث</button>
                    </div>
                </div>
                <div class="perf-chart-container">
                    <canvas id="perfChart" width="400" height="150"></canvas>
                </div>
            </div>

            <div id="distinguished" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">المعلمين المتميزين والأولى بالرعاية</h3>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> عرض البيانات حسب:</label>
                    <select id="distMonthFilter" class="filter-select" onchange="handleDateFilterChange('dist', renderDistinguishedTables)"></select>
                    <div id="dist_CustomDateInputs" class="custom-date-box">
                        <span>من:</span><input type="date" id="dist_StartDate" class="form-control" style="width:140px; margin:0;">
                        <span>إلى:</span><input type="date" id="dist_EndDate" class="form-control" style="width:140px; margin:0;">
                        <button class="btn btn-primary" style="padding:5px 15px; width:auto;" onclick="renderDistinguishedTables()">بحث</button>
                    </div>
                </div>
                <div style="margin-bottom:20px;">
                    <button class="btn btn-restricted" style="background:#2c5aa0; color:white; width:auto;" onclick="openDistinguishedModal('distinguished')"><i class="fas fa-plus-circle"></i> إضافة معلم متميز</button>
                    <button class="btn btn-restricted" style="background:#da291c; color:white; width:auto;" onclick="openDistinguishedModal('care')"><i class="fas fa-plus-circle"></i> إضافة معلم يحتاج رعاية</button>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="font-weight:bold; color:var(--primary);">المعلمين المتميزين</div>
                    <div>
                        <button class="btn btn-sm btn-delete" style="width:auto; padding:5px 10px;" onclick="deleteSelectedDistinguished('distinguished')"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <span class="admin-only-btn" style="display:none;"><button class="btn btn-sm" style="background:#17a2b8; color:white; width:auto; padding:5px 10px;" onclick="exportSpecificExcel('distinguished')"><i class="fas fa-file-excel"></i> تصدير</button><button class="btn btn-sm" style="background:#28a745; color:white; width:auto; padding:5px 10px;" onclick="triggerImportExcelGeneric('distinguished')"><i class="fas fa-file-excel"></i> استيراد</button></span>
                    </div>
                </div>
                <div class="table-responsive"><table class="custom-table"><thead><tr><th width="5%"><input type="checkbox" id="selectAllDist" class="custom-checkbox" onchange="toggleSelectAllDist('distinguished', this)"></th><th width="5%">#</th><th width="15%">التاريخ</th><th width="20%">اسم المعلم/ة</th><th width="15%">القسم الأكاديمي</th><th width="10%">التقدير</th><th width="20%">المبررات</th><th width="10%">الإجراءات</th></tr></thead><tbody id="distinguishedTableBody"></tbody></table></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:40px; margin-bottom:10px;">
                    <div style="font-weight:bold; color:var(--primary);">المعلمين الأولى بالرعاية</div>
                    <div>
                        <button class="btn btn-sm btn-delete" style="width:auto; padding:5px 10px;" onclick="deleteSelectedDistinguished('care_needed')"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <span class="admin-only-btn" style="display:none;"><button class="btn btn-sm" style="background:#17a2b8; color:white; width:auto; padding:5px 10px;" onclick="exportSpecificExcel('care')"><i class="fas fa-file-excel"></i> تصدير</button><button class="btn btn-sm" style="background:#28a745; color:white; width:auto; padding:5px 10px;" onclick="triggerImportExcelGeneric('care')"><i class="fas fa-file-excel"></i> استيراد</button></span>
                    </div>
                </div>
                <div class="table-responsive"><table class="custom-table"><thead><tr><th width="5%"><input type="checkbox" id="selectAllCare" class="custom-checkbox" onchange="toggleSelectAllDist('care_needed', this)"></th><th width="5%">#</th><th width="15%">التاريخ</th><th width="20%">اسم المعلم/ة</th><th width="15%">القسم الأكاديمي</th><th width="10%">التقدير</th><th width="20%">المبررات</th><th width="10%">الإجراءات</th></tr></thead><tbody id="careTableBody"></tbody></table></div>
            </div>

            <div id="qualitative" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">التقرير النوعي</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary btn-restricted" style="width:auto;" onclick="openQualitativeModal()"><i class="fas fa-plus"></i> إضافة تقرير</button>
                        <button class="btn admin-only-btn" style="background:#17a2b8; color:white; display:none;" onclick="exportSpecificExcel('qualitative')"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
                        <button class="btn admin-only-btn" style="background:#28a745; color:white; display:none;" onclick="triggerImportExcelGeneric('qualitative')"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
                    </div>
                </div>
                <div class="filter-container">
                    <label class="filter-label"><i class="fas fa-calendar-alt"></i> عرض البيانات حسب:</label>
                    <select id="qualMonthFilter" class="filter-select" onchange="handleDateFilterChange('qual', renderQualitativeTable)"></select>
                    <div id="qual_CustomDateInputs" class="custom-date-box">
                        <span>من:</span><input type="date" id="qual_StartDate" class="form-control" style="width:140px; margin:0;">
                        <span>إلى:</span><input type="date" id="qual_EndDate" class="form-control" style="width:140px; margin:0;">
                        <button class="btn btn-primary" style="padding:5px 15px; width:auto;" onclick="renderQualitativeTable()">بحث</button>
                    </div>
                </div>
                <div class="table-responsive"><table class="custom-table"><thead><tr><th width="5%">#</th><th width="15%">التاريخ</th><th width="15%">الأقسام الأكاديمية</th><th width="25%">جوانب القوة</th><th width="25%">جوانب بحاجة إلى تطوير</th><th width="15%">الإجراءات</th></tr></thead><tbody id="qualitativeTableBody"></tbody></table></div>
            </div>

            <div id="quality-report" class="section-card">
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="window.setReportTab('create', this)">إنشاء تقرير</div>
                    <div class="custom-tab" onclick="window.setReportTab('saved', this)">سجل التقارير المحفوظة</div>
                </div>
                <div id="report-create-pane">
                    <div class="filter-container" style="justify-content: space-between;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label class="filter-label">شهر التقرير:</label>
                            <select id="reportMonthSelect" class="filter-select">
                                <option value="01">يناير</option><option value="02">فبراير</option><option value="03">مارس</option><option value="04">أبريل</option><option value="05">مايو</option><option value="06">يونيو</option><option value="07">يوليو</option><option value="08">أغسطس</option><option value="09">سبتمبر</option><option value="10">أكتوبر</option><option value="11">نوفمبر</option><option value="12">ديسمبر</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateQualityReport()"><i class="fas fa-magic"></i> إصدار التقرير</button>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div style="display:flex; align-items:center; background:#f0f4f8; padding:5px 10px; border-radius:6px; gap:8px; border:1px solid #ddd; margin-left: 10px;">
                                <button class="btn" style="padding:4px 8px; background:white; color:var(--primary);" onclick="window.zoomReport(0.1)" title="تكبير"><i class="fas fa-search-plus"></i></button>
                                <span id="zoomLevelDisplay" style="font-weight:bold; color:var(--primary); min-width:45px; text-align:center;">100%</span>
                                <button class="btn" style="padding:4px 8px; background:white; color:var(--primary);" onclick="window.zoomReport(-0.1)" title="تصغير"><i class="fas fa-search-minus"></i></button>
                            </div>
                            <button class="btn btn-view" onclick="printReport()"><i class="fas fa-print"></i> طباعة</button>
                            <button class="btn btn-edit" onclick="exportToWord()"><i class="fas fa-file-word"></i> تصدير Word</button>
                            <button class="btn btn-toggle" onclick="saveReport()"><i class="fas fa-save"></i> حفظ</button>
                        </div>
                    </div>
                    <div class="report-preview-container">
                        <div id="a4-report-content">
                            <div class="a4-page">
                                <div style="text-align:center; padding:50px; color:#888;">
                                    <i class="fas fa-file-alt" style="font-size:4rem; margin-bottom:20px; display:block;"></i>
                                    يرجى اختيار الشهر والضغط على "إصدار التقرير" لعرض النتائج هنا.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="report-saved-pane" style="display:none;"><div id="savedReportsList"></div></div>
            </div>

            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <h3>إدارة المستخدمين</h3>
                    <div id="userActionButtons" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button id="addBtnMain" class="btn btn-primary" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                        <button class="btn" style="background:#17a2b8; color:white;" onclick="exportExcel()"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
                        <button class="btn" style="background:#28a745; color:white;" onclick="triggerImportExcel()"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
                        <button class="btn" style="background:#dc3545; color:white;" onclick="deleteSelected()"><i class="fas fa-trash"></i> حذف المحدد</button>
                        <button class="btn" style="background:#6c757d; color:white;" onclick="toggleStatusSelected()"><i class="fas fa-toggle-on"></i> تفعيل/إلغاء المحدد</button>
                        <button id="bulkPermBtn" class="btn" style="background:#343a40; color:white;" onclick="openBulkPerms()"><i class="fas fa-key"></i> صلاحيات المحدد</button>
                        <input type="file" id="importExcelInput" hidden accept=".xlsx, .xls, .csv" onchange="handleExcelImport(this)">
                         <input type="file" id="importExcelGenericInput" hidden accept=".xlsx, .xls, .csv" onchange="handleExcelImportGeneric(this)">
                    </div>
                    <div id="noEditPermissionMsg" style="display:none; color:red; font-weight:bold;">(وضع القراءة فقط)</div>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                    <div class="custom-tab" onclick="setTab('academic_departments', this)">الأقسام الأكاديمية</div>
                </div>
                <div class="table-responsive"><table class="custom-table"><thead><tr id="tableHeadRow"></tr></thead><tbody id="usersTableBody"></tbody></table></div>
            </div>
            
            <div id="system-admin" class="section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="color:var(--primary);">إعدادات مدير النظام (إدارة البراندات)</h3>
                    <button class="btn btn-primary" style="width:auto;" onclick="openBrandModal()"><i class="fas fa-plus"></i> إضافة براند جديد</button>
                </div>
                <div class="table-responsive"><table class="custom-table"><thead><tr><th width="5%">#</th><th width="30%">اسم البراند (الجهة)</th><th width="20%">البريد الإلكتروني</th><th width="15%">مدة الصلاحية</th><th width="10%">الحالة</th><th width="20%" style="text-align:right;">الإجراءات</th></tr></thead><tbody id="brandsTableBody"></tbody></table></div>
            </div>

            <div id="settings" class="section-card">
                <h3 style="color:var(--primary); margin-bottom:20px;">الإعدادات</h3>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="window.setSettingTab('gen', this)">الإعدادات العامة</div>
                    <div class="custom-tab" onclick="window.setSettingTab('sig', this)">إعدادات التوقيعات</div>
                    <div class="custom-tab" onclick="window.setSettingTab('fot', this)">إعدادات التذييل</div>
                    <div class="custom-tab" onclick="window.setSettingTab('eval', this)">إعدادات التقييم</div>
                    <div class="custom-tab" onclick="window.setSettingTab('vis', this)">ترتيب الزوار</div>
                    <div class="custom-tab" onclick="window.setSettingTab('log', this)">سجل النظام</div>
                </div>

                <div id="gen" class="setting-content-pane active">
                    <div class="settings-card-wrapper">
                        <div class="settings-card-title"><i class="fas fa-school"></i> بيانات المدرسة</div>
                        <div class="settings-grid-2">
                            <div class="form-group">
                                <label style="font-weight:bold; margin-bottom:5px; display:block;">اسم المدرسة</label>
                                <input type="text" id="confSchool" class="form-control" placeholder="أدخل اسم المدرسة">
                            </div>
                            <div class="form-group">
                                <label style="font-weight:bold; margin-bottom:5px; display:block;">العام الدراسي</label>
                                <input type="text" id="confYear" class="form-control" placeholder="مثال: 2025 / 2026م">
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-card-wrapper">
                        <div class="settings-card-title"><i class="fas fa-images"></i> الشعارات والأختام</div>
                        <div class="settings-grid-3">
                            <div class="upload-container">
                                <label class="upload-label">شعار الوزارة</label>
                                <input type="file" id="file_ministry" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_ministry', 'ministryLogo')">
                                <div class="upload-btn-wrapper" id="btn_wrap_ministry">
                                    <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_ministry')"><i class="fas fa-upload"></i> تحميل شعار الوزارة</button>
                                </div>
                                <div id="preview_wrap_ministry" style="display:none;" class="image-preview-wrapper"><img id="preview_ministry" class="image-preview" onclick="openImageModal(this.src)"><button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_ministry', 'ministryLogo', 'file_ministry')"><i class="fas fa-times"></i></button></div>
                            </div>
                            <div class="upload-container">
                                <label class="upload-label">شعار المدرسة</label>
                                <input type="file" id="file_school" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_school', 'schoolLogo')">
                                <div class="upload-btn-wrapper" id="btn_wrap_school">
                                    <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_school')"><i class="fas fa-upload"></i> تحميل شعار المدرسة</button>
                                </div>
                                <div id="preview_wrap_school" style="display:none;" class="image-preview-wrapper"><img id="preview_school" class="image-preview" onclick="openImageModal(this.src)"><button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_school', 'schoolLogo', 'file_school')"><i class="fas fa-times"></i></button></div>
                            </div>
                            <div class="upload-container">
                                <label class="upload-label">ختم المدرسة</label>
                                <input type="file" id="file_stamp" hidden accept="image/*" onchange="handleFileUpload(this, 'preview_stamp', 'schoolStamp')">
                                <div class="upload-btn-wrapper" id="btn_wrap_stamp">
                                    <button type="button" class="upload-btn-custom setting-edit-btn" onclick="triggerFileSelect('file_stamp')"><i class="fas fa-upload"></i> تحميل ختم المدرسة</button>
                                </div>
                                <div id="preview_wrap_stamp" style="display:none;" class="image-preview-wrapper"><img id="preview_stamp" class="image-preview" onclick="openImageModal(this.src)"><button class="remove-img-btn setting-edit-btn" onclick="removeImage('preview_stamp', 'schoolStamp', 'file_stamp')"><i class="fas fa-times"></i></button></div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: left; border-top: 1px solid #eee; padding-top: 20px;"><button class="btn btn-primary setting-edit-btn" style="width: 200px;" onclick="saveGeneralSettings()"><i class="fas fa-save"></i> حفظ الإعدادات العامة</button></div>
                </div>

                <div id="sig" class="setting-content-pane">
                    <div class="settings-card-wrapper">
                        <div class="settings-card-title"><i class="fas fa-signature"></i> إعدادات التوقيعات (تظهر في أسفل التقارير)</div>
                        <div class="settings-grid-2">
                            <div class="form-group" style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #eef2f7;">
                                <label style="font-weight:bold; margin-bottom:10px; display:block; color:var(--primary);"><i class="fas fa-user-tie"></i> مدير/ة المدرسة</label>
                                <select id="sig_director" class="form-control" onchange="renderSignatureOptions()"><option value="">اختر مدير المدرسة</option></select>
                                <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                                    <button class="btn btn-toggle setting-edit-btn" onclick="saveSignatureSettings()"><i class="fas fa-check"></i> حفظ</button>
                                    <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="clearSignature('sig_director')"><i class="fas fa-times"></i> إزالة</button>
                                </div>
                            </div>
                            <div class="form-group" style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #eef2f7;">
                                <label style="font-weight:bold; margin-bottom:10px; display:block; color:var(--primary);"><i class="fas fa-user"></i> المدير/ة المساعد/ة</label>
                                <select id="sig_assistant" class="form-control" onchange="renderSignatureOptions()"><option value="">اختر المدير المساعد</option></select>
                                <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                                    <button class="btn btn-toggle setting-edit-btn" onclick="saveSignatureSettings()"><i class="fas fa-check"></i> حفظ</button>
                                    <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="clearSignature('sig_assistant')"><i class="fas fa-times"></i> إزالة</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="fot" class="setting-content-pane">
                    <div class="settings-card-wrapper">
                        <div class="settings-card-title"><i class="fas fa-align-center"></i> إعدادات التذييل</div>
                        <div class="form-group" style="margin-bottom:20px;">
                            <label style="display:block; font-weight:bold; margin-bottom:5px;">النص الذي سيظهر في تذييل كل صفحة</label>
                            <input type="text" id="footer_text" class="form-control" placeholder="إدارة العمليات التعليمية المنطقة (1) رئيس مدارس- أفنان محمد أمين">
                        </div>
                        <div class="settings-grid-2">
                            <div class="form-group">
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">محاذاة التذييل</label>
                                <select id="footer_align" class="form-control"><option value="center">وسط</option><option value="right">يمين</option><option value="left">يسار</option></select>
                            </div>
                            <div class="form-group">
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">حجم الخط</label>
                                <select id="footer_fontsize" class="form-control"><option value="10">10 نقطة</option><option value="12">12 نقطة</option><option value="14">14 نقطة</option><option value="16">16 نقطة</option></select>
                            </div>
                        </div>
                        <div style="text-align:left; margin-top:10px;"><button class="btn setting-edit-btn" style="background:#28a745; color:white; font-weight:bold;" onclick="saveFooterSettings()"><i class="fas fa-save"></i> حفظ التذييل</button></div>
                    </div>
                </div>

                <div id="eval" class="setting-content-pane">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="color:var(--primary); margin:0;">معايير الزيارة الصفية</h3>
                        <div style="display:flex; gap:10px;">
                            <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="deleteSelectedSettings('criteria')"><i class="fas fa-trash"></i> حذف المحدد</button>
                            <button class="btn setting-edit-btn" style="background:#2c5aa0; color:white;" onclick="openAddEvalModal()"><i class="fas fa-plus"></i> إضافة معيار</button>
                        </div>
                    </div>
                    <div class="table-responsive"><table class="custom-table"><thead><tr><th width="5%"><input type="checkbox" id="selectAllCriteria" class="custom-checkbox" onchange="toggleSelectAllSettings('criteria', this)"></th><th width="10%">#</th><th width="45%">اسم المعيار</th><th width="15%">الحالة</th><th width="25%">الإجراءات</th></tr></thead><tbody id="evalTableBody"></tbody></table></div>
                    
                    <hr style="margin: 40px 0; border-top: 1px solid #ddd;">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="color:var(--primary); margin:0;">قائمة التقديرات</h3>
                        <div style="display:flex; gap:10px;">
                            <button class="btn setting-edit-btn" style="background:#dc3545; color:white;" onclick="deleteSelectedSettings('grades')"><i class="fas fa-trash"></i> حذف المحدد</button>
                            <button class="btn setting-edit-btn" style="background:#2c5aa0; color:white;" onclick="openAddGradeModal()"><i class="fas fa-plus"></i> إضافة تقدير</button>
                        </div>
                    </div>
                    <div class="table-responsive"><table class="custom-table"><thead><tr><th width="5%"><input type="checkbox" id="selectAllGrades" class="custom-checkbox" onchange="toggleSelectAllSettings('grades', this)"></th><th width="10%">#</th><th width="45%">اسم التقدير</th><th width="15%">الحالة</th><th width="25%">الإجراءات</th></tr></thead><tbody id="gradeTableBody"></tbody></table></div>
                </div>

                <div id="vis" class="setting-content-pane">
                    <div class="settings-card-wrapper">
                        <div class="settings-card-title"><i class="fas fa-list-ol"></i> ترتيب ظهور الزوار في التقارير</div>
                        <div class="settings-grid-2">
                            <div class="form-group" style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #eef2f7;">
                                <h4 style="margin-top:0; color:var(--primary); border-bottom:2px solid #ddd; padding-bottom:10px;">القيادة العليا</h4>
                                <ul id="list_visitor_senior" class="visitor-list"></ul>
                                <button class="upload-btn-custom setting-edit-btn" style="width:100%; justify-content:center;" onclick="openVisitorPicker('senior')"><i class="fas fa-plus"></i> إضافة زائر للقائمة</button>
                            </div>
                            <div class="form-group" style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #eef2f7;">
                                <h4 style="margin-top:0; color:var(--primary); border-bottom:2px solid #ddd; padding-bottom:10px;">القيادة الوسطى</h4>
                                <ul id="list_visitor_middle" class="visitor-list"></ul>
                                <button class="upload-btn-custom setting-edit-btn" style="width:100%; justify-content:center;" onclick="openVisitorPicker('middle')"><i class="fas fa-plus"></i> إضافة زائر للقائمة</button>
                            </div>
                        </div>
                        <div style="text-align: left; margin-top: 20px;"><button class="btn btn-primary setting-edit-btn" style="width:200px;" onclick="saveVisitorOrder()"><i class="fas fa-save"></i> حفظ الترتيب</button></div>
                    </div>
                </div>

                <div id="log" class="setting-content-pane">
                    <div class="settings-card-wrapper">
                        <div class="settings-card-title"><i class="fas fa-database"></i> النسخ الاحتياطي واستعادة البيانات</div>
                        <div class="settings-grid-2">
                            <div class="form-group" style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #eef2f7; text-align:center;">
                                <p style="color:#777; font-size:0.9rem; margin-top:0;">حفظ نسخة كاملة من جميع البيانات والمدخلات.</p>
                                <button class="btn btn-primary" onclick="backupDatabase()"><i class="fas fa-download"></i> تحميل نسخة احتياطية</button>
                            </div>
                            <div class="form-group" style="background:#fff2f2; padding:20px; border-radius:8px; border:1px solid #ffdede; text-align:center;">
                                <p style="color:#777; font-size:0.9rem; margin-top:0;">استعادة البيانات من ملف نسخة احتياطية سابق.</p>
                                <input type="file" id="restoreDbInput" hidden accept=".json" onchange="restoreDatabase(this)">
                                <button class="btn btn-delete" onclick="document.getElementById('restoreDbInput').click()"><i class="fas fa-upload"></i> استعادة البيانات</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card-wrapper">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h4 style="color:var(--primary); margin:0;"><i class="fas fa-history"></i> سجل العمليات (Audit Log)</h4>
                            <div style="display:flex; gap:10px;">
                                <button class="btn" style="background:#17a2b8; color:white; font-size:0.8rem;" onclick="loadSystemLogs()"><i class="fas fa-sync"></i> تحديث</button>
                                <button class="btn setting-edit-btn" style="background:#dc3545; color:white; font-size:0.8rem;" onclick="clearSystemLogs()"><i class="fas fa-trash"></i> مسح السجل</button>
                            </div>
                        </div>
                        <div class="table-responsive"><table class="custom-table" style="font-size:0.9rem;"><thead><tr><th width="20%">التاريخ والوقت</th><th width="20%">المستخدم</th><th width="20%">الحدث</th><th width="40%">التفاصيل</th></tr></thead><tbody id="logTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="brandModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span id="brandModalTitle">إضافة براند</span> <span onclick="closeModal('brandModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body"><form id="brandForm"><input type="hidden" id="editBrandId"><label>اسم البراند</label><input type="text" id="brandName" class="form-control" required placeholder="مثال: فرع المحرق"><label>البريد الإلكتروني للبراند</label><input type="email" id="brandEmail" class="form-control" placeholder="example@school.bh"><label style="color:var(--primary); font-weight:bold; margin-top:15px; display:block;">مدة صلاحية البراند</label><div style="display: flex; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee;"><div style="flex:1;"><label style="font-size:0.8rem; color:#777;">تاريخ البدء</label><input type="date" id="brandStartDate" class="form-control" style="margin-bottom:0;"></div><div style="flex:1;"><label style="font-size:0.8rem; color:#777;">تاريخ الانتهاء</label><input type="date" id="brandEndDate" class="form-control" style="margin-bottom:0;"></div></div><small style="color:#777; font-size:0.8rem; display:block; margin-top:5px;">* اترك التواريخ فارغة لصلاحية دائمة.</small></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveBrand()">حفظ</button><button class="btn" style="background:#ddd;" onclick="closeModal('brandModal')">إلغاء</button></div></div></div>
    
    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="addUserModalTitle">إضافة اسم جديد</span> <span onclick="closeModal('addUserModal')" style="cursor:pointer;">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" id="editUserId">
                    <label id="addNameLabel">الاسم الكامل / اسم القسم</label>
                    <input type="text" id="addName" class="form-control" required>
                    
                    <div id="linkedDeptsWrapper" class="form-group" style="display:none;">
                        <label>الأقسام المرتبطة</label>
                        <div id="linkedDeptsContainer" style="border: 1px solid #ddd; padding: 10px; border-radius: 6px; max-height: 150px; overflow-y: auto; background: #f9f9f9;">
                            </div>
                    </div>

                    <div id="deptWrapper" class="form-group" style="display:none;">
                        <label>القسم الأكاديمي</label>
                        <select id="addDept" class="form-control"></select>
                    </div>
                    
                    <div id="userFields">
                        <label>الوظيفة</label>
                        <input type="text" id="addJob" class="form-control">
                        <label>رقم الهاتف</label>
                        <input type="text" id="addPhone" class="form-control">
                        <label>اسم الدخول</label>
                        <input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label>
                        <input type="password" id="addPass" class="form-control">
                        <div id="roleWrapper" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <label style="color:var(--primary); font-weight:bold; margin-bottom:5px;">صلاحية إضافية (اختياري)</label>
                            <select id="addRole" class="form-control" style="margin-bottom:15px;"><option value="">مستخدم عادي</option><option value="supervisor">مشرف للنظام</option><option value="admin_support">إداري للنظام</option></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveUserForm()">حفظ</button><button class="btn" style="background:#ddd;" onclick="closeModal('addUserModal')">إلغاء</button></div>
        </div>
    </div>
    
    <div id="distinguishedModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span id="distinguishedModalTitle">إضافة</span> <span onclick="closeModal('distinguishedModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body"><form id="distinguishedForm"><input type="hidden" id="distType"><input type="hidden" id="distEditId"><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">التاريخ</label><input type="date" class="form-control" id="distDate"></div><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">القسم الأكاديمي</label><select id="distDept" class="form-control" onchange="onDistinguishedDeptChange()"><option value="">اختر القسم...</option></select></div><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">اسم المعلم/ة</label><select id="distTeacher" class="form-control"><option value="">اختر المعلم/ة...</option></select></div><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">التقدير</label><select id="distEval" class="form-control"><option value="">اختر التقدير...</option></select></div><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">المبررات / ملاحظات</label><textarea id="distReason" class="form-control" rows="4"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveDistinguishedEntry()">حفظ البيانات</button><button class="btn" style="background:#ddd;" onclick="closeModal('distinguishedModal')">إلغاء</button></div></div></div>
    
    <div id="addQualitativeModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>إضافة تقرير نوعي</span> <span onclick="closeModal('addQualitativeModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body"><form id="qualitativeForm"><input type="hidden" id="qualEditId"><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">التاريخ</label><input type="date" class="form-control" id="qualDate"></div><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">القسم الأكاديمي</label><select id="qualDept" class="form-control"><option value="">اختر القسم...</option></select></div><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب القوة</label><textarea id="qualStrength" class="form-control" rows="4" placeholder="سجل جوانب القوة هنا..."></textarea></div><div class="form-group"><label style="font-weight:bold; display:block; margin-bottom:5px;">جوانب بحاجة إلى تطوير</label><textarea id="qualImprove" class="form-control" rows="4" placeholder="سجل جوانب التطوير هنا..."></textarea></div></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveQualitative()">حفظ</button><button class="btn" style="background:#ddd;" onclick="closeModal('addQualitativeModal')">إلغاء</button></div></div></div>
    
    <div id="addVisitModal" class="modal-overlay"><div class="modal-box" style="width: 700px;"><div class="modal-header"><span>إضافة زيارة صفية</span> <span onclick="closeModal('addVisitModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body" style="padding: 25px;"><form id="addVisitForm"><input type="hidden" id="visitEditId"><div class="settings-grid-2"><div class="form-group" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #eef2f7;"><label style="font-weight:bold; display:block; margin-bottom:8px; color:var(--primary);"><i class="fas fa-layer-group"></i> القسم</label><select id="visitDept" class="form-control" onchange="onVisitDeptChange()" style="border:1px solid #ccc; box-shadow:none;"><option value="">اختر القسم...</option></select></div><div class="form-group" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #eef2f7;"><label style="font-weight:bold; display:block; margin-bottom:8px; color:var(--primary);"><i class="fas fa-chalkboard-teacher"></i> المعلم/ة</label><select id="visitTeacher" class="form-control" style="border:1px solid #ccc; box-shadow:none;"><option value="">اختر المعلم/ة...</option></select></div><div class="form-group" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #eef2f7;"><label style="font-weight:bold; display:block; margin-bottom:8px; color:var(--primary);"><i class="fas fa-calendar-day"></i> تاريخ الزيارة</label><input type="date" id="visitDate" class="form-control" style="border:1px solid #ccc; box-shadow:none;"></div><div class="form-group" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #eef2f7;"><label style="font-weight:bold; display:block; margin-bottom:8px; color:var(--primary);"><i class="fas fa-star-half-alt"></i> التقييم</label><select id="visitEval" class="form-control" style="border:1px solid #ccc; box-shadow:none;"><option value="">اختر التقدير...</option></select></div></div></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveVisit()">حفظ</button><button class="btn" style="background:#ddd;" onclick="closeModal('addVisitModal')">إلغاء</button></div></div></div>
    
    <div id="viewVisitModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">تفاصيل الزيارة <span onclick="closeModal('viewVisitModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body" id="viewVisitContent"></div><div class="modal-footer"><button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewVisitModal')">إغلاق</button></div></div></div>
    <div id="addEvalModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>إضافة/تعديل معيار تقييم</span> <span onclick="closeModal('addEvalModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body"><form id="addEvalForm"><input type="hidden" id="editEvalId"><label>اسم المعيار</label><input type="text" id="evalName" class="form-control" required placeholder="مثال: التخطيط الفعال"></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveEvalForm()">حفظ</button><button class="btn" style="background:#ddd;" onclick="closeModal('addEvalModal')">إلغاء</button></div></div></div>
    <div id="addGradeModal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>إضافة/تعديل تقدير</span> <span onclick="closeModal('addGradeModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body"><form id="addGradeForm"><input type="hidden" id="editGradeId"><label>اسم التقدير</label><input type="text" id="gradeName" class="form-control" required placeholder="مثال: ممتاز"></form></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveGradeForm()">حفظ</button><button class="btn" style="background:#ddd;" onclick="closeModal('addGradeModal')">إلغاء</button></div></div></div>
    <div id="viewUserModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">معاينة <span onclick="closeModal('viewUserModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body" id="viewUserContent"></div><div class="modal-footer"><button class="btn" style="background:#28a745; color:white;" onclick="closeModal('viewUserModal')">إغلاق</button></div></div></div>
    <div id="permModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">إدارة الصلاحيات <span onclick="closeModal('permModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body"><h4 id="permTargetName" style="margin-top:0; color:var(--primary); margin-bottom:15px;"></h4><div class="perm-header"><span>تحديد الكل</span><div style="display:flex; gap:15px;"><label><input type="checkbox" onchange="toggleAllPerms('view', this)"> الكل معاينة</label><label><input type="checkbox" onchange="toggleAllPerms('edit', this)"> الكل تعديل</label></div></div><div class="perm-list" id="permList"></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitPermissions()">حفظ الصلاحيات</button><button class="btn" style="background:#ddd;" onclick="closeModal('permModal')">إلغاء</button></div></div></div>
    <div id="imageViewModal" class="modal-overlay" onclick="closeModal('imageViewModal')"><div style="position:relative; max-width:90%; max-height:90%;"><span onclick="closeModal('imageViewModal')" style="position:absolute; top:-40px; right:0; color:white; font-size:30px; cursor:pointer;">&times;</span><img id="fullImage" src="" style="max-width:100%; max-height:80vh; border-radius:5px; box-shadow:0 0 20px rgba(0,0,0,0.5);"></div></div>
    <div id="visitorPickerModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">اختر اسماً للإضافة <span onclick="closeModal('visitorPickerModal')" style="cursor:pointer;">&times;</span></div><div class="modal-body"><input type="text" id="visitorSearch" class="form-control" placeholder="بحث عن اسم..." onkeyup="filterPickerList()"><div id="pickerList" class="picker-list"></div></div><div class="modal-footer"><button class="btn" style="background:#ddd;" onclick="closeModal('visitorPickerModal')">إغلاق</button></div></div></div>

    <script>
        // System Config & Global Scope
        const SECTIONS = [{id: 'dashboard', name: 'لوحة التحكم'}, {id: 'visits', name: 'الزيارات الصفية'}, {id: 'performance', name: 'تقييم الأداء'}, {id: 'distinguished', name: 'المعلمين المتميزين'}, {id: 'qualitative', name: 'التقرير النوعي'}, {id: 'quality-report', name: 'تقرير جودة التعليم'}, {id: 'user-management', name: 'إدارة المستخدمين'}, {id: 'system-admin', name: 'إعدادات مدير النظام'}, {id: 'settings', name: 'الإعدادات'}];
        const DEFAULT_PERMS = {}; SECTIONS.forEach(s => DEFAULT_PERMS[s.id] = {view: true, edit: false});
        const DB_KEY = 'Irteqaa_System_DB_V18'; 
        const INITIAL_DB = { admins: [{id: 999, name: 'مدير النظام', login: 'admin', pass: 'Hasan@12', status: 'active', job: 'مدير النظام', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))}], senior: [{id: 1, name: 'علياء محمد مبارك الدوسري', job: 'مديرة المدرسة', phone: '39669118', login: '39669118', pass: '39669118', status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: '2025/01/01', brandId: 1, allowedBrands: [1]}], middle: [], teachers: [], departments: [], academic_departments: [], visits_senior: [], visits_middle: [], distinguished: [], care_needed: [], qualitative_reports: [], saved_reports: [], settings: { schoolName: 'مدرسة مدينة حمد الابتدائية للبنات', schoolYear: '2025 / 2026م', evaluation_criteria: [], evaluation_grades: [{name:'ممتاز', status:'active'}, {name:'جيد جداً', status:'active'}, {name:'جيد', status:'active'}, {name:'مقبول', status:'active'}, {name:'ضعيف', status:'active'}, {name:'يتجاوز التوقعات كثيراً', status:'active'}, {name:'يتجاوز التوقعات', status:'active'}, {name:'يفي بالتوقعات', status:'active'}, {name:'يفي بالتوقعات جزئيا', status:'active'}], visitor_order_senior: [], visitor_order_middle: [] }, brands: [{id: 1, name: 'الفرع الرئيسي', email: 'main@school.bh', status: 'active'}], logs: [] };
        SECTIONS.forEach(sec => { INITIAL_DB.admins[0].permissions[sec.id] = {view: true, edit: true}; });
        const MONTH_NAMES_AR = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];

        let DB = {}, CURRENT_USER = null, CURRENT_BRAND = null, CURRENT_TAB = 'senior', CURRENT_VISIT_TAB = 'senior', EDITING_PERM_ID = null, IS_BULK_PERM_MODE = false, CURRENT_PICKER_TYPE = null, performanceChartInstance = null, dashBarChartInst = null, dashPieChartInst = null, CURRENT_IMPORT_TARGET = null;

        function canEdit(pageId) { if(!CURRENT_USER) return false; const p = CURRENT_USER.permissions || DEFAULT_PERMS; return (p[pageId] && p[pageId].edit === true); }
        function isAdminUser() { return CURRENT_USER && CURRENT_USER.id === 999; }
        
        function initSystem() { 
            const storedDB = localStorage.getItem(DB_KEY); 
            if (storedDB) { 
                try { 
                    DB = JSON.parse(storedDB); 
                    if(!DB.brands) DB.brands = JSON.parse(JSON.stringify(INITIAL_DB.brands)); 
                    if(!DB.admins) DB.admins = JSON.parse(JSON.stringify(INITIAL_DB.admins)); 
                    if(!DB.senior) DB.senior = []; if(!DB.middle) DB.middle = []; if(!DB.teachers) DB.teachers = []; 
                    if(!DB.departments) DB.departments = []; if(!DB.academic_departments) DB.academic_departments = []; if(!DB.visits_senior) DB.visits_senior = []; 
                    if(!DB.visits_middle) DB.visits_middle = []; if(!DB.distinguished) DB.distinguished = []; 
                    if(!DB.care_needed) DB.care_needed = []; if(!DB.qualitative_reports) DB.qualitative_reports = []; 
                    if(!DB.saved_reports) DB.saved_reports = []; if(!DB.logs) DB.logs = []; if(!DB.settings) DB.settings = {}; 
                    DB.settings = {...INITIAL_DB.settings, ...DB.settings}; 
                    if(!DB.settings.evaluation_grades) DB.settings.evaluation_grades = JSON.parse(JSON.stringify(INITIAL_DB.settings.evaluation_grades)); 
                    saveDB(); 
                } catch (e) { DB = JSON.parse(JSON.stringify(INITIAL_DB)); saveDB(); } 
            } else { DB = JSON.parse(JSON.stringify(INITIAL_DB)); saveDB(); } 
            
            const sessionID = localStorage.getItem('Irteqaa_Session'); 
            if (sessionID) { 
                let found = null; 
                ['admins', 'senior', 'middle', 'teachers'].forEach(grp => { if(DB[grp]) { const u = DB[grp].find(x => x.id == sessionID); if(u) found = u; } }); 
                if (found && found.status === 'active') { 
                    CURRENT_USER = found; 
                    const lastBrandId = localStorage.getItem('Irteqaa_CurrentBrand'); 
                    let targetBrand = null; 
                    if (isAdminUser()) { 
                        targetBrand = DB.brands.find(b => b.id == lastBrandId && b.status === 'active') || DB.brands[0]; 
                    } else { 
                        const allowedIds = found.allowedBrands || (found.brandId ? [found.brandId] : []); 
                        if (lastBrandId && allowedIds.includes(parseInt(lastBrandId))) { targetBrand = DB.brands.find(b => b.id == lastBrandId && b.status === 'active'); } 
                        if (!targetBrand && allowedIds.length > 0) { targetBrand = DB.brands.find(b => b.id === allowedIds[0] && b.status === 'active'); } 
                    } 
                    if (targetBrand) { 
                        const today = new Date().toISOString().split('T')[0]; 
                        if (targetBrand.startDate && targetBrand.startDate > today) { alert("عذراً، لم يبدأ تاريخ تفعيل اشتراك الجهة (البراند) بعد."); logout(); return; } 
                        if (targetBrand.endDate && targetBrand.endDate < today && !isAdminUser()) { alert("يرجى التواصل مع المشرف."); logout(); return; } 
                        CURRENT_BRAND = targetBrand; showApp(); 
                    } else { alert("لا توجد جهة (براند) مصرح لك بالدخول إليها."); localStorage.removeItem('Irteqaa_Session'); document.getElementById('loginPage').style.display = 'flex'; } 
                } else { localStorage.removeItem('Irteqaa_Session'); document.getElementById('loginPage').style.display = 'flex'; } 
            } else { document.getElementById('loginPage').style.display = 'flex'; } 
        }
        
        function saveDB() { if(DB && DB.admins) { localStorage.setItem(DB_KEY, JSON.stringify(DB)); } }
        function addSystemLog(action, details) { const logEntry = { id: Date.now(), date: new Date().toLocaleString('en-GB'), user: CURRENT_USER ? CURRENT_USER.name : 'النظام/زائر', action: action, details: details, brand: CURRENT_BRAND ? CURRENT_BRAND.name : 'N/A' }; if(!DB.logs) DB.logs = []; DB.logs.unshift(logEntry); if(DB.logs.length > 500) DB.logs = DB.logs.slice(0, 500); saveDB(); }
        
        // Backup & Restore
        window.backupDatabase = function() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "Irteqaa_Backup_" + new Date().toISOString().slice(0,10) + ".json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); };
        window.restoreDatabase = function(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { try { const importedDB = JSON.parse(e.target.result); if(importedDB && importedDB.admins && importedDB.settings) { if(confirm("تحذير: سيتم استبدال جميع البيانات الحالية بالبيانات الموجودة في ملف النسخة الاحتياطية. هل أنت متأكد؟")) { DB = importedDB; saveDB(); alert("تمت استعادة البيانات بنجاح. سيتم إعادة تحميل النظام."); location.reload(); } } else { alert("ملف النسخة الاحتياطية غير صالح."); } } catch(err) { alert("حدث خطأ أثناء قراءة الملف."); } }; reader.readAsText(input.files[0]); input.value = ''; } };

        function login(e) { 
            e.preventDefault(); 
            const errBox = document.getElementById('loginError'); errBox.style.display = 'none'; errBox.innerText = ''; 
            const uInput = document.getElementById('loginUser').value.trim(); const pInput = document.getElementById('loginPass').value.trim(); 
            let userFound = null; 
            ['admins', 'senior', 'middle', 'teachers'].forEach(grp => { if(DB[grp]) { const match = DB[grp].find(x => String(x.login).trim() === uInput && String(x.pass).trim() === pInput); if(match) userFound = match; } }); 
            if (userFound) { 
                if (userFound.status !== 'active') { errBox.innerText = "نعتذر منك، هذا الحساب غير نشط حالياً."; errBox.style.display = 'block'; return; } 
                CURRENT_USER = userFound; localStorage.setItem('Irteqaa_Session', userFound.id); 
                let targetBrandId = null; 
                if(userFound.id === 999) { targetBrandId = DB.brands[0].id; } else { const allowedIds = userFound.allowedBrands || (userFound.brandId ? [userFound.brandId] : []); if(allowedIds.length > 0) targetBrandId = allowedIds[0]; } 
                if(targetBrandId) { 
                    const brand = DB.brands.find(b => b.id === targetBrandId); 
                    if (brand) { const today = new Date().toISOString().split('T')[0]; if (brand.startDate && brand.startDate > today) { errBox.innerText = "عذراً، لم يبدأ تاريخ تفعيل اشتراك الجهة (البراند) بعد."; errBox.style.display = 'block'; return; } if (brand.endDate && brand.endDate < today && !isAdminUser()) { errBox.innerText = "يرجى التواصل مع المشرف."; errBox.style.display = 'block'; return; } } 
                    localStorage.setItem('Irteqaa_CurrentBrand', targetBrandId); addSystemLog('تسجيل دخول', `المستخدم: ${userFound.name}`); location.reload(); 
                } else { errBox.innerText = "لا يوجد براند مخصص لهذا المستخدم."; errBox.style.display = 'block'; } 
            } else { errBox.innerText = "بيانات الدخول غير صحيحة."; errBox.style.display = 'block'; } 
        }
        
        function togglePass(fieldId, icon) { const input = document.getElementById(fieldId); if (input.type === "password") { input.type = "text"; icon.classList.remove("fa-eye"); icon.classList.add("fa-eye-slash"); } else { input.type = "password"; icon.classList.remove("fa-eye-slash"); icon.classList.add("fa-eye"); } }
        function logout() { if(CURRENT_USER) addSystemLog('تسجيل خروج', `المستخدم: ${CURRENT_USER.name}`); localStorage.removeItem('Irteqaa_Session'); saveDB(); location.reload(); }
        
        function navigate(pageId) { 
            const perms = CURRENT_USER.permissions || DEFAULT_PERMS; 
            if (perms[pageId] && perms[pageId].view === false) { alert("عذراً، ليس لديك صلاحية للوصول إلى هذه الصفحة."); return; } 
            document.querySelectorAll('.section-card').forEach(d => d.classList.remove('active')); 
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active')); 
            const target = document.getElementById(pageId); const link = document.querySelector(`a[data-page="${pageId}"]`); 
            if (target) target.classList.add('active'); if (link) link.classList.add('active'); 
            const activeSection = SECTIONS.find(s => s.id === pageId); 
            if(activeSection) document.getElementById('pageTitle').innerText = activeSection.name; 
            if(pageId === 'dashboard') renderDashboard(); 
            if(pageId === 'settings') loadSettings(); 
            if(pageId === 'visits') { renderVisitsTable(); checkVisitButtonAuth(); } 
            if(pageId === 'performance') renderPerformanceChart(); 
            if(pageId === 'distinguished') renderDistinguishedTables(); 
            if(pageId === 'qualitative') renderQualitativeTable(); 
            if(pageId === 'quality-report') { const d = new Date(); document.getElementById('reportMonthSelect').value = String(d.getMonth()+1).padStart(2,'0'); } 
            if(pageId === 'system-admin') renderBrandsTable(); 
        }
        
        function showApp() { 
            document.getElementById('loginPage').style.display = 'none'; 
            document.getElementById('app').style.display = 'flex'; 
            document.getElementById('headerUserName').innerText = CURRENT_USER.name; 
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job || CURRENT_USER.dept || 'مستخدم'; 
            updateBrandUI(); 
            const adminBtns = document.querySelectorAll('.admin-only-btn'); adminBtns.forEach(btn => { btn.style.display = isAdminUser() ? 'inline-block' : 'none'; }); 
            applySidebarPermissions(); renderTable(); navigate('dashboard'); populateDateFilters(); 
        }
        
        function applySidebarPermissions() { const perms = CURRENT_USER.permissions || DEFAULT_PERMS; SECTIONS.forEach(sec => { const el = document.getElementById('nav-' + sec.id); if(el) { if (sec.id === 'system-admin') { el.style.display = isAdminUser() ? 'block' : 'none'; } else { el.style.display = (perms[sec.id] && perms[sec.id].view === false) ? 'none' : 'block'; } } }); }
        function toggleBrandDropdown() { document.getElementById('brandDropdown').classList.toggle('show'); }
        window.onclick = function(event) { if (!event.target.matches('.brand-btn') && !event.target.closest('.brand-btn')) { var dropdowns = document.getElementsByClassName("brand-dropdown"); for (var i = 0; i < dropdowns.length; i++) { var openDropdown = dropdowns[i]; if (openDropdown.classList.contains('show')) { openDropdown.classList.remove('show'); } } } }
        function updateBrandUI() { if(!CURRENT_BRAND) return; document.getElementById('currentBrandLabel').innerText = CURRENT_BRAND.name; const dropdown = document.getElementById('brandDropdown'); dropdown.innerHTML = ''; DB.brands.forEach(b => { let hasAccess = false; if (isAdminUser()) { hasAccess = true; } else { const allowedIds = CURRENT_USER.allowedBrands || (CURRENT_USER.brandId ? [CURRENT_USER.brandId] : []); if (allowedIds.includes(b.id)) hasAccess = true; } if (hasAccess && b.status === 'active') { const activeClass = (b.id === CURRENT_BRAND.id) ? 'active' : ''; dropdown.innerHTML += `<div class="brand-item ${activeClass}" onclick="switchBrand(${b.id})"><div class="brand-icon">${b.name.charAt(0)}</div><div class="brand-label">${b.name}</div></div>`; } }); }
        function switchBrand(id) { const newBrand = DB.brands.find(b => b.id === id); if(newBrand) { const today = new Date().toISOString().split('T')[0]; if (newBrand.endDate && newBrand.endDate < today && !isAdminUser()) { alert("يرجى التواصل مع المشرف."); return; } CURRENT_BRAND = newBrand; localStorage.setItem('Irteqaa_CurrentBrand', id); location.reload(); } }
        function filterByContext(list) { if(!list) return []; return list.filter(item => { const itemBrandId = item.brandId || 1; if(item.id === 999) return false; return itemBrandId === CURRENT_BRAND.id; }); }

        function updateDateFilterOptions(data, selectId) {
            const select = document.getElementById(selectId);
            const currentSelection = select.value; 
            select.innerHTML = '';
            select.innerHTML += `<option value="current">الشهر الحالي</option>`;
            const months = new Set();
            data.forEach(item => {
                if(item.date) {
                    const d = new Date(item.date);
                    if(!isNaN(d)) {
                        const m = d.getMonth();
                        const y = d.getFullYear();
                        months.add(`${y}-${String(m+1).padStart(2, '0')}`);
                    }
                }
            });
            const sortedMonths = Array.from(months).sort().reverse();
            sortedMonths.forEach(ym => {
                const [year, month] = ym.split('-');
                const label = `${MONTH_NAMES_AR[parseInt(month)-1]} ${year}`;
                select.innerHTML += `<option value="${ym}">الشهر ${label}</option>`;
            });
            select.innerHTML += `<option value="all">كل الأشهر (الكل)</option>`;
            select.innerHTML += `<option value="custom">تواريخ محددة</option>`;
            if (currentSelection && (currentSelection === 'current' || currentSelection === 'all' || currentSelection === 'custom' || sortedMonths.includes(currentSelection))) { select.value = currentSelection; } else { select.value = 'current'; }
        }

        function handleDateFilterChange(prefix, renderCallback) {
            const select = document.getElementById(prefix + 'MonthFilter');
            const customBox = document.getElementById(prefix + '_CustomDateInputs');
            if(select.value === 'custom') { customBox.style.display = 'inline-flex'; } else { customBox.style.display = 'none'; if(renderCallback) renderCallback(); }
        }

        function getFilteredData(fullData, prefix) {
            const select = document.getElementById(prefix + 'MonthFilter');
            const mode = select ? select.value : 'current';
            if(mode === 'all') return fullData;
            if(mode === 'current') {
                const now = new Date();
                const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
                const currentYear = String(now.getFullYear());
                return fullData.filter(item => { if(!item.date) return false; return String(item.date).startsWith(`${currentYear}-${currentMonth}`); });
            }
            if(mode === 'custom') {
                const startStr = document.getElementById(prefix + '_StartDate').value;
                const endStr = document.getElementById(prefix + '_EndDate').value;
                if(!startStr || !endStr) return fullData; 
                return fullData.filter(item => { if(!item.date) return false; return String(item.date) >= startStr && String(item.date) <= endStr; });
            }
            return fullData.filter(item => { if(!item.date) return false; return String(item.date).startsWith(mode); });
        }
        
        function populateDateFilters() {
            const allVisits = [...filterByContext(DB.visits_senior), ...filterByContext(DB.visits_middle)];
            updateDateFilterOptions(allVisits, 'dashMonthFilter');
            const visitData = (CURRENT_VISIT_TAB === 'senior') ? filterByContext(DB.visits_senior) : filterByContext(DB.visits_middle);
            updateDateFilterOptions(visitData, 'visitMonthFilter');
            updateDateFilterOptions(allVisits, 'perfMonthFilter');
            const distData = [...filterByContext(DB.distinguished), ...filterByContext(DB.care_needed)];
            updateDateFilterOptions(distData, 'distMonthFilter');
            updateDateFilterOptions(filterByContext(DB.qualitative_reports), 'qualMonthFilter');
        }

        function renderDashboard() { 
            let seniorVisits = filterByContext(DB.visits_senior || []); 
            let middleVisits = filterByContext(DB.visits_middle || []); 
            let allVisitsRaw = [...seniorVisits, ...middleVisits]; 
            const isRestricted = !isAdminUser() && !DB.senior.some(u => u.id === CURRENT_USER.id); 
            if (isRestricted) { const userDept = CURRENT_USER.dept; if(userDept) { allVisitsRaw = allVisitsRaw.filter(x => x.dept === userDept); } } 
            const filteredVisits = getFilteredData(allVisitsRaw, 'dash');
            const total = filteredVisits.length; 
            let exceedsLot = 0, exceeds = 0, meets = 0, partially = 0; 
            filteredVisits.forEach(v => { 
                if(String(v.eval||'').includes('يتجاوز التوقعات بكثير') || String(v.eval||'')==='ممتاز') exceedsLot++; 
                else if(String(v.eval||'').includes('يتجاوز التوقعات') || String(v.eval||'').includes('جيد جداً')) exceeds++; 
                else if(String(v.eval||'').includes('يفي بالتوقعات') || String(v.eval||'').includes('جيد')) meets++; 
                else partially++; 
            }); 
            animateValue('stat_total', parseInt(document.getElementById('stat_total').innerText), total, 1000); 
            animateValue('stat_exceeds_lot', parseInt(document.getElementById('stat_exceeds_lot').innerText), exceedsLot, 1000); 
            animateValue('stat_exceeds', parseInt(document.getElementById('stat_exceeds').innerText), exceeds, 1000); 
            animateValue('stat_meets', parseInt(document.getElementById('stat_meets').innerText), meets, 1000); 
            animateValue('stat_partially', parseInt(document.getElementById('stat_partially').innerText), partially, 1000); 
            const hasData = filteredVisits.length > 0; 
            const deptCounts = {}; 
            filteredVisits.forEach(v => { deptCounts[v.dept] = (deptCounts[v.dept] || 0) + 1; }); 
            const deptLabels = Object.keys(deptCounts); 
            const deptData = Object.values(deptCounts); 
            if (dashBarChartInst) dashBarChartInst.destroy(); 
            dashBarChartInst = new Chart(document.getElementById('dashBarChart').getContext('2d'), { type: 'bar', data: { labels: hasData ? deptLabels : ['لا توجد زيارات'], datasets: [{ label: 'عدد الزيارات', data: hasData ? deptData : [0], backgroundColor: hasData ? '#2b579a' : '#e9ecef', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); 
            const evalCounts = {}; 
            filteredVisits.forEach(v => { evalCounts[v.eval||'غير محدد'] = (evalCounts[v.eval||'غير محدد'] || 0) + 1; }); 
            const evalLabels = Object.keys(evalCounts); 
            const evalData = Object.values(evalCounts); 
            if (dashPieChartInst) dashPieChartInst.destroy(); 
            dashPieChartInst = new Chart(document.getElementById('dashPieChart').getContext('2d'), { type: 'doughnut', data: { labels: hasData ? evalLabels : ['لا توجد زيارات'], datasets: [{ data: hasData ? evalData : [1], backgroundColor: hasData ? ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6610f2'] : ['#e9ecef'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } }); 
        }
        function animateValue(id, start, end, duration) { if (start === end) return; const obj = document.getElementById(id); let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); obj.innerHTML = Math.floor(progress * (end - start) + start); if (progress < 1) { window.requestAnimationFrame(step); } }; window.requestAnimationFrame(step); }
        
        function setTab(tab, el) { CURRENT_TAB = tab; document.querySelectorAll('#user-management .custom-tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); if(document.getElementById('selectAll')) document.getElementById('selectAll').checked = false; renderTable(); }
        
        function renderTable() { 
            const headRow = document.getElementById('tableHeadRow'); const tbody = document.getElementById('usersTableBody'); const addBtn = document.getElementById('addBtnMain'); const bulkPermBtn = document.getElementById('bulkPermBtn'); tbody.innerHTML = ''; const canEditUsers = canEdit('user-management'); const actionButtons = document.getElementById('userActionButtons'); const noEditMsg = document.getElementById('noEditPermissionMsg'); 
            if(canEditUsers) { actionButtons.style.display = 'flex'; noEditMsg.style.display = 'none'; } else { actionButtons.style.display = 'none'; noEditMsg.style.display = 'block'; } 
            
            let headerHTML = `<th width="5%"><input type="checkbox" id="selectAll" class="custom-checkbox" onchange="toggleSelectAll(this)" ${canEditUsers?'':'disabled'}></th>`; 
            if (CURRENT_TAB === 'departments') { 
                headerHTML += `<th width="10%">الترتيب</th><th width="40%">اسم القسم</th><th width="15%">الحالة</th><th width="30%">الإجراءات</th>`; 
                addBtn.innerHTML = "<i class='fas fa-plus'></i> إضافة قسم جديد"; 
                if(bulkPermBtn) bulkPermBtn.style.display = 'none'; 
            } else if (CURRENT_TAB === 'academic_departments') {
                headerHTML += `<th width="10%">الترتيب</th><th width="25%">اسم القسم الأكاديمي</th><th width="20%">الأقسام المرتبطة</th><th width="15%">الحالة</th><th width="25%">الإجراءات</th>`; 
                addBtn.innerHTML = "<i class='fas fa-plus'></i> إضافة قسم أكاديمي"; 
                if(bulkPermBtn) bulkPermBtn.style.display = 'none'; 
            } else if (CURRENT_TAB === 'teachers') { 
                headerHTML += `<th width="5%">#</th><th width="25%">الاسم</th><th width="15%">القسم الأكاديمي</th><th width="15%">الحالة</th><th width="35%">الإجراءات</th>`; 
                addBtn.innerHTML = "<i class='fas fa-plus'></i> إضافة معلم/ة"; 
                if(bulkPermBtn) bulkPermBtn.style.display = 'inline-flex'; 
            } else { 
                headerHTML += `<th width="5%">#</th><th width="25%">الاسم</th><th width="15%">الوظيفة</th><th width="15%">صلاحية إضافية</th><th width="10%">الحالة</th><th width="25%">الإجراءات</th>`; 
                addBtn.innerHTML = "<i class='fas fa-plus'></i> إضافة مستخدم جديد"; 
                if(bulkPermBtn) bulkPermBtn.style.display = 'inline-flex'; 
            } 
            headRow.innerHTML = headerHTML; 
            
            let list = filterByContext(DB[CURRENT_TAB] || []); 
            list.forEach((u, idx) => { 
                const isActive = u.status === 'active'; 
                const statusBadge = isActive ? `<span class="status-badge status-active">نشط</span>` : `<span class="status-badge status-inactive">معطل</span>`; 
                let row = `<td><input type="checkbox" class="custom-checkbox user-select-cb" value="${u.id}" ${canEditUsers ? '' : 'disabled'}></td><td>${idx+1}</td><td style="font-weight:bold; color:var(--primary);">${u.name}</td>`; 
                
                if (CURRENT_TAB === 'departments') { 
                    row += `<td>${statusBadge}</td><td><div style="display:flex; justify-content:center; gap:4px; flex-wrap:wrap;">`; 
                } else if (CURRENT_TAB === 'academic_departments') {
                    const linkedStr = (u.linked_departments && u.linked_departments.length > 0) ? u.linked_departments.join('، ') : '-';
                    row += `<td><span style="font-size:0.85rem; color:#666; font-weight:600;">${linkedStr}</span></td><td>${statusBadge}</td><td><div style="display:flex; justify-content:center; gap:4px; flex-wrap:wrap;">`; 
                } else if (CURRENT_TAB === 'teachers') { 
                    row += `<td>${u.dept || '-'}</td><td>${statusBadge}</td><td><div style="display:flex; justify-content:center; gap:4px; flex-wrap:wrap;">`; 
                } else { 
                    let roleTxt = '-'; if(u.role === 'supervisor') roleTxt = '<span class="role-badge role-super" style="background:#eef4ff; color:var(--primary); padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">مشرف</span>'; if(u.role === 'admin_support') roleTxt = '<span class="role-badge role-admin" style="background:#fff2f2; color:#d63031; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;">إداري</span>'; 
                    row += `<td>${u.job || '-'}</td><td>${roleTxt}</td><td>${statusBadge}</td><td><div style="display:flex; justify-content:center; gap:4px; flex-wrap:wrap;">`; 
                } 
                
                if(canEditUsers) { row += `<button class="action-btn btn-move" onclick="moveItem('${CURRENT_TAB}', ${u.id}, 'up')" title="نقل لأعلى"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveItem('${CURRENT_TAB}', ${u.id}, 'down')" title="نقل لأسفل"><i class="fas fa-arrow-down"></i></button>`; } 
                
                if (CURRENT_TAB === 'departments' || CURRENT_TAB === 'academic_departments') { 
                    if(canEditUsers) { 
                        row += `<button class="action-btn btn-edit" onclick="editUser(${u.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                                <button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})" title="${isActive?'تعطيل':'تفعيل'}"><i class="fas fa-power-off"></i></button>
                                <button class="action-btn btn-delete" onclick="deleteUser(${u.id})" title="حذف"><i class="fas fa-trash"></i></button>`; 
                    } 
                } else { 
                    row += `<button class="action-btn btn-view" onclick="viewUser(${u.id})" title="معاينة"><i class="fas fa-eye"></i></button>`; 
                    if (canEditUsers) { 
                        row += `<button class="action-btn btn-edit" onclick="editUser(${u.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                                <button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleStatus(${u.id})" title="${isActive?'تعطيل':'تفعيل'}"><i class="fas fa-power-off"></i></button>
                                <button class="action-btn btn-perm" onclick="openPerms(${u.id})" title="الصلاحيات"><i class="fas fa-key"></i></button>
                                <button class="action-btn btn-delete" onclick="deleteUser(${u.id})" title="حذف"><i class="fas fa-trash"></i></button>`; 
                    } 
                } 
                row += `</div></td>`; 
                const tr = document.createElement('tr'); tr.innerHTML = row; tbody.appendChild(tr); 
            }); 
        }

        function moveItem(collection, id, d) {
            const l = DB[collection];
            const i = l.findIndex(x => x.id === id);
            if(i === -1) return;
            if(d === 'up' && i > 0) [l[i], l[i-1]] = [l[i-1], l[i]];
            if(d === 'down' && i < l.length-1) [l[i], l[i+1]] = [l[i+1], l[i]];
            saveDB();
            if(collection.includes('visits')) renderVisitsTable(); else renderTable();
        }

        function toggleSelectAll(s) { document.querySelectorAll('.user-select-cb').forEach(c=>{if(!c.disabled)c.checked=s.checked}); }
        function deleteSelected() { const c=document.querySelectorAll('.user-select-cb:checked'); if(c.length===0)return alert('حدد عناصر'); if(confirm('حذف؟')){const ids=Array.from(c).map(x=>parseInt(x.value)); DB[CURRENT_TAB]=DB[CURRENT_TAB].filter(u=>!ids.includes(u.id)); addSystemLog('حذف جماعي', `حذف ${ids.length}`); saveDB(); renderTable(); document.getElementById('selectAll').checked=false;} }
        function toggleStatusSelected() { const c=document.querySelectorAll('.user-select-cb:checked'); if(c.length===0)return alert('حدد عناصر'); const ids=Array.from(c).map(x=>parseInt(x.value)); DB[CURRENT_TAB].forEach(u=>{if(ids.includes(u.id))u.status=u.status==='active'?'inactive':'active'}); addSystemLog('تغيير حالة جماعي', `تعديل ${ids.length}`); saveDB(); renderTable(); }
        function toggleStatus(id) { const u=DB[CURRENT_TAB].find(x=>x.id===id); if(u){u.status=u.status==='active'?'inactive':'active'; addSystemLog('تغيير حالة', u.name); saveDB(); renderTable();} }
        
        function exportExcel() { 
            let list = filterByContext(DB[CURRENT_TAB] || []); 
            let isTemplate = false; 
            if (list.length === 0) { 
                alert('لا توجد بيانات مسجلة حالياً. سيتم تصدير قالب فارغ يمكنك تعبئته واستخدامه للاستيراد.'); 
                isTemplate = true; 
            } 
            let headers = []; 
            let data = []; 
            if (CURRENT_TAB === 'departments') { 
                headers = ['الترتيب', 'اسم القسم']; 
                list.forEach((row, index) => { data.push({ 'الترتيب': index + 1, 'اسم القسم': row.name }); }); 
            } else if (CURRENT_TAB === 'academic_departments') {
                headers = ['الترتيب', 'اسم القسم الأكاديمي', 'الأقسام المرتبطة']; 
                list.forEach((row, index) => { data.push({ 'الترتيب': index + 1, 'اسم القسم الأكاديمي': row.name, 'الأقسام المرتبطة': (row.linked_departments || []).join('، ') }); }); 
            } else if (CURRENT_TAB === 'teachers') { 
                headers = ['الترتيب', 'الاسم', 'القسم الأكاديمي']; 
                list.forEach((row, index) => { data.push({ 'الترتيب': index + 1, 'الاسم': row.name, 'القسم الأكاديمي': row.dept || '' }); }); 
            } else { 
                headers = ['الاسم', 'الوظيفة', 'رقم الهاتف', 'اسم المستخدم', 'كلمة المرور']; 
                list.forEach(row => { data.push({ 'الاسم': row.name, 'الوظيفة': row.job || '', 'رقم الهاتف': row.phone || '', 'اسم المستخدم': row.login || '', 'كلمة المرور': row.pass || '' }); }); 
            } 
            const ws = XLSX.utils.json_to_sheet(data, { header: headers }); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); 
            
            let filename = '';
            if (CURRENT_TAB === 'departments') filename = 'الأقسام';
            else if (CURRENT_TAB === 'academic_departments') filename = 'الأقسام_الأكاديمية';
            else if (CURRENT_TAB === 'teachers') filename = 'المعلمات';
            else if (CURRENT_TAB === 'senior') filename = 'القيادة_العليا';
            else if (CURRENT_TAB === 'middle') filename = 'القيادة_الوسطى';
            
            filename += isTemplate ? '_قالب_فارغ.xlsx' : '.xlsx';
            
            XLSX.writeFile(wb, filename); 
        }
        
        function openAddUserModal() { 
            if(!canEdit('user-management')) return alert('ليس لديك صلاحية لإضافة مستخدمين'); 
            document.getElementById('editUserId').value=''; 
            document.getElementById('addUserForm').reset(); 
            document.getElementById('addUserModal').style.display='flex'; 
            
            const roleWrapper = document.getElementById('roleWrapper'); 
            const linkedDeptsWrapper = document.getElementById('linkedDeptsWrapper');
            
            if (linkedDeptsWrapper) linkedDeptsWrapper.style.display = 'none';

            if (CURRENT_TAB === 'departments') {
                document.getElementById('addUserModalTitle').innerText = 'إضافة قسم'; 
                document.getElementById('addNameLabel').innerText = 'اسم القسم';
                document.getElementById('userFields').style.display='none'; 
                document.getElementById('deptWrapper').style.display='none';
            } else if (CURRENT_TAB === 'academic_departments') {
                document.getElementById('addUserModalTitle').innerText = 'إضافة قسم أكاديمي'; 
                document.getElementById('addNameLabel').innerText = 'اسم القسم الأكاديمي';
                document.getElementById('userFields').style.display='none'; 
                document.getElementById('deptWrapper').style.display='none';
                if (linkedDeptsWrapper) {
                    linkedDeptsWrapper.style.display='block';
                    const container = document.getElementById('linkedDeptsContainer');
                    container.innerHTML = '';
                    filterByContext(DB.departments||[]).forEach(d => {
                        container.innerHTML += `<label style="display:flex; align-items:center; gap:8px; margin-bottom:8px; cursor:pointer;"><input type="checkbox" value="${d.name}" class="linked-dept-cb custom-checkbox"> <span style="font-weight:600; color:#444;">${d.name}</span></label>`;
                    });
                }
            } else if (CURRENT_TAB === 'teachers') { 
                document.getElementById('addUserModalTitle').innerText='إضافة معلمة'; 
                document.getElementById('addNameLabel').innerText = 'الاسم الكامل';
                document.getElementById('userFields').style.display='none'; 
                document.getElementById('deptWrapper').style.display='block'; 
                const s = document.getElementById('addDept'); 
                s.innerHTML='<option value="">اختر...</option>'; 
                filterByContext(DB.academic_departments||[]).forEach(x=>s.innerHTML+=`<option value="${x.name}">${x.name}</option>`); 
            } else { 
                document.getElementById('addUserModalTitle').innerText='إضافة مستخدم'; 
                document.getElementById('addNameLabel').innerText = 'الاسم الكامل';
                document.getElementById('userFields').style.display='block'; 
                document.getElementById('deptWrapper').style.display='none'; 
                roleWrapper.style.display = 'block'; 
            } 
        }
        
        function editUser(id) { 
            if(!canEdit('user-management')) return; 
            const u = DB[CURRENT_TAB].find(x => x.id === id); 
            if(!u) return; 
            openAddUserModal(); 
            document.getElementById('editUserId').value = u.id; 
            document.getElementById('addUserModalTitle').innerText = 'تعديل ' + u.name; 
            document.getElementById('addName').value = u.name; 
            
            if (CURRENT_TAB === 'academic_departments') {
                const linked = u.linked_departments || [];
                document.querySelectorAll('.linked-dept-cb').forEach(cb => {
                    cb.checked = linked.includes(cb.value);
                });
            } else if (CURRENT_TAB === 'teachers') { 
                const s = document.getElementById('addDept'); 
                s.innerHTML = '<option value="">اختر...</option>'; 
                filterByContext(DB.academic_departments||[]).forEach(x => s.innerHTML += `<option value="${x.name}">${x.name}</option>`); 
                document.getElementById('addDept').value = u.dept; 
            } else if (CURRENT_TAB !== 'departments' && CURRENT_TAB !== 'academic_departments') { 
                document.getElementById('addJob').value = u.job || ''; 
                document.getElementById('addPhone').value = u.phone || ''; 
                document.getElementById('addLogin').value = u.login || ''; 
                document.getElementById('addPass').value = u.pass || ''; 
                document.getElementById('addRole').value = u.role || ''; 
            } 
        }

        function closeModal(id) { document.getElementById(id).style.display='none'; }

        function saveUserForm() { 
            const n = document.getElementById('addName').value.trim(); 
            if(!n) return alert('الاسم مطلوب'); 
            const idRaw = document.getElementById('editUserId').value; 
            let u; 

            if(idRaw && idRaw.trim() !== "") { 
                u = DB[CURRENT_TAB].find(x => x.id.toString() === idRaw.toString()); 
                if(!u) return alert("خطأ: المستخدم غير موجود");
                u.name = n; 
                u.lastUpdated = new Date().toLocaleString('en-GB'); 
                u.lastUpdatedBy = CURRENT_USER.name; 
                
                if(CURRENT_TAB === 'teachers') u.dept = document.getElementById('addDept').value; 
                else if(CURRENT_TAB === 'academic_departments') u.linked_departments = Array.from(document.querySelectorAll('.linked-dept-cb:checked')).map(cb => cb.value);
                else if(CURRENT_TAB !== 'departments' && CURRENT_TAB !== 'academic_departments') { 
                    u.job = document.getElementById('addJob').value; 
                    u.phone = document.getElementById('addPhone').value; 
                    u.login = document.getElementById('addLogin').value; 
                    u.pass = document.getElementById('addPass').value; 
                    u.role = document.getElementById('addRole').value; 
                } 
                addSystemLog('تعديل مستخدم', u.name);
            } else { 
                u = { 
                    id: Date.now(), name: n, status: 'active', lastUpdated: new Date().toLocaleString('en-GB'), lastUpdatedBy: CURRENT_USER.name, brandId: CURRENT_BRAND.id, allowedBrands: [CURRENT_BRAND.id], dateAdded: new Date().toLocaleDateString('en-GB'), permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS))
                }; 
                
                if(CURRENT_TAB === 'teachers') u.dept = document.getElementById('addDept').value; 
                else if(CURRENT_TAB === 'academic_departments') u.linked_departments = Array.from(document.querySelectorAll('.linked-dept-cb:checked')).map(cb => cb.value);
                else if(CURRENT_TAB !== 'departments' && CURRENT_TAB !== 'academic_departments') { 
                    u.job = document.getElementById('addJob').value; u.phone = document.getElementById('addPhone').value; u.login = document.getElementById('addLogin').value; u.pass = document.getElementById('addPass').value; u.role = document.getElementById('addRole').value; 
                } 
                DB[CURRENT_TAB].push(u); 
                addSystemLog('إضافة مستخدم', u.name);
            } 
            saveDB(); renderTable(); closeModal('addUserModal'); 
        }

        function deleteUser(id) { if(!canEdit('user-management')) return; if(confirm('حذف؟')){DB[CURRENT_TAB]=DB[CURRENT_TAB].filter(u=>u.id!==id); saveDB(); renderTable();} }
        
        function viewUser(id) { 
            const u = DB[CURRENT_TAB].find(x => x.id === id); 
            let roleTxt = 'مستخدم عادي'; if(u.role === 'supervisor') roleTxt = 'مشرف نظام'; if(u.role === 'admin_support') roleTxt = 'إداري نظام'; 
            
            let extraFields = '';
            if (CURRENT_TAB === 'academic_departments') {
                const linkedStr = (u.linked_departments && u.linked_departments.length > 0) ? u.linked_departments.join('، ') : 'لا توجد أقسام مرتبطة';
                extraFields = `<div class="info-item" style="grid-column: 1 / -1;"><label>الأقسام العادية المرتبطة بهذا القسم الأكاديمي</label><span style="white-space:normal; line-height:1.6; font-weight:bold; color:var(--primary);">${linkedStr}</span></div>`;
            } else if (CURRENT_TAB !== 'departments' && CURRENT_TAB !== 'academic_departments' && CURRENT_TAB !== 'teachers') {
                extraFields = `<div class="info-item"><label>الصلاحية الإضافية</label><span>${roleTxt}</span></div>`;
            }

            document.getElementById('viewUserContent').innerHTML = `<div class="user-view-card"><div class="user-view-avatar">${u.name.charAt(0)}</div><h3 style="color:var(--primary); margin:0;">${u.name}</h3></div><div class="info-grid"><div class="info-item"><label>الوظيفة / القسم</label><span>${u.job || u.dept || '-'}</span></div><div class="info-item"><label>رقم الهاتف</label><span>${u.phone || '-'}</span></div><div class="info-item"><label>الحالة</label><span style="color:${u.status==='active'?'green':'red'}">${u.status==='active'?'مفعل':'معطل'}</span></div><div class="info-item"><label>اسم الدخول</label><span style="background:#eee; padding:2px 5px; border-radius:4px;">${u.login || '-'}</span></div>${extraFields}</div><div class="view-footer-info"><div>آخر تحديث بواسطة: <strong>${u.lastUpdatedBy || 'N/A'}</strong></div><div>${u.lastUpdated || '-'}</div></div>`; 
            document.getElementById('viewUserModal').style.display = 'flex'; 
        }
        
        function openPerms(id) { EDITING_PERM_ID = id; IS_BULK_PERM_MODE = false; const u = DB[CURRENT_TAB].find(x => x.id === id); if(!u) return; document.getElementById('permTargetName').innerText = `صلاحيات: ${u.name}`; renderPermList(u.permissions); document.getElementById('permModal').style.display = 'flex'; }
        function openBulkPerms() { const c = document.querySelectorAll('.user-select-cb:checked'); if(c.length === 0) return alert('يرجى تحديد مستخدمين أولاً'); EDITING_PERM_ID = null; IS_BULK_PERM_MODE = true; document.getElementById('permTargetName').innerText = `تعديل صلاحيات لـ ${c.length} مستخدمين`; renderPermList(DEFAULT_PERMS); document.getElementById('permModal').style.display = 'flex'; }
        function renderPermList(perms) { const list = document.getElementById('permList'); list.innerHTML = ''; SECTIONS.forEach(s => { if (s.id === 'system-admin') return; const p = perms[s.id] || {view: false, edit: false}; list.innerHTML += `<div class="perm-item"><span>${s.name}</span><div><label style="margin-left:15px;"><input type="checkbox" class="perm-check-view" data-sec="${s.id}" ${p.view?'checked':''}> معاينة</label><label><input type="checkbox" class="perm-check-edit" data-sec="${s.id}" ${p.edit?'checked':''}> تعديل</label></div></div>`; }); }
        function toggleAllPerms(type, cb) { document.querySelectorAll(`.perm-check-${type}`).forEach(c => c.checked = cb.checked); }
        function submitPermissions() { const newPerms = {}; SECTIONS.forEach(s => { if(s.id === 'system-admin') return; newPerms[s.id] = { view: document.querySelector(`.perm-check-view[data-sec="${s.id}"]`).checked, edit: document.querySelector(`.perm-check-edit[data-sec="${s.id}"]`).checked }; }); if (IS_BULK_PERM_MODE) { const checkboxes = document.querySelectorAll('.user-select-cb:checked'); const ids = Array.from(checkboxes).map(x => parseInt(x.value)); DB[CURRENT_TAB].forEach(u => { if(ids.includes(u.id)) u.permissions = JSON.parse(JSON.stringify(newPerms)); }); addSystemLog('تعديل صلاحيات جماعي', `لـ ${ids.length} مستخدمين`); } else { const u = DB[CURRENT_TAB].find(x => x.id === EDITING_PERM_ID); if(u) { u.permissions = newPerms; addSystemLog('تعديل صلاحيات', u.name); } } saveDB(); closeModal('permModal'); }
        
        function triggerImportExcel() { document.getElementById('importExcelInput').click(); }
        function handleExcelImport(input) { 
            if (input.files && input.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = function(e) { 
                    const data = new Uint8Array(e.target.result); 
                    const workbook = XLSX.read(data, {type: 'array'}); 
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; 
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ""}); 
                    if (jsonData.length === 0) return alert('الملف فارغ!'); 
                    let count = 0; let skipped = 0; const dateAdded = new Date().toLocaleDateString('en-GB'); 
                    jsonData.forEach((row, index) => { 
                        let name = '';
                        if (CURRENT_TAB === 'departments') { 
                            name = row['اسم القسم'] || row['الاسم'] || row['Name'] || ''; 
                        } else if (CURRENT_TAB === 'academic_departments') {
                            name = row['اسم القسم الأكاديمي'] || row['اسم القسم'] || row['الاسم'] || row['Name'] || '';
                        } else {
                            name = row['الاسم'] || row['Name'] || '';
                        }
                        
                        if (name) { 
                            const exists = DB[CURRENT_TAB].some(u => u.name === name && u.brandId === CURRENT_BRAND.id); 
                            if (!exists) { 
                                const newUser = { id: Date.now() + index, name: name, status: 'active', permissions: JSON.parse(JSON.stringify(DEFAULT_PERMS)), dateAdded: dateAdded, lastUpdated: new Date().toLocaleString('en-GB'), lastUpdatedBy: CURRENT_USER ? CURRENT_USER.name : 'Import', brandId: CURRENT_BRAND.id, allowedBrands: [CURRENT_BRAND.id] }; 
                                if (CURRENT_TAB === 'departments') { DB[CURRENT_TAB].push(newUser); count++; } 
                                else if (CURRENT_TAB === 'academic_departments') { 
                                    let linkedRaw = row['الأقسام المرتبطة'] || '';
                                    newUser.linked_departments = linkedRaw ? String(linkedRaw).split('،').map(s=>s.trim()).filter(Boolean) : [];
                                    DB[CURRENT_TAB].push(newUser); count++; 
                                }
                                else if (CURRENT_TAB === 'teachers') { newUser.dept = row['القسم الأكاديمي'] || row['القسم'] || row['Department'] || ''; DB[CURRENT_TAB].push(newUser); count++; } 
                                else { newUser.job = row['الوظيفة'] || row['Job'] || ''; newUser.phone = row['رقم الهاتف'] || row['Phone'] || ''; newUser.login = row['اسم المستخدم'] || row['User'] || ''; newUser.pass = row['كلمة المرور'] || row['Pass'] || ''; DB[CURRENT_TAB].push(newUser); count++; } 
                            } else { skipped++; } 
                        } 
                    }); 
                    if (count > 0) { saveDB(); renderTable(); alert(`تم استيراد ${count} سجل بنجاح.`); } else { alert('لم يتم استيراد أي سجل جديد.'); } 
                    input.value = ""; 
                }; 
                reader.readAsArrayBuffer(input.files[0]); 
            } 
        }
        
        function exportSpecificExcel(type) { 
            let data = []; let headers = []; let filename = ''; 
            if (type === 'visits') { 
                const list = (CURRENT_VISIT_TAB === 'senior') ? DB.visits_senior : DB.visits_middle; 
                const filteredList = filterByContext(list); 
                headers = ['التاريخ', 'القسم', 'المعلم', 'التقييم', 'الزائر']; 
                filteredList.forEach(v => data.push({'التاريخ':v.date, 'القسم':v.dept, 'المعلم':v.teacher, 'التقييم':v.eval, 'الزائر':v.visitor})); 
                filename = (CURRENT_VISIT_TAB === 'senior' ? 'زيارات_القيادة_العليا' : 'زيارات_القيادة_الوسطى') + '.xlsx'; 
            } else if (type === 'qualitative') { 
                headers = ['التاريخ', 'القسم الأكاديمي', 'جوانب القوة', 'جوانب التطوير']; 
                filterByContext(DB.qualitative_reports).forEach(q => data.push({'التاريخ':q.date, 'القسم الأكاديمي':q.dept, 'جوانب القوة':q.strength, 'جوانب التطوير':q.improve})); 
                filename = 'التقرير_النوعي.xlsx';
            } else if (type === 'distinguished') { 
                headers = ['التاريخ', 'القسم الأكاديمي', 'المعلم', 'التقييم', 'المبررات']; 
                filterByContext(DB.distinguished).forEach(d => data.push({'التاريخ':d.date, 'القسم الأكاديمي':d.dept, 'المعلم':d.teacher, 'التقييم':d.eval, 'المبررات':d.reason})); 
                filename = 'المعلمين_المتميزين.xlsx';
            } else if (type === 'care') { 
                headers = ['التاريخ', 'القسم الأكاديمي', 'المعلم', 'التقييم', 'المبررات']; 
                filterByContext(DB.care_needed).forEach(d => data.push({'التاريخ':d.date, 'القسم الأكاديمي':d.dept, 'المعلم':d.teacher, 'التقييم':d.eval, 'المبررات':d.reason})); 
                filename = 'المعلمين_الأولى_بالرعاية.xlsx';
            } 
            const ws = XLSX.utils.json_to_sheet(data, { header: headers }); 
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); 
            XLSX.writeFile(wb, filename); 
        }
        
        function getVisitorJobByName(name) {
            if (!name) return 'غير محدد';
            const u1 = (DB.senior || []).find(u => u.name.trim() === name.trim());
            if (u1) return u1.job || 'القيادة العليا';
            const u2 = (DB.middle || []).find(u => u.name.trim() === name.trim());
            if (u2) return u2.job || 'القيادة الوسطى';
            return 'غير محدد';
        }

        function triggerImportExcelGeneric(type) { CURRENT_IMPORT_TARGET = type; document.getElementById('importExcelGenericInput').click(); }
        function handleExcelImportGeneric(input) { 
            if (!input.files || !input.files[0]) return; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                const data = new Uint8Array(e.target.result); 
                const workbook = XLSX.read(data, {type: 'array'}); 
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); 
                if (jsonData.length === 0) return alert('الملف فارغ'); 
                let count = 0; 
                const targetType = CURRENT_IMPORT_TARGET; 
                jsonData.forEach((row, idx) => { 
                    const id = Date.now() + idx; 
                    if (targetType === 'visits') { 
                        const arr = (CURRENT_VISIT_TAB === 'senior') ? DB.visits_senior : DB.visits_middle; 
                        let vName = row['الزائر'] || CURRENT_USER.name; let vJob = getVisitorJobByName(vName); 
                        if(!arr) arr = [];
                        arr.push({ id: id, date: row['التاريخ'] || new Date().toISOString().slice(0,10), dept: row['القسم'] || '', teacher: row['المعلم'] || '', eval: row['التقييم'] || '', visitor: vName, visitorJob: vJob, brandId: CURRENT_BRAND.id }); count++; 
                    } else if (targetType === 'qualitative') { 
                        if(!DB.qualitative_reports) DB.qualitative_reports = [];
                        DB.qualitative_reports.push({ id: id, date: row['التاريخ'] || new Date().toISOString().slice(0,10), dept: row['القسم الأكاديمي'] || row['القسم'] || '', strength: row['جوانب القوة'] || '', improve: row['جوانب التطوير'] || '', brandId: CURRENT_BRAND.id }); count++; 
                    } else if (targetType === 'distinguished') { 
                        if(!DB.distinguished) DB.distinguished = [];
                        DB.distinguished.push({ id: id, date: row['التاريخ'] || new Date().toISOString().slice(0,10), dept: row['القسم الأكاديمي'] || row['القسم'] || '', teacher: row['المعلم'] || '', eval: row['التقييم'] || '', reason: row['المبررات'] || '', brandId: CURRENT_BRAND.id }); count++; 
                    } else if (targetType === 'care') { 
                        if(!DB.care_needed) DB.care_needed = [];
                        DB.care_needed.push({ id: id, date: row['التاريخ'] || new Date().toISOString().slice(0,10), dept: row['القسم الأكاديمي'] || row['القسم'] || '', teacher: row['المعلم'] || '', eval: row['التقييم'] || '', reason: row['المبررات'] || '', brandId: CURRENT_BRAND.id }); count++; 
                    } 
                }); 
                if (count > 0) { 
                    saveDB(); 
                    alert(`تم استيراد ${count} سجل بنجاح.`); 
                    if(targetType === 'visits') {
                        document.getElementById('visitMonthFilter').value = 'all';
                        handleDateFilterChange('visit', renderVisitsTable);
                    }
                    if(targetType === 'qualitative') {
                        document.getElementById('qualMonthFilter').value = 'all';
                        handleDateFilterChange('qual', renderQualitativeTable);
                    }
                    if(targetType === 'distinguished' || targetType === 'care') {
                        document.getElementById('distMonthFilter').value = 'all';
                        handleDateFilterChange('dist', renderDistinguishedTables);
                    }
                } 
                input.value = ''; 
            }; 
            reader.readAsArrayBuffer(input.files[0]); 
        }
        
        function renderBrandsTable() { 
            if(!isAdminUser()) return; 
            const tbody = document.getElementById('brandsTableBody'); tbody.innerHTML = ''; 
            DB.brands.forEach((b, idx) => { 
                const isDefault = (b.id === 1); const today = new Date().toISOString().split('T')[0]; 
                const isExpired = b.endDate && b.endDate < today; const isActive = b.status === 'active'; 
                let statusBadge; 
                if(isExpired) { statusBadge = `<span class="status-badge status-inactive">منتهية الصلاحية</span>`; } 
                else { statusBadge = isActive ? `<span class="status-badge status-active">نشط</span>` : `<span class="status-badge status-inactive">معطل</span>`; } 
                
                const deleteBtn = isDefault ? '' : `<button class="action-btn btn-delete" onclick="deleteBrand(${b.id})" title="حذف"><i class="fas fa-trash"></i></button>`; 
                const resetBtn = `<button class="action-btn btn-reset" onclick="resetBrandData(${b.id})" title="إعادة تهيئة"><i class="fas fa-redo"></i></button>`; 
                const toggleBtn = `<button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleBrandStatus(${b.id})" title="${isActive?'تعطيل':'تفعيل'}"><i class="fas fa-power-off"></i></button>`;
                
                let validityStr = '-'; 
                if(b.startDate || b.endDate) { const start = b.startDate || 'غير محدد'; const end = b.endDate || 'غير محدد'; validityStr = `<div style="font-size:0.8rem; line-height:1.2;">من: ${start}<br>إلى: ${end}</div>`; } 
                
                tbody.innerHTML += `<tr>
                    <td>${idx+1}</td>
                    <td style="font-weight:bold; color:var(--primary);">${b.name}</td>
                    <td>${b.email || '-'}</td>
                    <td>${validityStr}</td>
                    <td>${statusBadge}</td>
                    <td><div style="display:flex; gap:4px; justify-content:flex-start;">
                        <button class="action-btn btn-edit" onclick="editBrand(${b.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                        ${toggleBtn}
                        ${resetBtn}
                        ${deleteBtn}
                    </div></td>
                </tr>`; 
            }); 
        }

        function openBrandModal() { document.getElementById('brandForm').reset(); document.getElementById('editBrandId').value = ''; document.getElementById('brandModalTitle').innerText = 'إضافة براند جديد'; document.getElementById('brandModal').style.display = 'flex'; }
        function editBrand(id) { const b = DB.brands.find(x => x.id === id); if(b) { document.getElementById('editBrandId').value = b.id; document.getElementById('brandName').value = b.name; document.getElementById('brandEmail').value = b.email; document.getElementById('brandStartDate').value = b.startDate || ''; document.getElementById('brandEndDate').value = b.endDate || ''; document.getElementById('brandModalTitle').innerText = 'تعديل البراند'; document.getElementById('brandModal').style.display = 'flex'; } }
        function saveBrand() { const id = document.getElementById('editBrandId').value; const name = document.getElementById('brandName').value; const email = document.getElementById('brandEmail').value; const startDate = document.getElementById('brandStartDate').value; const endDate = document.getElementById('brandEndDate').value; if(!name) return alert('اسم البراند مطلوب'); if(id) { const b = DB.brands.find(x => x.id == id); if(b) { b.name = name; b.email = email; b.startDate = startDate; b.endDate = endDate; addSystemLog('تعديل براند', name); } } else { DB.brands.push({ id: Date.now(), name: name, email: email, status: 'active', startDate: startDate, endDate: endDate }); addSystemLog('إضافة براند', name); } saveDB(); renderBrandsTable(); updateBrandUI(); closeModal('brandModal'); }
        function toggleBrandStatus(id) { const b = DB.brands.find(x => x.id === id); if(b) { b.status = (b.status === 'active' ? 'inactive' : 'active'); saveDB(); renderBrandsTable(); updateBrandUI(); if(b.status === 'inactive' && CURRENT_BRAND.id === id) switchBrand(1); } }
        function deleteBrand(id) { if(confirm('هل أنت متأكد من حذف هذا البراند؟ سيتم إخفاء جميع البيانات المرتبطة به.')) { DB.brands = DB.brands.filter(x => x.id !== id); resetBrandData(id, true); saveDB(); renderBrandsTable(); updateBrandUI(); if(CURRENT_BRAND.id === id) switchBrand(1); } }
        function resetBrandData(brandId, silent = false) { if(!silent && !confirm('تحذير: سيتم مسح جميع البيانات والمدخلات والمستخدمين والتقارير الخاصة بهذا البراند بشكل نهائي.\nهل أنت متأكد؟')) return; const arraysToClean = [ 'senior', 'middle', 'teachers', 'departments', 'academic_departments', 'visits_senior', 'visits_middle', 'distinguished', 'care_needed', 'qualitative_reports', 'saved_reports' ]; arraysToClean.forEach(key => { if(DB[key]) { DB[key] = DB[key].filter(item => { if(item.id === 999) return true; const itemBrand = item.brandId || 1; return itemBrand !== brandId; }); } }); saveDB(); if(!silent) alert('تمت إعادة تهيئة بيانات البراند بنجاح.'); if(CURRENT_BRAND.id === brandId) location.reload(); }

        function setVisitTab(tab, el) { 
            CURRENT_VISIT_TAB = tab; 
            document.querySelectorAll('#visits .custom-tab').forEach(t => t.classList.remove('active')); 
            el.classList.add('active'); 
            updateDateFilterOptions((CURRENT_VISIT_TAB === 'senior' ? filterByContext(DB.visits_senior) : filterByContext(DB.visits_middle)), 'visitMonthFilter'); 
            renderVisitsTable();
            checkVisitButtonAuth();
        }
        
        function checkVisitButtonAuth() {
            const btn = document.getElementById('btnAddVisit');
            if(!btn) return;
            let show = false;
            if(isAdminUser()) {
                show = true;
            } else {
                const isSenior = DB.senior.some(u => u.id === CURRENT_USER.id);
                const isMiddle = DB.middle.some(u => u.id === CURRENT_USER.id);
                if(CURRENT_VISIT_TAB === 'senior' && isSenior) show = true;
                else if(CURRENT_VISIT_TAB === 'middle' && isMiddle) show = true;
            }
            btn.style.display = show ? 'inline-flex' : 'none';
        }
        
        function renderVisitsTable() { 
            const collection = (CURRENT_VISIT_TAB === 'senior') ? 'visits_senior' : 'visits_middle';
            const list = DB[collection] || [];
            const filteredContext = filterByContext(list); 
            const filtered = getFilteredData(filteredContext, 'visit');

            const tbody = document.getElementById('visitsTableBody'); 
            tbody.innerHTML = ''; 
            const canEditVisits = canEdit('visits');

            filtered.forEach(v => { 
                let displayJob = v.visitorJob || '-';
                const userPool = CURRENT_VISIT_TAB === 'senior' ? DB.senior : DB.middle;
                const uMatch = (userPool || []).find(u => u.name === v.visitor);
                if(uMatch && uMatch.job) {
                    displayJob = uMatch.job;
                }

                let row = `<tr>
                    <td>${v.date}</td>
                    <td style="font-weight:bold;">${v.dept}</td>
                    <td style="color:var(--primary); font-weight:bold;">${v.teacher}</td>
                    <td><span style="background:#eef4ff; color:var(--primary); padding:4px 8px; border-radius:4px; font-size:0.85rem;">${v.eval}</span></td>
                    <td>${v.visitor}</td>
                    <td>${displayJob}</td>
                    <td>
                        <div style="display:flex; justify-content:center; gap:4px;">
                            <button class="action-btn btn-view" onclick="viewVisit(${v.id})" title="معاينة"><i class="fas fa-eye"></i></button>`;
                
                if(canEditVisits) {
                    row += `<button class="action-btn btn-move" onclick="moveItem('${collection}', ${v.id}, 'up')" title="نقل لأعلى"><i class="fas fa-arrow-up"></i></button>
                            <button class="action-btn btn-move" onclick="moveItem('${collection}', ${v.id}, 'down')" title="نقل لأسفل"><i class="fas fa-arrow-down"></i></button>
                            <button class="action-btn btn-edit" onclick="editVisit(${v.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteVisit(${v.id})" title="حذف"><i class="fas fa-trash"></i></button>`;
                }
                
                row += `</div></td></tr>`;
                tbody.innerHTML += row;
            }); 
        }
        
        function renderPerformanceChart() {
            let allVisitsRaw = [...filterByContext(DB.visits_senior), ...filterByContext(DB.visits_middle)];
             const isRestricted = !isAdminUser() && !DB.senior.some(u => u.id === CURRENT_USER.id); 
            if (isRestricted && CURRENT_USER.dept) { allVisitsRaw = allVisitsRaw.filter(x => x.dept === CURRENT_USER.dept); }

            const filtered = getFilteredData(allVisitsRaw, 'perf');

            const gradeCounts = {};
            filtered.forEach(v => { gradeCounts[v.eval||'غير محدد'] = (gradeCounts[v.eval||'غير محدد'] || 0) + 1; });
            const chartLabels = Object.keys(gradeCounts);
            const chartData = Object.values(gradeCounts);

            if (performanceChartInstance) performanceChartInstance.destroy();
            const ctx = document.getElementById('perfChart').getContext('2d');
            performanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels.length ? chartLabels : ['لا توجد بيانات'],
                    datasets: [{
                        label: 'عدد المعلمين',
                        data: chartLabels.length ? chartData : [0],
                        backgroundColor: '#2b579a',
                        barThickness: 40,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function openAddVisitModal() { 
            document.getElementById('addVisitForm').reset(); 
            document.getElementById('visitEditId').value = ''; 
            const dSelect = document.getElementById('visitDept'); 
            dSelect.innerHTML = '<option value="">اختر القسم...</option>'; 
            filterByContext(DB.academic_departments||DB.departments||[]).forEach(d => dSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`); 
            const eSelect = document.getElementById('visitEval'); 
            eSelect.innerHTML = '<option value="">اختر التقدير...</option>'; 
            (DB.settings.evaluation_grades || []).forEach(c => { 
                if(c.status === 'active') eSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`; 
            });
            document.getElementById('addVisitModal').style.display='flex'; 
        }

        function editVisit(id) {
            const collection = (CURRENT_VISIT_TAB === 'senior') ? DB.visits_senior : DB.visits_middle;
            const v = collection.find(x => x.id === id);
            if(!v) return;
            openAddVisitModal();
            document.getElementById('visitEditId').value = v.id;
            document.getElementById('visitDept').value = v.dept;
            onVisitDeptChange();
            document.getElementById('visitTeacher').value = v.teacher;
            document.getElementById('visitDate').value = v.date;
            document.getElementById('visitEval').value = v.eval;
        }

        function viewVisit(id) {
            const collection = (CURRENT_VISIT_TAB === 'senior') ? DB.visits_senior : DB.visits_middle;
            const v = collection.find(x => x.id === id);
            if(!v) return;
            document.getElementById('viewVisitContent').innerHTML = `
                <div class="info-grid" style="grid-template-columns: 1fr;">
                    <div class="info-item"><label>التاريخ:</label> <span>${v.date}</span></div>
                    <div class="info-item"><label>القسم:</label> <span>${v.dept}</span></div>
                    <div class="info-item"><label>المعلمة:</label> <span>${v.teacher}</span></div>
                    <div class="info-item"><label>التقييم:</label> <span style="color:var(--primary); font-weight:bold;">${v.eval}</span></div>
                    <div class="info-item"><label>الزائر:</label> <span>${v.visitor} <small>(${v.visitorJob})</small></span></div>
                </div>`;
            document.getElementById('viewVisitModal').style.display = 'flex';
        }

        function onVisitDeptChange() { const dept = document.getElementById('visitDept').value; const tSelect = document.getElementById('visitTeacher'); tSelect.innerHTML = '<option value="">اختر المعلم/ة...</option>'; if(dept) { filterByContext(DB.teachers||[]).filter(t => t.dept === dept).forEach(t => tSelect.innerHTML += `<option value="${t.name}">${t.name}</option>`); } }
        
        function saveVisit() { 
            const id = document.getElementById('visitEditId').value;
            const dept = document.getElementById('visitDept').value; 
            const teacher = document.getElementById('visitTeacher').value; 
            const date = document.getElementById('visitDate').value; 
            const ev = document.getElementById('visitEval').value; 
            if(!dept || !teacher || !date || !ev) return alert('جميع الحقول مطلوبة'); 
            
            const collection = (CURRENT_VISIT_TAB === 'senior') ? 'visits_senior' : 'visits_middle';
            
            if(id) {
                const v = DB[collection].find(x => x.id.toString() === id.toString());
                if(v) {
                    v.dept = dept; v.teacher = teacher; v.date = date; v.eval = ev;
                    addSystemLog('تعديل زيارة', teacher);
                }
            } else {
                const obj = { id: Date.now(), dept, teacher, date, eval: ev, visitor: CURRENT_USER.name, visitorJob: CURRENT_USER.job || 'مسؤول', brandId: CURRENT_BRAND.id }; 
                DB[collection].push(obj); 
                addSystemLog('إضافة زيارة', teacher);
            }
            saveDB(); renderVisitsTable(); closeModal('addVisitModal'); 
        }

        function deleteVisit(id) { if(confirm('حذف؟')) { if(CURRENT_VISIT_TAB === 'senior') DB.visits_senior = DB.visits_senior.filter(x => x.id !== id); else DB.visits_middle = DB.visits_middle.filter(x => x.id !== id); saveDB(); renderVisitsTable(); } }
        
        // --- Selection Logic for Distinguished/Care ---
        window.toggleSelectAllDist = function(type, cb) {
            const tableId = type === 'distinguished' ? 'distinguishedTableBody' : 'careTableBody';
            const checkboxes = document.querySelectorAll(`#${tableId} .dist-select-cb`);
            checkboxes.forEach(c => c.checked = cb.checked);
        };
        
        window.deleteSelectedDistinguished = function(type) {
            const tableId = type === 'distinguished' ? 'distinguishedTableBody' : 'careTableBody';
            const checkboxes = document.querySelectorAll(`#${tableId} .dist-select-cb:checked`);
            if(checkboxes.length === 0) return alert('يرجى تحديد عناصر أولاً');
            if(confirm('هل أنت متأكد من حذف العناصر المحددة؟')) {
                const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
                const key = type === 'distinguished' ? 'distinguished' : 'care_needed';
                DB[key] = DB[key].filter(x => !ids.includes(x.id));
                saveDB();
                renderDistinguishedTables();
                const masterCb = document.getElementById(type === 'distinguished' ? 'selectAllDist' : 'selectAllCare');
                if(masterCb) masterCb.checked = false;
            }
        };

        function renderDistinguishedTables() { 
            const distListRaw = filterByContext(DB.distinguished||[]);
            const careListRaw = filterByContext(DB.care_needed||[]);
            
            const distList = getFilteredData(distListRaw, 'dist');
            const careList = getFilteredData(careListRaw, 'dist');

            const t1 = document.getElementById('distinguishedTableBody'); 
            const t2 = document.getElementById('careTableBody'); 
            t1.innerHTML = ''; t2.innerHTML = ''; 
            
            distList.forEach((d, i) => { 
                t1.innerHTML += `<tr>
                    <td><input type="checkbox" class="custom-checkbox dist-select-cb" value="${d.id}"></td>
                    <td>${i+1}</td>
                    <td>${d.date}</td>
                    <td style="color:var(--primary); font-weight:bold;">${d.teacher}</td>
                    <td>${d.dept}</td>
                    <td><span class="status-badge status-active">${d.eval}</span></td>
                    <td style="text-align:right;">${d.reason}</td>
                    <td>
                        <div style="display:flex; justify-content:center; gap:4px;">
                            <button class="action-btn btn-edit" onclick="editDistItem('distinguished', ${d.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteDistItem('distinguished', ${d.id})" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`; 
            }); 
            careList.forEach((d, i) => { 
                t2.innerHTML += `<tr>
                    <td><input type="checkbox" class="custom-checkbox dist-select-cb" value="${d.id}"></td>
                    <td>${i+1}</td>
                    <td>${d.date}</td>
                    <td style="color:var(--danger); font-weight:bold;">${d.teacher}</td>
                    <td>${d.dept}</td>
                    <td><span class="status-badge status-inactive">${d.eval}</span></td>
                    <td style="text-align:right;">${d.reason}</td>
                    <td>
                        <div style="display:flex; justify-content:center; gap:4px;">
                            <button class="action-btn btn-edit" onclick="editDistItem('care_needed', ${d.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteDistItem('care_needed', ${d.id})" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`; 
            }); 
        }

        window.editDistItem = function(key, id) {
            if(!canEdit('distinguished')) return;
            const item = DB[key].find(x => x.id === id);
            if(!item) return;
            const type = (key === 'distinguished') ? 'distinguished' : 'care';
            openDistinguishedModal(type); 
            document.getElementById('distEditId').value = item.id;
            document.getElementById('distDate').value = item.date;
            document.getElementById('distDept').value = item.dept;
            onDistinguishedDeptChange(); 
            document.getElementById('distTeacher').value = item.teacher;
            document.getElementById('distEval').value = item.eval;
            document.getElementById('distReason').value = item.reason;
        };

        function openDistinguishedModal(type) { 
            document.getElementById('distType').value = type; 
            document.getElementById('distEditId').value = ''; 
            document.getElementById('distinguishedForm').reset(); 
            document.getElementById('distinguishedModalTitle').innerText = (type === 'distinguished' ? 'إضافة معلم متميز' : 'إضافة معلم يحتاج رعاية'); 
            const dSelect = document.getElementById('distDept'); 
            dSelect.innerHTML = '<option value="">اختر القسم...</option>'; 
            filterByContext(DB.academic_departments||[]).forEach(d => dSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`); 
            const eSelect = document.getElementById('distEval'); 
            eSelect.innerHTML = '<option value="">اختر التقدير...</option>'; 
            (DB.settings.evaluation_grades||[]).forEach(g => { if(g.status === 'active') eSelect.innerHTML += `<option value="${g.name}">${g.name}</option>`; }); 
            document.getElementById('distinguishedModal').style.display='flex'; 
        }
        
        function onDistinguishedDeptChange() { 
            const deptName = document.getElementById('distDept').value; 
            const tSelect = document.getElementById('distTeacher'); 
            tSelect.innerHTML = '<option value="">اختر المعلم/ة...</option>'; 
            if(deptName) { 
                const acadDept = filterByContext(DB.academic_departments||[]).find(d => d.name === deptName);
                let linked = [];
                if(acadDept && acadDept.linked_departments && acadDept.linked_departments.length > 0) {
                    linked = acadDept.linked_departments;
                } else {
                    linked = [deptName];
                }
                filterByContext(DB.teachers||[]).filter(t => linked.includes(t.dept)).forEach(t => {
                    tSelect.innerHTML += `<option value="${t.name}">${t.name}</option>`;
                });
            } 
        }
        
        function saveDistinguishedEntry() { 
            const type = document.getElementById('distType').value; 
            const key = (type === 'distinguished') ? 'distinguished' : 'care_needed'; 
            const id = document.getElementById('distEditId').value;
            const dept = document.getElementById('distDept').value; 
            const teacher = document.getElementById('distTeacher').value; 
            const date = document.getElementById('distDate').value || new Date().toISOString().slice(0,10); 
            const ev = document.getElementById('distEval').value; 
            const reason = document.getElementById('distReason').value; 
            
            if(!dept || !teacher || !date) return alert('البيانات ناقصة'); 
            
            if(id) {
                const item = DB[key].find(x => x.id.toString() === id.toString());
                if(item) { item.dept = dept; item.teacher = teacher; item.date = date; item.eval = ev; item.reason = reason; }
            } else {
                const obj = { id: Date.now(), dept, teacher, date, eval: ev, reason, brandId: CURRENT_BRAND.id }; 
                if(!DB[key]) DB[key] = []; 
                DB[key].push(obj); 
            }
            saveDB(); renderDistinguishedTables(); closeModal('distinguishedModal'); 
        }

        window.deleteDistItem = function(key, id) { if(confirm('حذف؟')) { DB[key] = DB[key].filter(x => x.id !== id); saveDB(); renderDistinguishedTables(); } }
        
        function renderQualitativeTable() { 
            const listRaw = filterByContext(DB.qualitative_reports||[]); 
            const list = getFilteredData(listRaw, 'qual');
            const tbody = document.getElementById('qualitativeTableBody'); 
            tbody.innerHTML = ''; 
            list.forEach((q, i) => { 
                tbody.innerHTML += `<tr><td>${i+1}</td><td>${q.date}</td><td style="font-weight:bold;">${q.dept}</td><td style="text-align:right; white-space:pre-wrap;">${q.strength}</td><td style="text-align:right; white-space:pre-wrap;">${q.improve}</td><td>
                    <div style="display:flex; justify-content:center; gap:4px;">
                        <button class="action-btn btn-edit" onclick="editQualitative(${q.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteQualitative(${q.id})" title="حذف"><i class="fas fa-trash"></i></button>
                    </div>
                </td></tr>`; 
            }); 
        }

        window.editQualitative = function(id) {
            if(!canEdit('qualitative')) return;
            const item = DB.qualitative_reports.find(x => x.id === id);
            if(!item) return;
            openQualitativeModal(); 
            document.getElementById('qualEditId').value = item.id;
            document.getElementById('qualDate').value = item.date;
            document.getElementById('qualDept').value = item.dept;
            document.getElementById('qualStrength').value = item.strength;
            document.getElementById('qualImprove').value = item.improve;
        };

        function openQualitativeModal() { 
            document.getElementById('qualitativeForm').reset(); 
            document.getElementById('qualEditId').value = ''; 
            const dSelect = document.getElementById('qualDept'); 
            dSelect.innerHTML = '<option value="">اختر القسم...</option>'; 
            // جلب الأقسام من "الأقسام الأكاديمية" بدلاً من الأقسام العادية
            filterByContext(DB.academic_departments||[]).forEach(d => dSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`); 
            document.getElementById('addQualitativeModal').style.display='flex'; 
        }
        
        function saveQualitative() { 
            const id = document.getElementById('qualEditId').value;
            const dept = document.getElementById('qualDept').value; 
            const date = document.getElementById('qualDate').value || new Date().toISOString().slice(0,10); 
            const s = document.getElementById('qualStrength').value; 
            const i = document.getElementById('qualImprove').value; 
            if(!dept || !date) return alert('البيانات ناقصة'); 
            
            if(id) {
                const item = DB.qualitative_reports.find(x => x.id.toString() === id.toString());
                if(item) { item.dept = dept; item.date = date; item.strength = s; item.improve = i; }
            } else {
                DB.qualitative_reports.push({ id: Date.now(), dept, date, strength: s, improve: i, brandId: CURRENT_BRAND.id }); 
            }
            saveDB(); renderQualitativeTable(); closeModal('addQualitativeModal'); 
        }

        window.deleteQualitative = function(id) { if(confirm('حذف؟')) { DB.qualitative_reports = DB.qualitative_reports.filter(x => x.id !== id); saveDB(); renderQualitativeTable(); } }

        // ========================================================
        // REPORT GENERATION LOGIC (A4 STYLE FOR PRINTING & WORD)
        // ========================================================
        
        // --- ZOOM LOGIC ---
        window.reportZoom = 1;
        window.zoomReport = function(step) {
            window.reportZoom += step;
            if(window.reportZoom < 0.5) window.reportZoom = 0.5;
            if(window.reportZoom > 2.0) window.reportZoom = 2.0;
            document.getElementById('zoomLevelDisplay').innerText = Math.round(window.reportZoom * 100) + '%';
            document.getElementById('a4-report-content').style.transform = `scale(${window.reportZoom})`;
        };

        window.setReportTab = function(tab, el) { 
            document.querySelectorAll('#quality-report .custom-tab').forEach(t => t.classList.remove('active')); 
            el.classList.add('active'); 
            if(tab === 'create') { document.getElementById('report-create-pane').style.display='block'; document.getElementById('report-saved-pane').style.display='none'; } 
            else { document.getElementById('report-create-pane').style.display='none'; document.getElementById('report-saved-pane').style.display='block'; renderSavedReports(); } 
        };

        function getMonthName(m) {
            const months = {"01":"يناير", "02":"فبراير", "03":"مارس", "04":"أبريل", "05":"مايو", "06":"يونيو", "07":"يوليو", "08":"أغسطس", "09":"سبتمبر", "10":"أكتوبر", "11":"نوفمبر", "12":"ديسمبر"};
            return months[m] || m;
        }

        window.generateQualityReport = async function() {
            try {
                const m = document.getElementById('reportMonthSelect').value;
                const y = DB.settings.schoolYear || '2025 / 2026م';
                const mName = MONTH_NAMES_AR[parseInt(m) - 1];
                const content = document.getElementById('a4-report-content');
                
                const seniorVisits = filterByContext(DB.visits_senior).filter(v => v && v.date && String(v.date).split('-')[1] === m);
                const middleVisits = filterByContext(DB.visits_middle).filter(v => v && v.date && String(v.date).split('-')[1] === m);
                const allVisits = [...seniorVisits, ...middleVisits];

                const ministryLogo = DB.settings.ministryLogo || ''; 
                const schoolLogo = DB.settings.schoolLogo || '';
                const footerText = DB.settings.footer_text || document.getElementById('footer_text')?.value || '';
                const footerAlign = DB.settings.footer_align || 'center';
                const footerFontSize = DB.settings.footer_fontsize || '12';

                const sigDirId = DB.settings.sig_director;
                const sigAsstId = DB.settings.sig_assistant;
                const dirName = sigDirId ? (DB.senior.find(u => u.name === sigDirId)?.name || sigDirId) : '';
                const asstName = sigAsstId ? (DB.senior.find(u => u.name === sigAsstId)?.name || sigAsstId) : '';

                const formatNameWithA = (name) => {
                    if (!name) return '';
                    let n = name.trim();
                    if (!n.startsWith('أ.') && !n.startsWith('أ .') && !n.startsWith('أ/')) {
                        return 'أ. ' + n;
                    }
                    return n;
                };

                // --- HTML structure built specifically to play nicely with MS Word ---
                let html = ``;
                
                // تطابق مع التنسيق المطلوب في الصورة
                const tStyle = `border-collapse: collapse; width: 100%; text-align: center; font-family: 'Times New Roman', serif; font-size: 14pt; font-weight: bold; direction: rtl;`;
                const tdStyle = `border: 1px solid #000; padding: 4px 8px; vertical-align: middle; height: 35px;`;
                const thStyle = `border: 1px solid #000; padding: 6px 8px; vertical-align: middle; font-weight: bold; background-color: #bfbfbf; height: 35px;`;
                const thBlack = `border: 1px solid #000; padding: 6px 8px; vertical-align: middle; font-weight: bold; background-color: #000; color: #fff; height: 35px;`;

                const getFooter = () => `<div class="report-screen-footer" style="position: absolute; bottom: 15mm; left: 15mm; right: 15mm; text-align: ${footerAlign}; font-size: ${footerFontSize}pt; font-weight: bold; color: #555; border-top: 1px solid #ccc; padding-top: 10px; direction: rtl;">${footerText}</div>`;
                const pageBreak = `<br clear="all" style="mso-special-character:line-break;page-break-before:always">`;

                // --- PAGE 1: COVER ---
                html += `
                <div class="a4-page" style="direction: rtl; font-family: 'Cairo', sans-serif; display:flex; flex-direction:column; justify-content:space-between; min-height: 297mm;">
                    <table width="100%" border="0" cellspacing="0" cellpadding="0" style="border: none !important;">
                        <tr>
                            <td align="right" width="33%" style="border: none !important; vertical-align: top;">${schoolLogo ? `<img src="${schoolLogo}" width="150" height="100">` : ''}</td>
                            <td align="center" width="34%" style="border: none !important; vertical-align: top;">${ministryLogo ? `<img src="${ministryLogo}" width="200" height="100">` : ''}</td>
                            <td align="left" width="33%" style="border: none !important; vertical-align: top;"></td>
                        </tr>
                    </table>
                    <br><br><br>
                    <div style="background-color: #f2f2f2; border-radius: 20px; padding: 40px 20px; border: 1px solid #ddd; margin: 40px auto; width: 85%; text-align: center;">
                        <h1 style="font-size: 26pt; font-weight: bold; margin-bottom: 20px; color: #000;">تقرير متابعة جودة التعليم للقيادة العليا والوسطى</h1>
                        <h2 style="font-size: 20pt; color: #2c5aa0; margin-bottom: 20px;">${DB.settings.schoolName || 'المدرسة'}</h2>
                        <h3 style="font-size: 18pt; color: red; text-decoration: underline; margin-bottom: 15px;">شهر ${mName}</h3>
                        <h4 style="font-size: 16pt; margin-bottom: 10px; color: #000;">العام الدراسي ${y}</h4>
                    </div>
                    <br><br><br><br>
                    <table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top: 50px; border: none !important;">
                        <tr>
                            <td align="center" width="50%" style="border: none !important;">
                                <div style="font-weight: bold; font-size: 16pt; margin-bottom: 20px;">يعتمد، مدير/ة المدرسة<br>${dirName}</div>
                                ${DB.settings.schoolStamp ? `<img src="${DB.settings.schoolStamp}" width="150" height="150">` : ''}
                            </td>
                            <td align="center" width="50%" style="border: none !important;">
                                <div style="font-weight: bold; font-size: 16pt; margin-bottom: 20px;">إعداد المدير/ة المساعد/ة<br>${asstName}</div>
                            </td>
                        </tr>
                    </table>
                    ${getFooter()}
                </div>
                ${pageBreak}`;

                // --- PAGE 2: Middle Leadership Follow-up ---
                const acadDepts = filterByContext(DB.academic_departments);
                let middleRows = '';
                
                if (acadDepts.length > 0) {
                    acadDepts.forEach(dept => {
                        const visitsCount = middleVisits.filter(v => v.dept === dept.name).length;
                        const hasVisits = visitsCount > 0 ? 'يوجد' : 'لا يوجد';
                        middleRows += `
                        <tr>
                            <td style="${tdStyle} font-weight: bold; text-align: right;">${dept.name}</td>
                            <td style="${tdStyle}">${visitsCount}</td>
                            <td style="${tdStyle}" contenteditable="true">${hasVisits}</td>
                            <td style="${tdStyle}" contenteditable="true">${hasVisits}</td>
                            <td contenteditable="true" style="${tdStyle} background-color: #fff; min-width: 150px;"></td>
                        </tr>`;
                    });
                } else {
                    const uniqueDepts = [...new Set(middleVisits.map(v => v.dept))];
                    uniqueDepts.forEach(dept => {
                        const visitsCount = middleVisits.filter(v => v.dept === dept).length;
                        const hasVisits = visitsCount > 0 ? 'يوجد' : 'لا يوجد';
                        middleRows += `
                        <tr>
                            <td style="${tdStyle} font-weight: bold; text-align: right;">${dept}</td>
                            <td style="${tdStyle}">${visitsCount}</td>
                            <td style="${tdStyle}" contenteditable="true">${hasVisits}</td>
                            <td style="${tdStyle}" contenteditable="true">${hasVisits}</td>
                            <td contenteditable="true" style="${tdStyle} background-color: #fff; min-width: 150px;"></td>
                        </tr>`;
                    });
                }

                html += `
                <div class="a4-page" style="direction: rtl; font-family: 'Cairo', sans-serif;">
                    <h3 style="text-decoration: underline; font-size: 16pt; margin-bottom: 20px; font-weight: bold;">أولاً: متابعة تسليم القيادة الوسطى (الزيارات / محاضر الاجتماعات / الخطة الأسبوعية) للمواد الدراسية إلى المدير/ة المساعد/ة في المدرسة</h3>
                    <br>
                    <table border="1" cellpadding="8" cellspacing="0" style="${tStyle}">
                        <thead>
                            <tr>
                                <th rowspan="2" style="${thStyle} width: 25%;">القسم</th>
                                <th colspan="4" style="${thStyle} width: 75%;">متابعة القيادة العليا للقيادة الوسطى</th>
                            </tr>
                            <tr>
                                <th style="${thStyle} width: 15%;">عدد استمارات الزيارات الصفية المنفذة خلال الشهر</th>
                                <th style="${thStyle} width: 15%;">يوجد محضر اجتماع للمعلم الأول أو المنسق</th>
                                <th style="${thStyle} width: 15%;">توجد خطه أسبوعية للمعلم الأول أو المنسق</th>
                                <th style="${thStyle} width: 30%;">أسباب عدم التسليم</th>
                            </tr>
                        </thead>
                        <tbody>${middleRows || `<tr><td colspan="5" style="${tdStyle}">لا توجد بيانات</td></tr>`}</tbody>
                    </table>
                    <div style="font-size: 14pt; font-weight: bold; margin: 25px 0; text-align: right; line-height: 1.6;">
                        ملاحظات عامة: يتم التنسيق مع القيادة الوسطى لتنفيذ الزيارات الصفية بحسب ما يتناسب مع ظروف الجداول والنصاب المسند لهم.
                    </div>
                    <div style="margin-top: 50px; font-weight: bold; font-size: 16pt; text-align: right;">
                        <div style="text-decoration: underline; margin-bottom: 15px;">ثانياً: عدد الزيارات التي نُفذت خلال شهر ${mName} من قبل:</div>
                        <div style="margin-bottom:10px;">1- القيادة العليا = ${seniorVisits.length} زيارة</div>
                        <div>2- القيادة الوسطى = ${middleVisits.length} زيارة</div>
                    </div>
                    ${getFooter()}
                </div>
                ${pageBreak}`;

                // --- PAGE 3+: Visit Details (Dynamic) ---
                
                // Grouping all visits dynamically by visitor name to assure EVERYONE appears
                const visitsByVisitor = {};
                allVisits.forEach(v => {
                    const vName = v.visitor || 'غير محدد';
                    if(!visitsByVisitor[vName]) visitsByVisitor[vName] = [];
                    visitsByVisitor[vName].push(v);
                });

                let tableContent = '';
                let visitorCount = 0;

                Object.keys(visitsByVisitor).forEach(visitorName => {
                    const visits = visitsByVisitor[visitorName];
                    let displayJob = visits[0].visitorJob || '-';
                    
                    const uMatch = (DB.senior || []).concat(DB.middle || []).find(u => u.name === visitorName);
                    if(uMatch && uMatch.job) { displayJob = uMatch.job; }

                    const formattedVisitorName = formatNameWithA(visitorName);

                    visits.forEach((v, idx) => {
                        const formattedTeacher = formatNameWithA(v.teacher);
                        tableContent += `<tr>
                            <td style="${tdStyle} width: 5%;">${idx + 1}</td>
                            <td style="${tdStyle} width: 25%; text-align: right;">${formattedTeacher}</td>
                            <td style="${tdStyle} width: 15%;">${v.dept}</td>
                            <td style="${tdStyle} width: 15%;">${v.date}</td>
                            <td style="${tdStyle} width: 20%;">${v.eval || 'غير محدد'}</td>`;
                        
                        if(idx === 0) {
                            tableContent += `<td rowspan="${visits.length}" style="${tdStyle} width: 20%; background-color: #fff; font-weight: bold;">${formattedVisitorName}<br><span style="font-weight: normal; font-size: 11pt;">${displayJob}</span></td>`;
                        }
                        tableContent += `</tr>`;
                    });

                    tableContent += `<tr><td colspan="6" style="${thStyle}">مجموع الزيارات = ${visits.length} زيارات</td></tr>`;
                    visitorCount++;
                });

                tableContent += `<tr><td colspan="6" style="border: 2px solid black; padding: 12px; background-color: #b4c6e7; font-weight: bold; text-align: center;">مجموع الزيارات الكلية = ${allVisits.length} زيارة</td></tr>`;

                html += `
                <div class="a4-page" style="direction: rtl; font-family: 'Cairo', sans-serif;">
                    <h3 style="text-decoration: underline; font-size: 16pt; margin-bottom: 20px; font-weight: bold;">ثالثاً: بيان أسماء المعلمين المُزارين من قبل القيادة العليا والوسطى خلال شهر ${mName}</h3>
                    <br>
                    ${visitorCount > 0 ? `
                    <table border="1" cellpadding="8" cellspacing="0" style="${tStyle}">
                        <thead>
                            <tr>
                                <th style="${thBlack} width: 5%;">ت</th>
                                <th style="${thBlack} width: 25%;">اسم المعلم</th>
                                <th style="${thBlack} width: 15%;">القسم</th>
                                <th style="${thBlack} width: 15%;">تاريخ الزيارة</th>
                                <th style="${thBlack} width: 20%;">تقييم الزيارة</th>
                                <th style="${thBlack} width: 20%;">اسم الزائر</th>
                            </tr>
                        </thead>
                        <tbody>${tableContent}</tbody>
                    </table>` : `<div style="text-align:center; padding:20px; font-size:14pt;">لا توجد زيارات مسجلة.</div>`}
                    ${getFooter()}
                </div>
                ${pageBreak}`;

                // --- PAGE 6: Statistics & Chart ---
                const departments = [...new Set(allVisits.map(v => v.dept))];
                const colHeaders = ['يتجاوز التوقعات بكثير', 'يتجاوز التوقعات', 'يفي بالتوقعات', 'يفي بالتوقعات جزئيا'];
                let finalStatsRows = '';
                
                const chartDataToRender = {};
                departments.forEach((dept, i) => {
                    const vs = allVisits.filter(v => v.dept === dept);
                    chartDataToRender[dept] = { total: vs.length, exceedsALot: 0, exceeds: 0, meets: 0, partially: 0 };
                    
                    let cells = '';
                    colHeaders.forEach((h, hIdx) => {
                         const c = vs.filter(v => String(v.eval || '') === h || (h === 'يتجاوز التوقعات بكثير' && String(v.eval || '') === 'ممتاز')).length;
                         cells += `<td style="${tdStyle}">${c || ''}</td>`;
                         if(hIdx === 0) chartDataToRender[dept].exceedsALot = c;
                         if(hIdx === 1) chartDataToRender[dept].exceeds = c;
                         if(hIdx === 2) chartDataToRender[dept].meets = c;
                         if(hIdx === 3) chartDataToRender[dept].partially = c;
                    });
                    finalStatsRows += `<tr><td style="${tdStyle}">${i+1}</td><td style="${tdStyle} text-align: right; font-weight: bold;">قسم ${dept}</td><td style="${tdStyle} font-weight: bold;">${vs.length}</td>${cells}</tr>`;
                });
                
                const chartDatasets = [
                    { label: 'عدد الزيارات', data: departments.map(d => chartDataToRender[d].total), backgroundColor: '#92d050' },
                    { label: 'يتجاوز التوقعات بكثير', data: departments.map(d => chartDataToRender[d].exceedsALot), backgroundColor: '#2f75b5' },
                    { label: 'يتجاوز التوقعات', data: departments.map(d => chartDataToRender[d].exceeds), backgroundColor: '#c00000' },
                    { label: 'يفي بالتوقعات', data: departments.map(d => chartDataToRender[d].meets), backgroundColor: '#7030a0' },
                    { label: 'يفي بالتوقعات جزئيا', data: departments.map(d => chartDataToRender[d].partially), backgroundColor: '#ffff00' }
                ];

                let chartImg = "";
                try {
                    chartImg = await generateReportChart(departments.length ? departments : ['لا توجد بيانات'], chartDatasets);
                } catch(e) { console.error("Chart rendering error", e); }

                html += `
                <div class="a4-page" style="direction: rtl; font-family: 'Cairo', sans-serif;">
                    <h3 style="text-decoration: underline; font-size: 16pt; margin-bottom: 20px; font-weight: bold;">رابعاً: عدد الزيارات الصفية وتقييم الأداء الصفي</h3>
                    <br>
                    <table border="1" cellpadding="8" cellspacing="0" style="${tStyle}">
                        <thead>
                            <tr>
                                <th rowspan="2" style="${thStyle}">#</th>
                                <th rowspan="2" style="${thStyle}">الأقسام الأكاديمية</th>
                                <th rowspan="2" style="${thStyle}">مجموع عدد الزيارات</th>
                                <th colspan="4" style="${thStyle}">مستويات الأداء</th>
                            </tr>
                            <tr>
                                <th style="${thStyle} background-color: #3cba9f; color: #fff;">يتجاوز التوقعات بكثير</th>
                                <th style="${thStyle} background-color: #dcae1d; color: #fff;">يتجاوز التوقعات</th>
                                <th style="${thStyle} background-color: #8e5ea2; color: #fff;">يفي بالتوقعات</th>
                                <th style="${thStyle} background-color: #3e95cd; color: #fff;">يفي بالتوقعات جزئيا</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${finalStatsRows || `<tr><td colspan="7" style="${tdStyle}">لا توجد بيانات</td></tr>`}
                            <tr>
                                <td colspan="2" style="${thStyle} background-color: #b4c6e7;">المجموع الكلي للزيارات الصفية</td>
                                <td style="${thStyle} background-color: #b4c6e7;">${allVisits.length}</td>
                                <td style="${thStyle} background-color: #b4c6e7;">${allVisits.filter(v=>String(v.eval||'').includes('بكثير')||String(v.eval||'')==='ممتاز').length}</td>
                                <td style="${thStyle} background-color: #b4c6e7;">${allVisits.filter(v=>String(v.eval||'')==='يتجاوز التوقعات').length}</td>
                                <td style="${thStyle} background-color: #b4c6e7;">${allVisits.filter(v=>String(v.eval||'')==='يفي بالتوقعات').length}</td>
                                <td style="${thStyle} background-color: #b4c6e7;">${allVisits.filter(v=>String(v.eval||'').includes('جزئيا')).length}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="text-align: center; margin-top: 30px;">
                        <img src="${chartImg}" style="max-width: 90%; height: auto; border: 1px solid #ddd; padding: 10px;">
                    </div>
                    ${getFooter()}
                </div>
                ${pageBreak}`;

                // --- PAGE 7: Distinguished & Care ---
                const distinguishedItems = filterByContext(DB.distinguished).filter(x => x && x.date && String(x.date).split('-')[1] === m);
                let distRows = '';
                distinguishedItems.forEach((d, i) => { distRows += `<tr><td style="${tdStyle}">${i+1}</td><td style="${tdStyle} text-align: right;">${formatNameWithA(d.teacher)}</td><td style="${tdStyle}">${d.eval || 'غير محدد'}</td><td style="${tdStyle} text-align: right;">${d.reason}</td><td style="${tdStyle}">${d.dept}</td></tr>`; });

                const careItems = filterByContext(DB.care_needed).filter(x => x && x.date && String(x.date).split('-')[1] === m);
                let careRows = '';
                careItems.forEach((d, i) => { careRows += `<tr><td style="${tdStyle}">${i+1}</td><td style="${tdStyle} text-align: right;">${formatNameWithA(d.teacher)}</td><td style="${tdStyle}">${d.eval || 'غير محدد'}</td><td style="${tdStyle} text-align: right;">${d.reason}</td><td style="${tdStyle}">${d.dept}</td></tr>`; });

                html += `
                <div class="a4-page" style="direction: rtl; font-family: 'Cairo', sans-serif;">
                    <h3 style="text-decoration: underline; font-size: 16pt; margin-bottom: 20px; font-weight: bold;">سادساً: حصر أسماء المعلمين المتميزين في الأقسام الأكاديمية</h3>
                    <br>
                    <table border="1" cellpadding="8" cellspacing="0" style="${tStyle}">
                        <thead><tr><th style="${thStyle} width: 5%;">الرقم</th><th style="${thStyle} width: 25%;">اسم المعلم</th><th style="${thStyle} width: 15%;">التقدير</th><th style="${thStyle} width: 35%;">المبررات</th><th style="${thStyle} width: 20%;">القسم الأكاديمي</th></tr></thead>
                        <tbody>${distRows || `<tr><td colspan="5" style="${tdStyle}">لا توجد بيانات</td></tr>`}</tbody>
                    </table>
                    <br><br>
                    <h3 style="text-decoration: underline; font-size: 16pt; margin-bottom: 20px; font-weight: bold;">حصر أسماء المعلمين الأولى بالرعاية في الأقسام الأكاديمية</h3>
                    <br>
                    <table border="1" cellpadding="8" cellspacing="0" style="${tStyle}">
                        <thead><tr><th style="${thStyle} width: 5%;">الرقم</th><th style="${thStyle} width: 25%;">اسم المعلم</th><th style="${thStyle} width: 15%;">التقدير</th><th style="${thStyle} width: 35%;">المبررات</th><th style="${thStyle} width: 20%;">القسم الأكاديمي</th></tr></thead>
                        <tbody>${careRows || `<tr><td colspan="5" style="${tdStyle}">لا توجد بيانات</td></tr>`}</tbody>
                    </table>
                    ${getFooter()}
                </div>
                ${pageBreak}`;

                // --- PAGE 9: Qualitative Report ---
                const qualitativeItems = filterByContext(DB.qualitative_reports).filter(x => x && x.date && String(x.date).split('-')[1] === m);
                let qualRows = '';
                qualitativeItems.forEach(q => {
                     qualRows += `
                     <tr>
                        <td style="${tdStyle} font-weight: bold; width: 20%;">${q.dept}</td>
                        <td style="${tdStyle} text-align: right; white-space: pre-wrap; width: 40%;"><ul>${String(q.strength||'').split('\n').map(l=>`<li>${l}</li>`).join('')}</ul></td>
                        <td style="${tdStyle} text-align: right; white-space: pre-wrap; width: 40%;"><ul>${String(q.improve||'').split('\n').map(l=>`<li>${l}</li>`).join('')}</ul></td>
                     </tr>`;
                });

                html += `
                <div class="a4-page" style="direction: rtl; font-family: 'Cairo', sans-serif;">
                    <h3 style="text-decoration: underline; font-size: 16pt; margin-bottom: 20px; font-weight: bold;">سابعاً: التقرير النوعي</h3>
                    <h4 style="text-decoration: underline; text-align: center; font-size: 14pt; margin-bottom: 20px; font-weight: bold;">جوانب القوة والتطوير لأداء المعلمين خلال الزيارات الصفية في الأقسام الأكاديمية</h4>
                    <br>
                    <table border="1" cellpadding="8" cellspacing="0" style="${tStyle}">
                        <thead><tr><th style="${thStyle}">الأقسام الأكاديمية</th><th style="${thStyle}">جوانب القوة</th><th style="${thStyle}">جوانب بحاجة إلى تطوير</th></tr></thead>
                        <tbody>${qualRows || `<tr><td colspan="3" style="${tdStyle}">لا توجد بيانات</td></tr>`}</tbody>
                    </table>
                    ${getFooter()}
                </div>`;

                content.innerHTML = html;
                
            } catch(error) {
                console.error("Report generation error: ", error);
                alert("حدث خطأ أثناء إصدار التقرير. يرجى التأكد من اكتمال البيانات والتواريخ بشكل صحيح.");
            }
        };

        function generateReportChart(labels, datasets) {
            return new Promise((resolve) => {
                const canvas = document.getElementById('tempChartCanvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if(window.tempChart) window.tempChart.destroy();
                window.tempChart = new Chart(ctx, { 
                    type: 'bar', 
                    data: { labels: labels, datasets: datasets }, 
                    options: { 
                        responsive: false, 
                        animation: false, 
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, 
                        plugins: { legend: { position: 'right' } } 
                    } 
                });
                setTimeout(() => resolve(canvas.toDataURL('image/png')), 200);
            });
        }

        // Export to MS Word Fix with proper A4 Page properties injected
        function wrapForWord(htmlContent) {
            const footerText = DB.settings.footer_text || '';
            const footerAlign = DB.settings.footer_align || 'center';
            const footerFontSize = DB.settings.footer_fontsize || '12';

            return `
                <html xmlns:v="urn:schemas-microsoft-com:vml"
                      xmlns:o="urn:schemas-microsoft-com:office:office"
                      xmlns:w="urn:schemas-microsoft-com:office:word"
                      xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="utf-8">
                    <title>Quality Report</title>
                    <style>
                        @page WordSection1 {
                            size: 595.3pt 841.9pt; /* A4 size */
                            margin: 36.0pt 36.0pt 36.0pt 36.0pt; /* Margins */
                            mso-header-margin: 35.4pt;
                            mso-footer-margin: 35.4pt;
                            mso-paper-source: 0;
                            mso-footer: f1;
                        }
                        div.WordSection1 { page: WordSection1; }
                        body { font-family: 'Cairo', 'Arial', sans-serif; direction: rtl; }
                        table { border-collapse: collapse; width: 100%; }
                        td, th { border: 1px solid black; padding: 8px; text-align: center; }
                        img { display: block; max-width: 100%; } 
                        .report-screen-footer { display: none !important; }
                    </style>
                </head>
                <body dir="rtl">
                    <div class="WordSection1">
                        ${htmlContent}
                    </div>
                    <div style="mso-element:footer" id="f1">
                        <p style="text-align: ${footerAlign}; font-size: ${footerFontSize}pt; font-weight: bold; color: #555; border-top: 1px solid #ccc; padding-top: 10px; direction: rtl; margin:0;">${footerText}</p>
                    </div>
                </body>
                </html>
            `;
        }

        window.exportToWord = function() {
            const htmlContent = document.getElementById('a4-report-content').innerHTML;
            if(!htmlContent.includes('تقرير متابعة جودة')) return alert('يرجى معاينة التقرير أولاً قبل التحميل');
            const fullHtml = wrapForWord(htmlContent);
            const blob = new Blob(['\ufeff' + fullHtml], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Quality_Report.doc';
            link.click();
        }

        window.saveReport = function() { 
            const m = document.getElementById('reportMonthSelect').value; 
            const htmlContent = document.getElementById('a4-report-content').innerHTML;
            if(!htmlContent.includes('تقرير متابعة جودة')) return alert('يرجى معاينة التقرير أولاً قبل الحفظ');
            DB.saved_reports.push({id: Date.now(), month: m, date: new Date().toLocaleDateString('en-GB'), html: htmlContent, brandId: CURRENT_BRAND.id}); 
            saveDB(); 
            alert('تم الحفظ في الأرشيف بنجاح'); 
        }

        function renderSavedReports() { 
            const list = document.getElementById('savedReportsList'); 
            list.innerHTML = ''; 
            filterByContext(DB.saved_reports).forEach(r => { 
                list.innerHTML += `
                <div class="saved-report-card">
                    <div class="saved-report-thumb"><i class="fas fa-file-word"></i></div>
                    <div class="saved-report-details">
                        <h4 style="margin:0 0 5px 0; color:var(--primary);">تقرير جودة التعليم - شهر ${r.month}</h4>
                        <small style="color:#777; font-weight:bold;">تاريخ الحفظ: ${r.date}</small>
                    </div>
                    <div class="saved-report-actions">
                        <button class="action-btn btn-view" onclick="viewSavedReport(${r.id})"><i class="fas fa-eye"></i> معاينة</button>
                        <button class="action-btn btn-edit" onclick="editSavedReport(${r.id})"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="action-btn btn-toggle" onclick="downloadSavedReportItem(${r.id})"><i class="fas fa-download"></i> تنزيل</button>
                        <button class="action-btn btn-perm" onclick="printSavedReportItem(${r.id})"><i class="fas fa-print"></i> طباعة</button>
                        <button class="action-btn btn-delete" onclick="deleteSavedReport(${r.id})"><i class="fas fa-trash"></i> حذف</button>
                    </div>
                </div>`; 
            }); 
        }
        
        window.viewSavedReport = function(id) {
            const r = DB.saved_reports.find(x => x.id === id);
            if(r) { document.getElementById('a4-report-content').innerHTML = r.html; setReportTab('create', document.querySelector('#quality-report .custom-tab:first-child')); }
        }
        window.editSavedReport = function(id) {
            const r = DB.saved_reports.find(x => x.id === id);
            if(r) { document.getElementById('reportMonthSelect').value = r.month; setReportTab('create', document.querySelector('#quality-report .custom-tab:first-child')); generateQualityReport(); }
        }
        window.downloadSavedReportItem = function(id) {
            const r = DB.saved_reports.find(x => x.id === id);
            if(r) { const blob = new Blob(['\ufeff' + wrapForWord(r.html)], { type: 'application/msword' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Quality_Report_${r.month}.doc`; link.click(); }
        }
        window.printSavedReportItem = function(id) {
            const r = DB.saved_reports.find(x => x.id === id);
            if(r) { const printWin = window.open('', '', 'width=800,height=900'); printWin.document.write('<html dir="rtl"><head><title>Print</title><style>body{font-family:"Cairo",sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact;} @page { size: A4 portrait; margin: 5mm; } .a4-page{page-break-after:always; width: 100%; box-sizing: border-box; padding: 15mm; padding-bottom: 35mm; position: relative;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #000; padding:8px; text-align:center;}</style></head><body>' + r.html + '</body></html>'); printWin.document.close(); printWin.focus(); setTimeout(() => { printWin.print(); printWin.close(); }, 500); }
        }
        window.deleteSavedReport = function(id) {
            if(confirm('هل أنت متأكد من حذف التقرير المحفوظ؟')) { DB.saved_reports = DB.saved_reports.filter(x => x.id !== id); saveDB(); renderSavedReports(); }
        }

        // ========================================================
        
        window.setSettingTab = function(tabId, element) {
            const tabs = document.querySelectorAll('#settings .custom-tab');
            tabs.forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            const panes = document.querySelectorAll('#settings .setting-content-pane');
            panes.forEach(p => p.classList.remove('active'));
            const targetPane = document.getElementById(tabId);
            if(targetPane) { targetPane.classList.add('active'); }
        };
        
        function loadSettings() { 
            const savedName = DB.settings.schoolName;
            const brandName = CURRENT_BRAND ? CURRENT_BRAND.name : '';
            document.getElementById('confSchool').value = savedName || brandName;
            document.getElementById('confYear').value = DB.settings.schoolYear || ''; 
            if(DB.settings.ministryLogo) { document.getElementById('preview_ministry').src = DB.settings.ministryLogo; document.getElementById('preview_wrap_ministry').style.display = 'inline-block'; }
            if(DB.settings.schoolLogo) { document.getElementById('preview_school').src = DB.settings.schoolLogo; document.getElementById('preview_wrap_school').style.display = 'inline-block'; }
            if(DB.settings.schoolStamp) { document.getElementById('preview_stamp').src = DB.settings.schoolStamp; document.getElementById('preview_wrap_stamp').style.display = 'inline-block'; }
            if(DB.settings.footer_align) document.getElementById('footer_align').value = DB.settings.footer_align;
            if(DB.settings.footer_fontsize) document.getElementById('footer_fontsize').value = DB.settings.footer_fontsize;
            if(DB.settings.footer_text) document.getElementById('footer_text').value = DB.settings.footer_text;
            renderSignatureOptions();
            
            // Evaluation Criteria Table
            const evalBody = document.getElementById('evalTableBody'); evalBody.innerHTML = ''; 
            (DB.settings.evaluation_criteria||[]).forEach((c,i) => {
                const isActive = c.status !== 'inactive';
                const statusBadge = isActive ? '<span class="status-badge status-active">نشط</span>' : '<span class="status-badge status-inactive">معطل</span>';
                evalBody.innerHTML += `<tr>
                    <td><input type="checkbox" class="crit-cb custom-checkbox" value="${i}"></td>
                    <td>${i+1}</td>
                    <td style="font-weight:bold;">${c.name}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="display:flex; justify-content:center; gap:4px;">
                            <button class="action-btn btn-move" onclick="moveEval(${i}, -1)" title="أعلى"><i class="fas fa-arrow-up"></i></button>
                            <button class="action-btn btn-move" onclick="moveEval(${i}, 1)" title="أسفل"><i class="fas fa-arrow-down"></i></button>
                            <button class="action-btn btn-edit" onclick="editEval(${i})" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleEval(${i})" title="${isActive?'تعطيل':'تفعيل'}"><i class="fas fa-power-off"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteEval(${i})" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
            
            // Grades Table
            const gradeBody = document.getElementById('gradeTableBody'); gradeBody.innerHTML = ''; 
            (DB.settings.evaluation_grades||[]).forEach((g,i) => {
                const isActive = g.status !== 'inactive';
                const statusBadge = isActive ? '<span class="status-badge status-active">نشط</span>' : '<span class="status-badge status-inactive">معطل</span>';
                gradeBody.innerHTML += `<tr>
                    <td><input type="checkbox" class="grade-cb custom-checkbox" value="${i}"></td>
                    <td>${i+1}</td>
                    <td style="font-weight:bold; color:var(--primary);">${g.name}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="display:flex; justify-content:center; gap:4px;">
                            <button class="action-btn btn-move" onclick="moveGrade(${i}, -1)" title="أعلى"><i class="fas fa-arrow-up"></i></button>
                            <button class="action-btn btn-move" onclick="moveGrade(${i}, 1)" title="أسفل"><i class="fas fa-arrow-down"></i></button>
                            <button class="action-btn btn-edit" onclick="editGrade(${i})" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="action-btn btn-toggle ${isActive?'':'off'}" onclick="toggleGrade(${i})" title="${isActive?'تعطيل':'تفعيل'}"><i class="fas fa-power-off"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteGrade(${i})" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
            
            renderVisitorSettings();
            loadSystemLogs();
        }

        function renderSignatureOptions() {
            const seniors = filterByContext(DB.senior||[]);
            const dirSelect = document.getElementById('sig_director');
            const asstSelect = document.getElementById('sig_assistant');
            const currentDir = dirSelect.value || DB.settings.sig_director || "";
            const currentAsst = asstSelect.value || DB.settings.sig_assistant || "";
            dirSelect.innerHTML = '<option value="">اختر مدير المدرسة</option>';
            asstSelect.innerHTML = '<option value="">اختر المدير المساعد</option>';
            seniors.forEach(s => {
                if (s.name !== currentAsst) dirSelect.innerHTML += `<option value="${s.name}" ${s.name === currentDir ? 'selected' : ''}>${s.name}</option>`;
                if (s.name !== currentDir) asstSelect.innerHTML += `<option value="${s.name}" ${s.name === currentAsst ? 'selected' : ''}>${s.name}</option>`;
            });
        }

        function saveGeneralSettings() { DB.settings.schoolName = document.getElementById('confSchool').value; DB.settings.schoolYear = document.getElementById('confYear').value; saveDB(); alert('تم حفظ الإعدادات'); }
        function triggerFileSelect(id) { document.getElementById(id).click(); }
        function handleFileUpload(input, previewId, settingKey) { if(input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const res = e.target.result; document.getElementById(previewId).src = res; document.getElementById(previewId.replace('preview_', 'preview_wrap_')).style.display = 'inline-block'; DB.settings[settingKey] = res; saveDB(); }; reader.readAsDataURL(input.files[0]); } }
        function removeImage(previewId, settingKey, inputId) { document.getElementById(previewId).src = ''; document.getElementById(previewId.replace('preview_', 'preview_wrap_')).style.display = 'none'; document.getElementById(inputId).value = ''; DB.settings[settingKey] = ''; saveDB(); }
        function openImageModal(src) { document.getElementById('fullImage').src = src; document.getElementById('imageViewModal').style.display = 'flex'; }
        function saveSignatureSettings() { DB.settings.sig_director = document.getElementById('sig_director').value; DB.settings.sig_assistant = document.getElementById('sig_assistant').value; saveDB(); alert('تم حفظ التوقيعات'); }
        function clearSignature(id) { document.getElementById(id).value = ''; renderSignatureOptions(); saveSignatureSettings(); }
        function saveFooterSettings() { DB.settings.footer_align = document.getElementById('footer_align').value; DB.settings.footer_fontsize = document.getElementById('footer_fontsize').value; DB.settings.footer_text = document.getElementById('footer_text').value; saveDB(); alert('تم حفظ إعدادات التذييل'); }
        
        // Eval Criteria Methods
        function openAddEvalModal() { document.getElementById('editEvalId').value = ''; document.getElementById('addEvalForm').reset(); document.getElementById('addEvalModal').style.display='flex'; }
        window.editEval = function(idx) { const item = DB.settings.evaluation_criteria[idx]; document.getElementById('editEvalId').value = idx; document.getElementById('evalName').value = item.name; document.getElementById('addEvalModal').style.display='flex'; }
        function saveEvalForm() { const n = document.getElementById('evalName').value; const id = document.getElementById('editEvalId').value; if(n){ if(!DB.settings.evaluation_criteria) DB.settings.evaluation_criteria=[]; if(id !== '') DB.settings.evaluation_criteria[id].name = n; else DB.settings.evaluation_criteria.push({name:n, status:'active'}); saveDB(); loadSettings(); closeModal('addEvalModal'); } }
        window.toggleEval = function(idx) { const item = DB.settings.evaluation_criteria[idx]; item.status = (item.status === 'inactive') ? 'active' : 'inactive'; saveDB(); loadSettings(); }
        window.moveEval = function(idx, dir) { const arr = DB.settings.evaluation_criteria; if (dir === -1 && idx > 0) [arr[idx], arr[idx-1]] = [arr[idx-1], arr[idx]]; if (dir === 1 && idx < arr.length - 1) [arr[idx], arr[idx+1]] = [arr[idx+1], arr[idx]]; saveDB(); loadSettings(); }
        window.deleteEval = function(idx) { if(confirm('حذف؟')) { DB.settings.evaluation_criteria.splice(idx, 1); saveDB(); loadSettings(); } }

        // Grade Methods
        function openAddGradeModal() { document.getElementById('editGradeId').value = ''; document.getElementById('addGradeForm').reset(); document.getElementById('addGradeModal').style.display='flex'; }
        window.editGrade = function(idx) { const item = DB.settings.evaluation_grades[idx]; document.getElementById('editGradeId').value = idx; document.getElementById('gradeName').value = item.name; document.getElementById('addGradeModal').style.display='flex'; }
        function saveGradeForm() { const n = document.getElementById('gradeName').value; const id = document.getElementById('editGradeId').value; if(n){ if(!DB.settings.evaluation_grades) DB.settings.evaluation_grades=[]; if(id !== '') DB.settings.evaluation_grades[id].name = n; else DB.settings.evaluation_grades.push({name:n, status:'active'}); saveDB(); loadSettings(); closeModal('addGradeModal'); } }
        window.toggleGrade = function(idx) { const item = DB.settings.evaluation_grades[idx]; item.status = (item.status === 'inactive') ? 'active' : 'inactive'; saveDB(); loadSettings(); }
        window.moveGrade = function(idx, dir) { const arr = DB.settings.evaluation_grades; if (dir === -1 && idx > 0) [arr[idx], arr[idx-1]] = [arr[idx-1], arr[idx]]; if (dir === 1 && idx < arr.length - 1) [arr[idx], arr[idx+1]] = [arr[idx+1], arr[idx]]; saveDB(); loadSettings(); }
        window.deleteGrade = function(idx) { if(confirm('حذف؟')) { DB.settings.evaluation_grades.splice(idx, 1); saveDB(); loadSettings(); } }
        
        function deleteSelectedSettings(type) { if(!confirm('هل أنت متأكد من الحذف؟')) return; const cls = (type === 'criteria') ? '.crit-cb' : '.grade-cb'; const boxes = document.querySelectorAll(cls + ':checked'); const indices = Array.from(boxes).map(b => parseInt(b.value)).sort((a,b) => b-a); if(type === 'criteria') indices.forEach(i => DB.settings.evaluation_criteria.splice(i, 1)); else indices.forEach(i => DB.settings.evaluation_grades.splice(i, 1)); saveDB(); loadSettings(); }
        function toggleSelectAllSettings(type, master) { const cls = (type === 'criteria') ? '.crit-cb' : '.grade-cb'; document.querySelectorAll(cls).forEach(cb => cb.checked = master.checked); }

        function renderVisitorSettings() {
            const sList = document.getElementById('list_visitor_senior'); sList.innerHTML = '';
            const mList = document.getElementById('list_visitor_middle'); mList.innerHTML = '';
            
            (DB.settings.visitor_order_senior || []).forEach((name, i) => { 
                let u = (DB.senior || []).find(x => x.name === name);
                let jobTitle = u ? (u.job || 'القيادة العليا') : 'القيادة العليا';
                sList.innerHTML += `<li class="visitor-list-item"><span class="visitor-name"><i class="fas fa-user-circle" style="color:var(--primary); margin-left:8px;"></i> ${i+1}. ${name} - <small style="color:#777; font-weight:normal;">${jobTitle}</small></span><div class="visitor-controls" style="display:flex; gap:4px;"><button class="action-btn btn-move" onclick="moveVisitorSetting('senior', ${i}, -1)"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveVisitorSetting('senior', ${i}, 1)"><i class="fas fa-arrow-down"></i></button><button class="action-btn btn-delete" onclick="removeVisitorFromSetting('senior', ${i})"><i class="fas fa-trash"></i></button></div></li>`; 
            });
            
            (DB.settings.visitor_order_middle || []).forEach((name, i) => { 
                let u = (DB.middle || []).find(x => x.name === name);
                let jobTitle = u ? (u.job || 'القيادة الوسطى') : 'القيادة الوسطى';
                mList.innerHTML += `<li class="visitor-list-item"><span class="visitor-name"><i class="fas fa-user-circle" style="color:var(--primary); margin-left:8px;"></i> ${i+1}. ${name} - <small style="color:#777; font-weight:normal;">${jobTitle}</small></span><div class="visitor-controls" style="display:flex; gap:4px;"><button class="action-btn btn-move" onclick="moveVisitorSetting('middle', ${i}, -1)"><i class="fas fa-arrow-up"></i></button><button class="action-btn btn-move" onclick="moveVisitorSetting('middle', ${i}, 1)"><i class="fas fa-arrow-down"></i></button><button class="action-btn btn-delete" onclick="removeVisitorFromSetting('middle', ${i})"><i class="fas fa-trash"></i></button></div></li>`; 
            });
        }

        function openVisitorPicker(type) { CURRENT_PICKER_TYPE = type; document.getElementById('visitorSearch').value = ''; filterPickerList(); document.getElementById('visitorPickerModal').style.display = 'flex'; }
        function filterPickerList() {
            const term = document.getElementById('visitorSearch').value.toLowerCase();
            const div = document.getElementById('pickerList'); div.innerHTML = '';
            let candidates = [], currentSelected = [];
            if (CURRENT_PICKER_TYPE === 'senior') { candidates = filterByContext(DB.senior || []); currentSelected = (DB.settings.visitor_order_senior || []); }
            else { candidates = filterByContext(DB.middle || []); currentSelected = (DB.settings.visitor_order_middle || []); }
            candidates.forEach(u => { 
                if(u.name.toLowerCase().includes(term) && !currentSelected.includes(u.name)) {
                    div.innerHTML += `<div class="picker-item" onclick="addVisitorFromPicker('${u.name}')" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;"><span>${u.name} - <span style="color:#777;">${u.job||'غير محدد'}</span></span></div>`;
                }
            });
        }
        function addVisitorFromPicker(name) {
            if(CURRENT_PICKER_TYPE === 'senior') { if(!DB.settings.visitor_order_senior) DB.settings.visitor_order_senior = []; DB.settings.visitor_order_senior.push(name); }
            else { if(!DB.settings.visitor_order_middle) DB.settings.visitor_order_middle = []; DB.settings.visitor_order_middle.push(name); }
            saveDB(); renderVisitorSettings(); closeModal('visitorPickerModal');
        }
        window.removeVisitorFromSetting = function(type, index) { if(type === 'senior') DB.settings.visitor_order_senior.splice(index, 1); else DB.settings.visitor_order_middle.splice(index, 1); saveDB(); renderVisitorSettings(); }
        window.moveVisitorSetting = function(type, idx, dir) { const arr = DB.settings[`visitor_order_${type}`]; if (dir === -1 && idx > 0) [arr[idx], arr[idx-1]] = [arr[idx-1], arr[idx]]; if (dir === 1 && idx < arr.length - 1) [arr[idx], arr[idx+1]] = [arr[idx+1], arr[idx]]; saveDB(); renderVisitorSettings(); }
        function saveVisitorOrder() { saveDB(); alert('تم حفظ الترتيب'); }
        
        window.printReport = function() { window.print(); }

        function loadSystemLogs() { const b = document.getElementById('logTableBody'); b.innerHTML = ''; (DB.logs||[]).forEach(l => b.innerHTML += `<tr><td>${l.date}</td><td style="font-weight:bold;">${l.user}</td><td><span class="status-badge status-active" style="background:#eef4ff; color:var(--primary);">${l.action}</span></td><td>${l.details} [${l.brand}]</td></tr>`); }
        function clearSystemLogs() { if(confirm('مسح السجل؟')) { DB.logs = []; saveDB(); loadSystemLogs(); } }
        window.onload = function() { initSystem(); };
    </script>
</body>
</html>
