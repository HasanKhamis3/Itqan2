<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام ارتقاء | Irteqaa</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&family=Tajawal:wght@400;500;700;800&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { 
            --primary: #1e4078; 
            --primary-dark: #163260;
            --accent: #dcae1d;
            --text: #333; 
            --bg: #f4f7fa; 
            --danger: #da291c; 
            --success: #28a745; 
            --warning: #ffc107; 
            --disabled: #e9ecef; 
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e0e0e0; position: fixed; right: 0; top: 0; height: 100%; z-index: 100; transition: 0.3s; box-shadow: -2px 0 15px rgba(0,0,0,0.03); }
        .sidebar-header { padding: 30px 20px; border-bottom: 1px solid #f0f4f8; display: flex; gap: 15px; align-items: center; justify-content: center; }
        .logo-group { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; line-height: 1; }
        .logo-ar { font-size: 2rem; font-weight: 800; color: var(--primary); font-family: 'Tajawal', sans-serif; letter-spacing: -0.5px; }
        .logo-en { font-size: 0.8rem; font-weight: 500; color: #888; font-family: 'Poppins', sans-serif; letter-spacing: 2px; margin-top: 4px; text-transform: uppercase; }
        .sidebar-icon { font-size: 2.4rem; color: var(--primary); }

        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li { margin-bottom: 5px; display: block; } 
        #nav-system-admin { display: none; }
        .nav-links a { display: flex; align-items: center; padding: 12px 25px; color: #666; text-decoration: none; transition: 0.3s; font-weight: 600; border-right: 4px solid transparent; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); background: #f0f7ff; border-right-color: var(--primary); }
        .nav-links a i { margin-left: 12px; width: 25px; text-align: center; font-size: 1.1rem; }

        .main-content { margin-right: 260px; flex: 1; padding: 30px; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .user-profile { display: flex; align-items: center; gap: 15px; background: white; padding: 8px 20px; border-radius: 50px; box-shadow: var(--shadow); border: 1px solid #eee; }
        .user-info-text { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .user-job { font-size: 0.8rem; color: #777; font-weight: normal;}

        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #1e4078 0%, #0d1b33 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: rgba(255, 255, 255, 0.98); padding: 50px 45px; border-radius: 24px; width: 440px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }

        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .section-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; display: none; box-shadow: var(--shadow); }
        .section-card.active { display: block; }

        .dashboard-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.04); border: 1px solid #f0f0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; transition: transform 0.2s; }
        .stat-info h3 { font-size: 2rem; margin: 10px 0 5px 0; font-weight: 700; color: #333; }
        
        .custom-tabs { display: flex; gap: 15px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .custom-tab { padding: 10px 20px; cursor: pointer; color: #777; font-weight: bold; border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
        .custom-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .custom-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .custom-table th { background: #2c5aa0; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .custom-table td { padding: 8px; border-bottom: 1px solid #eee; background: white; text-align: center; vertical-align: middle; }
        
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem; margin: 2px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-view { background: #ffc107; color: #333; }
        .btn-edit { background: #17a2b8; }
        .btn-delete { background: #dc3545; }
        .btn-move { background: #6c757d; padding: 6px 8px; }

        .filter-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; flex-wrap: wrap; }
        .filter-label { font-weight: bold; color: #555; }
        .date-range-inputs { display: none; align-items: center; gap: 10px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; width: 600px; border-radius: 8px; overflow: hidden; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--primary); }
        .modal-body { padding: 20px; flex: 1; }
        .modal-footer { padding: 15px 20px; background: #f9f9f9; display: flex; gap: 10px; justify-content: flex-end; }
        
        .brand-dropdown { position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; min-width: 220px; z-index: 1000; display: none; margin-top: 5px; }
        .brand-dropdown.show { display: block; }

        @media print {
            .sidebar, .top-header, .filter-container, .btn, .custom-tabs { display: none !important; }
            .main-content { margin: 0 !important; padding: 0 !important; }
        }
    </style>
</head>
<body>

    <div id="loginPage" class="login-wrapper">
        <div class="login-box">
            <h2 style="color:var(--primary)">ارتقاء</h2>
            <form id="loginForm" onsubmit="login(event)">
                <input type="text" id="loginUser" class="form-control" placeholder="اسم المستخدم" required>
                <input type="password" id="loginPass" class="form-control" placeholder="كلمة المرور" required>
                <button type="submit" class="btn btn-primary">تسجيل الدخول</button>
                <div id="loginError" style="color:red; margin-top:10px; display:none"></div>
            </form>
        </div>
    </div>

    <div id="app" class="app-container" style="display:none;">
        <aside class="sidebar">
            <div class="sidebar-header"><i class="fas fa-graduation-cap sidebar-icon"></i><div class="logo-group"><span class="logo-ar">ارتقاء</span><span class="logo-en">Irteqaa</span></div></div>
            <ul class="nav-links">
                <li id="nav-dashboard"><a onclick="navigate('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                <li id="nav-visits"><a onclick="navigate('visits')" data-page="visits"><i class="fas fa-clipboard-check"></i> الزيارات الصفية</a></li>
                <li id="nav-user-management"><a onclick="navigate('user-management')" data-page="user-management"><i class="fas fa-users-cog"></i> إدارة المستخدمين</a></li>
                <li id="nav-settings"><a onclick="navigate('settings')" data-page="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
                <li id="nav-system-admin"><a onclick="navigate('system-admin')" data-page="system-admin"><i class="fas fa-shield-alt"></i> مدير النظام</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div style="display:flex; align-items:center;">
                    <h2 id="pageTitle">لوحة التحكم</h2>
                    <div style="margin-right:20px; position:relative;">
                        <button class="btn" style="background:#eee" onclick="document.getElementById('brandDropdown').classList.toggle('show')">
                            <span id="currentBrandLabel">الفرع الرئيسي</span> <i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="brandDropdown" class="brand-dropdown"></div>
                    </div>
                </div>
                <div class="user-profile">
                    <div class="user-info-text"><span id="headerUserName" class="user-name"></span><span id="headerUserJob" class="user-job"></span></div>
                    <button class="btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div id="dashboard" class="section-card active">
                <div class="filter-container">
                    <label class="filter-label">تصفية حسب الفترة:</label>
                    <select id="dashMonthFilter" class="form-control" style="width:auto; margin-bottom:0" onchange="toggleDateRange('dashboard')"></select>
                    <div id="dashDateRange" class="date-range-inputs">
                        <input type="date" id="dashStart" class="form-control" style="width:auto; margin-bottom:0">
                        <input type="date" id="dashEnd" class="form-control" style="width:auto; margin-bottom:0">
                        <button class="btn btn-primary" style="width:auto" onclick="renderDashboard()">تطبيق</button>
                    </div>
                </div>
                <div class="dashboard-stats-grid">
                    <div class="stat-card"><h3>إجمالي الزيارات</h3><h3 id="stat_total">0</h3></div>
                    <div class="stat-card"><h3>المتميزين</h3><h3 id="stat_dist">0</h3></div>
                </div>
                <div style="height:300px;"><canvas id="dashBarChart"></canvas></div>
            </div>

            <div id="visits" class="section-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h3>سجل الزيارات الصفية</h3>
                    <button class="btn btn-primary" style="width:auto" onclick="openAddVisitModal()"><i class="fas fa-plus"></i> إضافة زيارة</button>
                </div>
                <div class="filter-container">
                    <label class="filter-label">عرض الفترة:</label>
                    <select id="visitMonthFilter" class="form-control" style="width:auto; margin-bottom:0" onchange="toggleDateRange('visits')"></select>
                    <div id="visitDateRange" class="date-range-inputs">
                        <input type="date" id="visitStart" class="form-control" style="width:auto; margin-bottom:0">
                        <input type="date" id="visitEnd" class="form-control" style="width:auto; margin-bottom:0">
                        <button class="btn btn-primary" style="width:auto" onclick="renderVisitsTable()">تطبيق</button>
                    </div>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setVisitTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setVisitTab('middle', this)">القيادة الوسطى</div>
                </div>
                <table class="custom-table">
                    <thead><tr><th>التاريخ</th><th>القسم</th><th>المعلمة</th><th>التقييم</th><th>الزائر</th><th>الإجراءات</th></tr></thead>
                    <tbody id="visitsTableBody"></tbody>
                </table>
            </div>

            <div id="user-management" class="section-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h3>إدارة المستخدمين</h3>
                    <button class="btn btn-primary" style="width:auto" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة جديد</button>
                </div>
                <div class="custom-tabs">
                    <div class="custom-tab active" onclick="setTab('senior', this)">القيادة العليا</div>
                    <div class="custom-tab" onclick="setTab('middle', this)">القيادة الوسطى</div>
                    <div class="custom-tab" onclick="setTab('teachers', this)">المعلمات</div>
                    <div class="custom-tab" onclick="setTab('departments', this)">الأقسام</div>
                </div>
                <table class="custom-table">
                    <thead><tr id="tableHeadRow"></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>

            <div id="settings" class="section-card"><h3>الإعدادات المركزية</h3><p>تعديل الشعارات والمعايير...</p></div>
            <div id="system-admin" class="section-card"><h3>إدارة البراندات</h3><p>إدارة الوصول والفروع...</p></div>
        </main>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span id="userModalTitle">إضافة مستخدم</span><span onclick="closeModal('addUserModal')" style="cursor:pointer">&times;</span></div>
            <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" id="editUserId">
                    <label>الاسم الكامل</label><input type="text" id="addName" class="form-control" required>
                    <div id="userFields">
                        <label>الوظيفة</label><input type="text" id="addJob" class="form-control">
                        <label>رقم الهاتف</label><input type="text" id="addPhone" class="form-control">
                        <label>اسم الدخول</label><input type="text" id="addLogin" class="form-control">
                        <label>كلمة المرور</label><input type="password" id="addPass" class="form-control">
                        <label>القسم (للمعلمات)</label><select id="addDept" class="form-control"></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveUserForm()">حفظ البيانات</button></div>
        </div>
    </div>

    <div id="addVisitModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">إضافة زيارة صفية <span onclick="closeModal('addVisitModal')" style="cursor:pointer">&times;</span></div>
            <div class="modal-body">
                <input type="hidden" id="visitEditId">
                <label>التاريخ</label><input type="date" id="visitDate" class="form-control">
                <label>القسم</label><select id="visitDept" class="form-control" onchange="onVisitDeptChange()"></select>
                <label>المعلمة</label><select id="visitTeacher" class="form-control"></select>
                <label>التقييم</label><select id="visitEval" class="form-control"></select>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveVisit()">حفظ</button></div>
        </div>
    </div>

    <script>
        // --- Core Data Logic ---
        const DB_KEY = 'Irteqaa_Central_DB_V2026';
        let DB = { 
            senior: [], middle: [], teachers: [], departments: [], 
            visits_senior: [], visits_middle: [], 
            settings: { evaluation_criteria: [{name: 'ممتاز', status:'active'}, {name: 'جيد جداً', status:'active'}] },
            brands: [{id: 1, name: 'الفرع الرئيسي', status: 'active'}]
        };

        let CURRENT_USER = null;
        let CURRENT_BRAND = {id: 1, name: 'الفرع الرئيسي'};
        let CURRENT_TAB = 'senior';
        let CURRENT_VISIT_TAB = 'senior';
        let dashChart = null;

        const MONTHS_AR = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];

        function initSystem() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) DB = JSON.parse(saved);
            
            // Check session
            const session = localStorage.getItem('Irteqaa_Session');
            if(session) {
                // Mock user for testing if no users exist
                CURRENT_USER = {id: 999, name: 'مدير النظام', job: 'إدارة', permissions: {}};
                showApp();
            } else {
                document.getElementById('loginPage').style.display = 'flex';
            }
        }

        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(DB)); }

        // --- Navigation ---
        function navigate(pageId) {
            document.querySelectorAll('.section-card').forEach(s => s.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('pageTitle').innerText = document.querySelector(`a[data-page="${pageId}"]`).innerText;
            
            if(pageId === 'dashboard') { populateMonthFilters('dashMonthFilter', 'visits_senior'); renderDashboard(); }
            if(pageId === 'visits') { populateMonthFilters('visitMonthFilter', 'visits_senior'); renderVisitsTable(); }
            if(pageId === 'user-management') renderTable();
        }

        // --- Filtering Logic ---
        function populateMonthFilters(selectId, collectionKey) {
            const select = document.getElementById(selectId);
            const data = DB.visits_senior.concat(DB.visits_middle).filter(v => v.brandId === CURRENT_BRAND.id);
            
            // Get unique months from data
            const monthsFound = [...new Set(data.map(v => {
                const d = new Date(v.date);
                return `${d.getMonth()}-${d.getFullYear()}`;
            }))];

            const current = new Date();
            const currentVal = `${current.getMonth()}-${current.getFullYear()}`;

            let html = `<option value="current">الشهر الحالي (${MONTHS_AR[current.getMonth()]} ${current.getFullYear()})</option>`;
            
            monthsFound.sort().forEach(m => {
                const [mon, year] = m.split('-');
                if(m !== currentVal) {
                    html += `<option value="${m}">${MONTHS_AR[mon]} ${year}</option>`;
                }
            });

            html += `<option value="custom">نطاق تاريخ محدد...</option>`;
            select.innerHTML = html;
        }

        function toggleDateRange(section) {
            const val = document.getElementById(section === 'dashboard' ? 'dashMonthFilter' : 'visitMonthFilter').value;
            const rangeDiv = document.getElementById(section === 'dashboard' ? 'dashDateRange' : 'visitDateRange');
            rangeDiv.style.display = (val === 'custom') ? 'flex' : 'none';
            if(val !== 'custom') {
                if(section === 'dashboard') renderDashboard(); else renderVisitsTable();
            }
        }

        function getFilteredData(collection) {
            const filterVal = document.getElementById(collection.includes('visit') ? 'visitMonthFilter' : 'dashMonthFilter').value;
            let data = DB[collection].filter(v => v.brandId === CURRENT_BRAND.id);

            if(filterVal === 'current') {
                const now = new Date();
                data = data.filter(v => {
                    const d = new Date(v.date);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            } else if(filterVal === 'custom') {
                const start = new Date(document.getElementById(collection.includes('visit') ? 'visitStart' : 'dashStart').value);
                const end = new Date(document.getElementById(collection.includes('visit') ? 'visitEnd' : 'dashEnd').value);
                if(!isNaN(start) && !isNaN(end)) {
                    data = data.filter(v => {
                        const d = new Date(v.date);
                        return d >= start && d <= end;
                    });
                }
            } else {
                const [mon, year] = filterVal.split('-');
                data = data.filter(v => {
                    const d = new Date(v.date);
                    return d.getMonth() == mon && d.getFullYear() == year;
                });
            }
            return data;
        }

        // --- Dashboard ---
        function renderDashboard() {
            const senior = getFilteredData('visits_senior');
            const middle = getFilteredData('visits_middle');
            const all = senior.concat(middle);
            
            document.getElementById('stat_total').innerText = all.length;
            document.getElementById('stat_dist').innerText = all.filter(v => v.eval === 'ممتاز').length;
            
            // Basic Chart
            const ctx = document.getElementById('dashBarChart').getContext('2d');
            if(dashChart) dashChart.destroy();
            dashChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['القيادة العليا', 'القيادة الوسطى'],
                    datasets: [{ label: 'عدد الزيارات', data: [senior.length, middle.length], backgroundColor: '#1e4078' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- User Management (Fixed Update Logic) ---
        function setTab(tab, el) {
            CURRENT_TAB = tab;
            document.querySelectorAll('#user-management .custom-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('usersTableBody');
            const head = document.getElementById('tableHeadRow');
            tbody.innerHTML = '';
            
            const list = DB[CURRENT_TAB].filter(u => u.brandId === CURRENT_BRAND.id);

            if(CURRENT_TAB === 'departments') {
                head.innerHTML = '<th>الترتيب</th><th>الاسم</th><th>الإجراءات</th>';
                list.forEach((u, i) => {
                    tbody.innerHTML += `<tr><td>${i+1}</td><td>${u.name}</td><td>
                        <button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                    </td></tr>`;
                });
            } else {
                head.innerHTML = '<th>الترتيب</th><th>الاسم</th><th>الوظيفة</th><th>الإجراءات</th>';
                list.forEach((u, i) => {
                    tbody.innerHTML += `<tr><td>${i+1}</td><td>${u.name}</td><td>${u.job || '-'}</td><td>
                        <button class="action-btn btn-edit" onclick="editUser(${u.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                    </td></tr>`;
                });
            }
        }

        function openAddUserModal() {
            document.getElementById('addUserForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('userModalTitle').innerText = "إضافة جديد";
            
            const deptSelect = document.getElementById('addDept');
            deptSelect.innerHTML = '<option value="">اختر القسم...</option>';
            DB.departments.filter(d => d.brandId === CURRENT_BRAND.id).forEach(d => {
                deptSelect.innerHTML += `<option value="${d.name}">${d.name}</option>`;
            });
            
            document.getElementById('addUserModal').style.display = 'flex';
        }

        // Fix: Load all saved data into form
        function editUser(id) {
            const u = DB[CURRENT_TAB].find(x => x.id == id);
            if(!u) return;

            openAddUserModal();
            document.getElementById('editUserId').value = u.id;
            document.getElementById('addName').value = u.name; // جلب الاسم المحفوظ
            document.getElementById('userModalTitle').innerText = "تعديل بيانات: " + u.name;
            
            if(CURRENT_TAB !== 'departments') {
                document.getElementById('addJob').value = u.job || '';
                document.getElementById('addPhone').value = u.phone || '';
                document.getElementById('addLogin').value = u.login || '';
                document.getElementById('addPass').value = u.pass || '';
                document.getElementById('addDept').value = u.dept || '';
            }
        }

        // Fix: Unified Save/Update logic
        function saveUserForm() {
            const id = document.getElementById('editUserId').value;
            const name = document.getElementById('addName').value.trim();
            if(!name) return alert("الاسم مطلوب");

            if(id) {
                // Update Existing
                const u = DB[CURRENT_TAB].find(x => x.id == id);
                if(u) {
                    u.name = name;
                    u.job = document.getElementById('addJob').value;
                    u.phone = document.getElementById('addPhone').value;
                    u.login = document.getElementById('addLogin').value;
                    u.pass = document.getElementById('addPass').value;
                    u.dept = document.getElementById('addDept').value;
                }
            } else {
                // Insert New
                const newUser = {
                    id: Date.now(),
                    brandId: CURRENT_BRAND.id,
                    name: name,
                    job: document.getElementById('addJob').value,
                    phone: document.getElementById('addPhone').value,
                    login: document.getElementById('addLogin').value,
                    pass: document.getElementById('addPass').value,
                    dept: document.getElementById('addDept').value,
                    status: 'active'
                };
                DB[CURRENT_TAB].push(newUser);
            }

            saveDB();
            renderTable();
            closeModal('addUserModal');
        }

        // --- Visits ---
        function setVisitTab(tab, el) {
            CURRENT_VISIT_TAB = tab;
            document.querySelectorAll('#visits .custom-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderVisitsTable();
        }

        function renderVisitsTable() {
            const tbody = document.getElementById('visitsTableBody');
            tbody.innerHTML = '';
            const list = getFilteredData(CURRENT_VISIT_TAB === 'senior' ? 'visits_senior' : 'visits_middle');
            
            list.forEach(v => {
                tbody.innerHTML += `<tr>
                    <td>${v.date}</td>
                    <td>${v.dept}</td>
                    <td>${v.teacher}</td>
                    <td>${v.eval}</td>
                    <td>${v.visitor}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="alert('تفاصيل الزيارة...')"><i class="fas fa-eye"></i></button>
                        <button class="action-btn btn-move" onclick="moveVisit(${v.id}, 'up')"><i class="fas fa-arrow-up"></i></button>
                        <button class="action-btn btn-move" onclick="moveVisit(${v.id}, 'down')"><i class="fas fa-arrow-down"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteVisit(${v.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function openAddVisitModal() {
            document.getElementById('visitDate').valueAsDate = new Date();
            const dSel = document.getElementById('visitDept');
            dSel.innerHTML = '<option value="">اختر القسم...</option>';
            DB.departments.filter(d => d.brandId === CURRENT_BRAND.id).forEach(d => {
                dSel.innerHTML += `<option value="${d.name}">${d.name}</option>`;
            });

            const eSel = document.getElementById('visitEval');
            eSel.innerHTML = '';
            DB.settings.evaluation_criteria.forEach(c => {
                eSel.innerHTML += `<option value="${c.name}">${c.name}</option>`;
            });

            document.getElementById('addVisitModal').style.display = 'flex';
        }

        function onVisitDeptChange() {
            const dept = document.getElementById('visitDept').value;
            const tSel = document.getElementById('visitTeacher');
            tSel.innerHTML = '';
            DB.teachers.filter(t => t.dept === dept && t.brandId === CURRENT_BRAND.id).forEach(t => {
                tSel.innerHTML += `<option value="${t.name}">${t.name}</option>`;
            });
        }

        function saveVisit() {
            const newV = {
                id: Date.now(),
                brandId: CURRENT_BRAND.id,
                date: document.getElementById('visitDate').value,
                dept: document.getElementById('visitDept').value,
                teacher: document.getElementById('visitTeacher').value,
                eval: document.getElementById('visitEval').value,
                visitor: CURRENT_USER.name
            };
            const key = CURRENT_VISIT_TAB === 'senior' ? 'visits_senior' : 'visits_middle';
            DB[key].push(newV);
            saveDB();
            renderVisitsTable();
            closeModal('addVisitModal');
        }

        // --- Helpers ---
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function login(e) { e.preventDefault(); localStorage.setItem('Irteqaa_Session', 'active'); location.reload(); }
        function logout() { localStorage.removeItem('Irteqaa_Session'); location.reload(); }
        function showApp() { 
            document.getElementById('loginPage').style.display = 'none'; 
            document.getElementById('app').style.display = 'flex'; 
            document.getElementById('headerUserName').innerText = CURRENT_USER.name;
            document.getElementById('headerUserJob').innerText = CURRENT_USER.job;
            navigate('dashboard');
        }

        window.onload = initSystem;
    </script>
</body>
</html>
